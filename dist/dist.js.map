{"version":3,"sources":["webpack://ComponentRelay/webpack/universalModuleDefinition","webpack://ComponentRelay/webpack/bootstrap","webpack://ComponentRelay/webpack/runtime/define property getters","webpack://ComponentRelay/webpack/runtime/hasOwnProperty shorthand","webpack://ComponentRelay/./lib/snjsTypes.ts","webpack://ComponentRelay/./node_modules/uuid/dist/esm-browser/rng.js","webpack://ComponentRelay/./node_modules/uuid/dist/esm-browser/regex.js","webpack://ComponentRelay/./node_modules/uuid/dist/esm-browser/validate.js","webpack://ComponentRelay/./node_modules/uuid/dist/esm-browser/stringify.js","webpack://ComponentRelay/./node_modules/uuid/dist/esm-browser/v4.js","webpack://ComponentRelay/./lib/utils.ts","webpack://ComponentRelay/./lib/logger.ts","webpack://ComponentRelay/./lib/componentRelay.ts"],"names":["root","factory","exports","module","define","amd","self","__webpack_require__","definition","key","o","Object","defineProperty","enumerable","get","obj","prop","prototype","hasOwnProperty","call","ComponentAction","Environment","ContentType","AppDataField","getRandomValues","rnds8","Uint8Array","rng","crypto","bind","msCrypto","Error","uuid","byteToHex","i","push","toString","substr","options","buf","offset","rnds","random","arr","arguments","length","undefined","toLowerCase","TypeError","environmentToString","environment","map","Web","Desktop","Mobile","isNotUndefinedOrNull","value","noop","Logger","window","console","isSupported","this","enabled","log","error","MessagePayloadApi","KeyboardModifier","ComponentRelay","constructor","params","activeThemes","acceptsThemes","targetWindow","contentWindow","processParameters","registerMessageHandler","registerKeyboardEventListeners","registerMouseEventListeners","initialPermissions","onReady","onThemesChange","coallesedSaving","coallesedSavingDelay","component","onReadyCallback","onThemesChangeCallback","debug","deinit","messageQueue","sentMessages","lastStreamedItem","pendingSaveItems","pendingSaveTimeout","pendingSaveParams","messageHandler","document","removeEventListener","keyDownEventListener","keyUpEventListener","clickEventListener","event","data","referrer","URL","origin","parsedData","str","result","JSON","parse","type","e","isValidJsonString","action","ComponentRegistered","handleMessage","addEventListener","ctrlKey","keyDownEvent","Ctrl","shiftKey","Shift","metaKey","Meta","keyUpEvent","_event","mouseClickEvent","payload","sessionKey","componentData","ActivateThemes","activateThemes","themes","original","originalMessage","filter","message","messageId","extensionName","title","alertMessage","replace","callback","platform","requestPermissions","postMessage","activeThemeUrls","ThemesActivated","getSelfComponentUUID","isRunningInDesktopApplication","isRunningInMobileApplication","getComponentDataValueForKey","setComponentDataValueForKey","SetComponentData","clearComponentData","api","Component","generateUUID","sentMessage","stringify","postMessagePayload","parent","permissions","RequestPermissions","incomingUrls","sort","themesToActivate","themesToDeactivate","activeUrl","includes","candidate","themeUrl","deactivateTheme","link","createElement","id","btoa","href","rel","media","className","getElementsByTagName","appendChild","themeElementForUrl","Array","from","getElementsByClassName","slice","find","element","parentNode","setAttribute","removeChild","uuidv4","streamItems","contentTypes","StreamItems","content_types","items","streamContextItem","StreamContextItem","item","clearTimeout","_performSavingOfItems","selectItem","SelectItem","jsonObjectForItem","clearSelection","ClearSelection","content_type","Tag","createItem","CreateItem","associateItem","createItems","mapped","CreateItems","AssociateItem","deassociateItem","DeassociateItem","deleteItem","deleteItems","DeleteItems","sendCustomEvent","saveItem","skipDebouncer","saveItems","saveItemWithPresave","presave","saveItemsWithPresave","mappedItems","SaveItems","incomingIds","preexistingItems","concat","setTimeout","setSize","width","height","SetSize","keyboardModifier","KeyDown","KeyUp","Click","copy","assign","children","getItemAppDataValue","content","appData"],"mappings":"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","file":"dist.js","sourcesContent":["(function webpackUniversalModuleDefinition(root, factory) {\n\tif(typeof exports === 'object' && typeof module === 'object')\n\t\tmodule.exports = factory();\n\telse if(typeof define === 'function' && define.amd)\n\t\tdefine(\"ComponentRelay\", [], factory);\n\telse if(typeof exports === 'object')\n\t\texports[\"ComponentRelay\"] = factory();\n\telse\n\t\troot[\"ComponentRelay\"] = factory();\n})(self, function() {\nreturn ","// The require scope\nvar __webpack_require__ = {};\n\n","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","/**\n * Declaring types needed from snjs.\n * This file will be deleted after snjs becomes a monorepo and provides such types.\n */\n\n/**\n * The available actions that a component can perform.\n */\nexport enum ComponentAction {\n  SetSize = 'set-size',\n  StreamItems = 'stream-items',\n  StreamContextItem = 'stream-context-item',\n  SaveItems = 'save-items',\n  SelectItem = 'select-item',\n  AssociateItem = 'associate-item',\n  DeassociateItem = 'deassociate-item',\n  ClearSelection = 'clear-selection',\n  CreateItem = 'create-item',\n  CreateItems = 'create-items',\n  DeleteItems = 'delete-items',\n  SetComponentData = 'set-component-data',\n  InstallLocalComponent = 'install-local-component',\n  ToggleActivateComponent = 'toggle-activate-component',\n  RequestPermissions = 'request-permissions',\n  PresentConflictResolution = 'present-conflict-resolution',\n  DuplicateItem = 'duplicate-item',\n  ComponentRegistered = 'component-registered',\n  ActivateThemes = 'themes',\n  Reply = 'reply',\n  SaveSuccess = 'save-success',\n  SaveError = 'save-error',\n  ThemesActivated = 'themes-activated',\n  KeyDown = 'key-down',\n  KeyUp = 'key-up',\n  Click = 'click'\n}\n\nexport enum Environment {\n  Web = 1,\n  Desktop = 2,\n  Mobile = 3\n}\n\nexport enum ContentType {\n  Any = '*',\n  Item = 'SF|Item',\n  RootKey = 'SN|RootKey|NoSync',\n  ItemsKey = 'SN|ItemsKey',\n  EncryptedStorage = 'SN|EncryptedStorage',\n  Note = 'Note',\n  Tag = 'Tag',\n  SmartTag = 'SN|SmartTag',\n  Component = 'SN|Component',\n  Editor = 'SN|Editor',\n  ActionsExtension = 'Extension',\n  UserPrefs = 'SN|UserPreferences',\n  HistorySession = 'SN|HistorySession',\n  Theme = 'SN|Theme',\n  Mfa = 'SF|MFA',\n  ServerExtension = 'SF|Extension',\n  FilesafeCredentials = 'SN|FileSafe|Credentials',\n  FilesafeFileMetadata = 'SN|FileSafe|FileMetadata',\n  FilesafeIntegration = 'SN|FileSafe|Integration',\n  ExtensionRepo = 'SN|ExtensionRepo',\n}\n\nexport enum AppDataField {\n  Pinned = 'pinned',\n  Archived = 'archived',\n  Locked = 'locked',\n  UserModifiedDate = 'client_updated_at',\n  DefaultEditor = 'defaultEditor',\n  MobileRules = 'mobileRules',\n  NotAvailableOnMobile = 'notAvailableOnMobile',\n  MobileActive = 'mobileActive',\n  LastSize = 'lastSize',\n  PrefersPlainEditor = 'prefersPlainEditor',\n  ComponentInstallError = 'installError'\n}\n","// Unique ID creation requires a high quality random # generator. In the browser we therefore\n// require the crypto API and do not support built-in fallback to lower quality random number\n// generators (like Math.random()).\nvar getRandomValues;\nvar rnds8 = new Uint8Array(16);\nexport default function rng() {\n  // lazy load so that environments that need to polyfill have a chance to do so\n  if (!getRandomValues) {\n    // getRandomValues needs to be invoked in a context where \"this\" is a Crypto implementation. Also,\n    // find the complete implementation of crypto (msCrypto) on IE11.\n    getRandomValues = typeof crypto !== 'undefined' && crypto.getRandomValues && crypto.getRandomValues.bind(crypto) || typeof msCrypto !== 'undefined' && typeof msCrypto.getRandomValues === 'function' && msCrypto.getRandomValues.bind(msCrypto);\n\n    if (!getRandomValues) {\n      throw new Error('crypto.getRandomValues() not supported. See https://github.com/uuidjs/uuid#getrandomvalues-not-supported');\n    }\n  }\n\n  return getRandomValues(rnds8);\n}","export default /^(?:[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}|00000000-0000-0000-0000-000000000000)$/i;","import REGEX from './regex.js';\n\nfunction validate(uuid) {\n  return typeof uuid === 'string' && REGEX.test(uuid);\n}\n\nexport default validate;","import validate from './validate.js';\n/**\n * Convert array of 16 byte values to UUID string format of the form:\n * XXXXXXXX-XXXX-XXXX-XXXX-XXXXXXXXXXXX\n */\n\nvar byteToHex = [];\n\nfor (var i = 0; i < 256; ++i) {\n  byteToHex.push((i + 0x100).toString(16).substr(1));\n}\n\nfunction stringify(arr) {\n  var offset = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : 0;\n  // Note: Be careful editing this code!  It's been tuned for performance\n  // and works in ways you may not expect. See https://github.com/uuidjs/uuid/pull/434\n  var uuid = (byteToHex[arr[offset + 0]] + byteToHex[arr[offset + 1]] + byteToHex[arr[offset + 2]] + byteToHex[arr[offset + 3]] + '-' + byteToHex[arr[offset + 4]] + byteToHex[arr[offset + 5]] + '-' + byteToHex[arr[offset + 6]] + byteToHex[arr[offset + 7]] + '-' + byteToHex[arr[offset + 8]] + byteToHex[arr[offset + 9]] + '-' + byteToHex[arr[offset + 10]] + byteToHex[arr[offset + 11]] + byteToHex[arr[offset + 12]] + byteToHex[arr[offset + 13]] + byteToHex[arr[offset + 14]] + byteToHex[arr[offset + 15]]).toLowerCase(); // Consistency check for valid UUID.  If this throws, it's likely due to one\n  // of the following:\n  // - One or more input array values don't map to a hex octet (leading to\n  // \"undefined\" in the uuid)\n  // - Invalid input values for the RFC `version` or `variant` fields\n\n  if (!validate(uuid)) {\n    throw TypeError('Stringified UUID is invalid');\n  }\n\n  return uuid;\n}\n\nexport default stringify;","import rng from './rng.js';\nimport stringify from './stringify.js';\n\nfunction v4(options, buf, offset) {\n  options = options || {};\n  var rnds = options.random || (options.rng || rng)(); // Per 4.4, set bits for version and `clock_seq_hi_and_reserved`\n\n  rnds[6] = rnds[6] & 0x0f | 0x40;\n  rnds[8] = rnds[8] & 0x3f | 0x80; // Copy bytes to buffer, if provided\n\n  if (buf) {\n    offset = offset || 0;\n\n    for (var i = 0; i < 16; ++i) {\n      buf[offset + i] = rnds[i];\n    }\n\n    return buf;\n  }\n\n  return stringify(rnds);\n}\n\nexport default v4;","import { Environment } from './snjsTypes'\nimport { v4 as uuidv4 } from 'uuid'\n\ndeclare global {\n  interface Window { msCrypto: unknown; }\n}\n\nexport const generateUuid = () : string => {\n  return uuidv4()\n}\n\nexport const isValidJsonString = (str: unknown) : boolean => {\n  if (typeof str !== 'string') {\n    return false\n  }\n  try {\n    const result = JSON.parse(str)\n    const type = Object.prototype.toString.call(result)\n    return type === '[object Object]' || type === '[object Array]'\n  } catch (e) {\n    return false\n  }\n}\n\nexport const environmentToString = (environment: Environment) : string => {\n  const map = {\n    [Environment.Web]: 'web',\n    [Environment.Desktop]: 'desktop',\n    [Environment.Mobile]: 'mobile',\n  }\n  return map[environment] ?? map[Environment.Web]\n}\n\nexport const isNotUndefinedOrNull = (value: any) : boolean => {\n  return value !== null && value !== undefined\n}\n","const noop = () => undefined\n\nexport default class Logger {\n  static enabled = false;\n\n  private static get isSupported() {\n    return (window.console || console) ? true : false\n  }\n\n  static get info () : any {\n    if (!Logger.isSupported || !this.enabled) {\n      return noop\n    }\n    return console.log.bind(console)\n  }\n\n  static get error () : any {\n    if (!Logger.isSupported) {\n      return noop\n    }\n    return console.error.bind(console)\n  }\n}\n","import {\n  AppDataField,\n  ComponentAction,\n  ContentType,\n  Environment,\n} from './snjsTypes'\nimport type {\n  ComponentPermission,\n  ItemMessagePayload,\n  MessageData,\n  SNItem,\n  UuidString\n} from '@standardnotes/snjs'\nimport {\n  environmentToString,\n  generateUuid,\n  isValidJsonString,\n  isNotUndefinedOrNull\n} from './utils'\nimport Logger from './logger'\n\nconst DEFAULT_COALLESED_SAVING_DELAY = 250\n\nenum MessagePayloadApi {\n  Component = 'component',\n}\n\ntype Component = {\n  uuid?: string;\n  origin?: string;\n  data?: ComponentData;\n  sessionKey?: string;\n  environment?: string;\n  platform?: string;\n  isMobile?: boolean;\n  acceptsThemes: boolean;\n  activeThemes: string[];\n}\n\ntype ComponentData = {\n  [key: string]: any\n}\n\ntype MessagePayload = {\n  action: ComponentAction;\n  data: MessageData;\n  componentData?: ComponentData;\n  messageId?: UuidString;\n  sessionKey?: UuidString;\n  api: MessagePayloadApi;\n  original?: MessagePayload;\n  callback?: (...params: any) => void;\n}\n\ntype ComponentRelayOptions = {\n  coallesedSaving?: boolean,\n  coallesedSavingDelay?: number,\n  /**\n   * Outputs debugging information to console.\n   */\n  debug?: boolean,\n  /**\n   * Indicates whether or not the component accepts themes.\n   */\n  acceptsThemes?: boolean\n}\n\ntype ComponentRelayParams = {\n  /**\n   * Represents the window object that the component is running in.\n   */\n  targetWindow: Window\n  /**\n   * A collection of permissions that the component can request\n   * access once it's ready.\n   */\n  initialPermissions?: ComponentPermission[]\n  /**\n   * The options to initialize\n   */\n  options?: ComponentRelayOptions,\n  /**\n   * A callback that is executed after the component has been registered.\n   */\n  onReady?: () => void,\n  /**\n   * A callback that is executed after themes have been changed.\n   */\n  onThemesChange?: () => void,\n}\n\ntype ItemPayload = {\n  content_type?: ContentType,\n  content?: any,\n  [key: string]: any\n}\n\nenum KeyboardModifier {\n  Shift = 'Shift',\n  Ctrl = 'Control',\n  Meta = 'Meta'\n}\n\nexport default class ComponentRelay {\n  private contentWindow: Window;\n  private initialPermissions?: ComponentPermission[];\n  private onReadyCallback?: () => void;\n  private component: Component = { activeThemes: [], acceptsThemes: true };\n  private sentMessages: MessagePayload[] = [];\n  private messageQueue: MessagePayload[] = [];\n  private lastStreamedItem?: ItemPayload;\n  private pendingSaveItems?: ItemPayload[];\n  private pendingSaveTimeout?: NodeJS.Timeout;\n  private pendingSaveParams?: any;\n  private coallesedSaving = true;\n  private coallesedSavingDelay = DEFAULT_COALLESED_SAVING_DELAY;\n  private messageHandler?: (event: any) => void;\n  private keyDownEventListener?: (event: KeyboardEvent) => void;\n  private keyUpEventListener?: (event: KeyboardEvent) => void;\n  private clickEventListener?: (event: MouseEvent) => void;\n  private onThemesChangeCallback?: () => void;\n\n  constructor(params: ComponentRelayParams) {\n    if (!params || !params.targetWindow) {\n      throw new Error('contentWindow must be a valid Window object.')\n    }\n    this.contentWindow = params.targetWindow\n    this.processParameters(params)\n    this.registerMessageHandler()\n    this.registerKeyboardEventListeners()\n    this.registerMouseEventListeners()\n  }\n\n  private processParameters(params: ComponentRelayParams) {\n    const { initialPermissions, options, onReady, onThemesChange } = params\n\n    if (initialPermissions && initialPermissions.length > 0) {\n      this.initialPermissions = initialPermissions\n    }\n\n    if (isNotUndefinedOrNull(options?.coallesedSaving)) {\n      this.coallesedSaving = options!.coallesedSaving!\n    }\n    if (isNotUndefinedOrNull(options?.coallesedSavingDelay)) {\n      this.coallesedSavingDelay = options!.coallesedSavingDelay!\n    }\n    if (isNotUndefinedOrNull(options?.acceptsThemes)) {\n      this.component.acceptsThemes = options?.acceptsThemes ?? true\n    }\n    if (isNotUndefinedOrNull(onReady)) {\n      this.onReadyCallback = onReady\n    }\n    if (isNotUndefinedOrNull(onThemesChange)) {\n      this.onThemesChangeCallback = onThemesChange\n    }\n\n    Logger.enabled = options?.debug ?? false\n  }\n\n  public deinit(): void {\n    this.onReadyCallback = undefined\n    this.component = {\n      acceptsThemes: true,\n      activeThemes: []\n    }\n    this.messageQueue = []\n    this.sentMessages = []\n    this.lastStreamedItem = undefined\n    this.pendingSaveItems = undefined\n    this.pendingSaveTimeout = undefined\n    this.pendingSaveParams = undefined\n\n    if (this.messageHandler) {\n      this.contentWindow.document.removeEventListener('message', this.messageHandler)\n      this.contentWindow.removeEventListener('message', this.messageHandler)\n    }\n\n    if (this.keyDownEventListener) {\n      this.contentWindow.removeEventListener('keydown', this.keyDownEventListener)\n    }\n\n    if (this.keyUpEventListener) {\n      this.contentWindow.removeEventListener('keyup', this.keyUpEventListener)\n    }\n\n    if (this.clickEventListener) {\n      this.contentWindow.removeEventListener('click', this.clickEventListener)\n    }\n  }\n\n  private registerMessageHandler() {\n    this.messageHandler = (event: MessageEvent) => {\n      Logger.info('Components API Message received:', event.data)\n\n      /**\n       * We don't have access to window.parent.origin due to cross-domain restrictions.\n       * Check referrer if available, otherwise defer to checking for first-run value.\n       * Craft URL objects so that example.com === example.com/\n       */\n      if (document.referrer) {\n        const referrer = new URL(document.referrer).origin\n        const eventOrigin = new URL(event.origin).origin\n\n        if (referrer !== eventOrigin) {\n          return\n        }\n      }\n\n      // Mobile environment sends data as JSON string.\n      const { data } = event\n      const parsedData = isValidJsonString(data) ? JSON.parse(data) : data\n\n      if (!parsedData) {\n        Logger.error('Invalid data received. Skipping...')\n        return\n      }\n\n      /**\n       * The Component Registered message will be the most reliable one, so we won't change it after any subsequent events,\n       * in case you receive an event from another window.\n       */\n      if (typeof this.component.origin === 'undefined' && parsedData.action === ComponentAction.ComponentRegistered) {\n        this.component.origin = event.origin\n      } else if (event.origin !== this.component.origin) {\n        // If event origin doesn't match first-run value, return.\n        return\n      }\n\n      this.handleMessage(parsedData)\n    }\n\n    /**\n     * Mobile (React Native) uses `document`, web/desktop uses `window`.addEventListener\n     * for postMessage API to work properly.\n     * Update May 2019:\n     * As part of transitioning React Native webview into the community package,\n     * we'll now only need to use window.addEventListener.\n     * However, we want to maintain backward compatibility for Mobile < v3.0.5, so we'll keep document.addEventListener\n     * Also, even with the new version of react-native-webview, Android may still require document.addEventListener (while iOS still only requires window.addEventListener)\n     * https://github.com/react-native-community/react-native-webview/issues/323#issuecomment-467767933\n     */\n    this.contentWindow.document.addEventListener('message', this.messageHandler, false)\n    this.contentWindow.addEventListener('message', this.messageHandler, false)\n\n    Logger.info('Waiting for messages...')\n  }\n\n  private registerKeyboardEventListeners() {\n    this.keyDownEventListener = (event: KeyboardEvent) => {\n      Logger.info(`A key has been pressed: ${event.key}`)\n\n      if (event.ctrlKey) {\n        this.keyDownEvent(KeyboardModifier.Ctrl)\n      } else if (event.shiftKey) {\n        this.keyDownEvent(KeyboardModifier.Shift)\n      } else if (event.metaKey || event.key === 'Meta') {\n        this.keyDownEvent(KeyboardModifier.Meta)\n      }\n    }\n\n    this.keyUpEventListener = (event: KeyboardEvent) => {\n      Logger.info(`A key has been released: ${event.key}`)\n\n      /**\n       * Checking using event.key instead of the corresponding boolean properties.\n       */\n      if (event.key === 'Control') {\n        this.keyUpEvent(KeyboardModifier.Ctrl)\n      } else if (event.key === 'Shift') {\n        this.keyUpEvent(KeyboardModifier.Shift)\n      } else if (event.key === 'Meta') {\n        this.keyUpEvent(KeyboardModifier.Meta)\n      }\n    }\n\n    this.contentWindow.addEventListener('keydown', this.keyDownEventListener, false)\n    this.contentWindow.addEventListener('keyup', this.keyUpEventListener, false)\n  }\n\n  private registerMouseEventListeners() {\n    this.clickEventListener = (_event: MouseEvent) => {\n      Logger.info('A click has been performed.')\n\n      this.mouseClickEvent()\n    }\n\n    this.contentWindow.addEventListener('click', this.clickEventListener, false)\n  }\n\n  private handleMessage(payload: MessagePayload) {\n    switch (payload.action) {\n      case ComponentAction.ComponentRegistered:\n        this.component.sessionKey = payload.sessionKey\n        if (payload.componentData) {\n          this.component.data = payload.componentData\n        }\n        this.onReady(payload.data)\n        Logger.info('Component successfully registered with payload:', payload)\n        break\n\n      case ComponentAction.ActivateThemes:\n        this.activateThemes(payload.data.themes)\n        break\n\n      default: {\n        if (!payload.original) {\n          return\n        }\n\n        // Get the callback from queue.\n        const originalMessage = this.sentMessages?.filter((message: MessagePayload) => {\n          return message.messageId === payload.original?.messageId\n        })[0]\n\n        if (!originalMessage) {\n          // Connection must have been reset. We should alert the user unless it's a reply,\n          // in which case we may have been deallocated and reinitialized and lost the\n          // original message\n          const extensionName = this.contentWindow.document.title\n          const alertMessage = (`The extension '${extensionName}' is attempting to communicate with Standard Notes, ` +\n            'but an error is preventing it from doing so. Please restart this extension and try again.').replace('  ', ' ')\n\n          Logger.info(alertMessage)\n          return\n        }\n\n        originalMessage?.callback?.(payload.data)\n        break\n      }\n    }\n  }\n\n  private onReady(data: MessageData) {\n    this.component.environment = data.environment\n    this.component.platform = data.platform\n    this.component.uuid = data.uuid\n\n    if (this.initialPermissions && this.initialPermissions.length > 0) {\n      this.requestPermissions(this.initialPermissions)\n    }\n\n    for (const message of this.messageQueue) {\n      this.postMessage(message.action, message.data, message.callback)\n    }\n\n    this.messageQueue = []\n\n    Logger.info('Data passed to onReady:', data)\n\n    this.activateThemes(data.activeThemeUrls || [])\n\n    // After activateThemes is done, we want to send a message with the ThemesActivated action.\n    this.postMessage(ComponentAction.ThemesActivated, {})\n\n    if (this.onReadyCallback) {\n      this.onReadyCallback()\n    }\n  }\n\n  /**\n   * Gets the component UUID.\n   */\n  public getSelfComponentUUID(): string | undefined {\n    return this.component.uuid\n  }\n\n  /**\n   * Checks if the component is running in a Desktop application.\n   */\n  public isRunningInDesktopApplication(): boolean {\n    return this.component.environment === environmentToString(Environment.Desktop)\n  }\n\n  /**\n   * Checks if the component is running in a Mobile application.\n   */\n  public isRunningInMobileApplication(): boolean {\n    return this.component.environment === environmentToString(Environment.Mobile)\n  }\n\n  /**\n   * Gets the component's data value for the specified key.\n   * @param key The key for the data object.\n   * @returns `undefined` if the value for the key does not exist. Returns the stored value otherwise.\n   */\n  public getComponentDataValueForKey(key: string): any {\n    if (!this.component.data) {\n      return\n    }\n    return this.component.data[key]\n  }\n\n  /**\n   * Sets the component's data value for the specified key.\n   * @param key The key for the data object.\n   * @param value The value to store under the specified key.\n   */\n  public setComponentDataValueForKey(key: string, value: any): void {\n    if (!this.component.data) {\n      throw new Error('The component has not been initialized.')\n    }\n    if (!key || (key && key.length === 0)) {\n      throw new Error('The key for the data value should be a valid string.')\n    }\n    this.component.data = {\n      ...this.component.data,\n      [key]: value,\n    }\n    this.postMessage(ComponentAction.SetComponentData, { componentData: this.component.data })\n  }\n\n  /**\n   * Clears the component's data object.\n   */\n  public clearComponentData(): void {\n    this.component.data = {}\n    this.postMessage(ComponentAction.SetComponentData, { componentData: this.component.data })\n  }\n\n  private postMessage(action: ComponentAction, data: MessageData, callback?: (...params: any) => void) {\n    /**\n     * If the sessionKey is not set, we push the message to queue\n     * that will be processed later on.\n     */\n    if (!this.component.sessionKey) {\n      this.messageQueue.push({\n        action,\n        data,\n        api: MessagePayloadApi.Component,\n        callback: callback\n      })\n      return\n    }\n\n    const message = {\n      action,\n      data,\n      messageId: this.generateUUID(),\n      sessionKey: this.component.sessionKey,\n      api: MessagePayloadApi.Component\n    }\n\n    const sentMessage = JSON.parse(JSON.stringify(message))\n    sentMessage.callback = callback\n    this.sentMessages.push(sentMessage)\n\n    let postMessagePayload\n\n    // Mobile (React Native) requires a string for the postMessage API.\n    if (this.isRunningInMobileApplication()) {\n      postMessagePayload = JSON.stringify(message)\n    } else {\n      postMessagePayload = message\n    }\n\n    Logger.info('Posting message:', postMessagePayload)\n    this.contentWindow.parent.postMessage(postMessagePayload, this.component.origin!)\n  }\n\n  private requestPermissions(permissions: ComponentPermission[], callback?: (...params: any) => void) {\n    this.postMessage(ComponentAction.RequestPermissions, { permissions }, () => {\n      callback && callback()\n    })\n  }\n\n  private activateThemes(incomingUrls: string[] = []) {\n    if (!this.component.acceptsThemes) {\n      return\n    }\n\n    Logger.info('Incoming themes:', incomingUrls)\n\n    const { activeThemes } = this.component\n\n    if (activeThemes && activeThemes.sort().toString() == incomingUrls.sort().toString()) {\n      // Incoming theme URLs are same as active, do nothing.\n      return\n    }\n\n    let themesToActivate = incomingUrls\n    const themesToDeactivate = []\n\n    for (const activeUrl of activeThemes) {\n      if (!incomingUrls.includes(activeUrl)) {\n        // Active not present in incoming, deactivate it.\n        themesToDeactivate.push(activeUrl)\n      } else {\n        // Already present in active themes, remove it from themesToActivate.\n        themesToActivate = themesToActivate.filter((candidate) => {\n          return candidate !== activeUrl\n        })\n      }\n    }\n\n    Logger.info('Deactivating themes:', themesToDeactivate)\n    Logger.info('Activating themes:', themesToActivate)\n\n    for (const themeUrl of themesToDeactivate) {\n      this.deactivateTheme(themeUrl)\n    }\n\n    this.component.activeThemes = incomingUrls\n\n    for (const themeUrl of themesToActivate) {\n      if (!themeUrl) {\n        continue\n      }\n\n      const link = this.contentWindow.document.createElement('link')\n      link.id = btoa(themeUrl)\n      link.href = themeUrl\n      link.type = 'text/css'\n      link.rel = 'stylesheet'\n      link.media = 'screen,print'\n      link.className = 'custom-theme'\n      this.contentWindow.document.getElementsByTagName('head')[0].appendChild(link)\n    }\n\n    this.onThemesChangeCallback && this.onThemesChangeCallback()\n  }\n\n  private themeElementForUrl(themeUrl: string) {\n    const elements = Array.from(this.contentWindow.document.getElementsByClassName('custom-theme')).slice()\n    return elements.find((element) => {\n      // We used to search here by `href`, but on desktop, with local file:// urls, that didn't work for some reason.\n      return element.id == btoa(themeUrl)\n    })\n  }\n\n  private deactivateTheme(themeUrl: string) {\n    const element = this.themeElementForUrl(themeUrl)\n    if (element && element.parentNode) {\n      element.setAttribute('disabled', 'true')\n      element.parentNode.removeChild(element)\n    }\n  }\n\n  private generateUUID() {\n    return generateUuid()\n  }\n\n  /**\n   * Gets the current platform where the component is running.\n   */\n  public get platform(): string | undefined {\n    return this.component.platform\n  }\n\n  /**\n   * Gets the current environment where the component is running.\n   */\n  public get environment(): string | undefined {\n    return this.component.environment\n  }\n\n  /**\n   * Streams a collection of Items, filtered by content type.\n   * New items are passed to the callback as they come.\n   * @param contentTypes A collection of Content Types.\n   * @param callback A callback to process the streamed items.\n   */\n  public streamItems(contentTypes: ContentType[], callback: (data: any) => void): void {\n    this.postMessage(ComponentAction.StreamItems, { content_types: contentTypes }, (data: any) => {\n      callback(data.items)\n    })\n  }\n\n  /**\n   * Streams the current Item in context.\n   * @param callback A callback to process the streamed item.\n   */\n  public streamContextItem(callback: (data: any) => void): void {\n    this.postMessage(ComponentAction.StreamContextItem, {}, (data) => {\n      const { item } = data\n      /**\n       * If this is a new context item than the context item the component was currently entertaining,\n       * we want to immediately commit any pending saves, because if you send the new context item to the\n       * component before it has commited its presave, it will end up first replacing the UI with new context item,\n       * and when the debouncer executes to read the component UI, it will be reading the new UI for the previous item.\n       */\n      const isNewItem = !this.lastStreamedItem || this.lastStreamedItem.uuid !== item.uuid\n\n      if (isNewItem && this.pendingSaveTimeout) {\n        clearTimeout(this.pendingSaveTimeout)\n        this._performSavingOfItems(this.pendingSaveParams)\n        this.pendingSaveTimeout = undefined\n        this.pendingSaveParams = undefined\n      }\n\n      this.lastStreamedItem = item\n      callback(this.lastStreamedItem)\n    })\n  }\n\n  /**\n   * Selects a `Tag` item.\n   * @param item The Item (`Tag` or `SmartTag`) to select.\n   */\n  public selectItem(item: ItemPayload): void {\n    this.postMessage(ComponentAction.SelectItem, { item: this.jsonObjectForItem(item) })\n  }\n\n  /**\n   * Clears current selected `Tag` (if any).\n   */\n  public clearSelection(): void {\n    this.postMessage(ComponentAction.ClearSelection, { content_type: ContentType.Tag })\n  }\n\n  /**\n   * Creates and stores an Item in the item store.\n   * @param item The Item's payload content.\n   * @param callback The callback to process the created Item.\n   */\n  public createItem(item: ItemPayload, callback: (data: any) => void): void {\n    this.postMessage(ComponentAction.CreateItem, { item: this.jsonObjectForItem(item) }, (data: any) => {\n      let { item } = data\n      /**\n       * A previous version of the SN app had an issue where the item in the reply to ComponentActions.CreateItems\n       * would be nested inside \"items\" and not \"item\". So handle both cases here.\n       */\n      if (!item && data.items && data.items.length > 0) {\n        item = data.items[0]\n      }\n      this.associateItem(item)\n      callback && callback(item)\n    })\n  }\n\n  /**\n   * Creates and stores a collection of Items in the item store.\n   * @param items The Item(s) payload collection.\n   * @param callback The callback to process the created Item(s).\n   */\n  public createItems(items: ItemPayload[], callback: (data: any) => void): void {\n    const mapped = items.map((item) => this.jsonObjectForItem(item))\n    this.postMessage(ComponentAction.CreateItems, { items: mapped }, (data: any) => {\n      callback && callback(data.items)\n    })\n  }\n\n  /**\n   * Associates a `Tag` with the current Note.\n   * @param item The `Tag` item to associate.\n   */\n  public associateItem(item: ItemPayload): void {\n    this.postMessage(ComponentAction.AssociateItem, { item: this.jsonObjectForItem(item) })\n  }\n\n  /**\n   * Deassociates a `Tag` with the current Note.\n   * @param item The `Tag` item to deassociate.\n   */\n  public deassociateItem(item: ItemPayload): void {\n    this.postMessage(ComponentAction.DeassociateItem, { item: this.jsonObjectForItem(item) })\n  }\n\n  /**\n   * Deletes an Item from the item store.\n   * @param item The Item to delete.\n   * @param callback The callback with the result of the operation.\n   */\n  public deleteItem(item: ItemPayload, callback: (data: ItemMessagePayload) => void): void {\n    this.deleteItems([item], callback)\n  }\n\n  /**\n   * Deletes a collection of Items from the item store.\n   * @param items The Item(s) to delete.\n   * @param callback The callback with the result of the operation.\n   */\n  public deleteItems(items: ItemPayload[], callback: (data: ItemMessagePayload) => void): void {\n    const params = {\n      items: items.map((item) => {\n        return this.jsonObjectForItem(item)\n      }),\n    }\n    this.postMessage(ComponentAction.DeleteItems, params, (data) => {\n      callback && callback(data)\n    })\n  }\n\n  /**\n   * Performs a custom action to the component manager.\n   * @param action\n   * @param data\n   * @param callback The callback with the result of the operation.\n   */\n  public sendCustomEvent(action: ComponentAction, data: any, callback?: (data: any) => void): void {\n    this.postMessage(action, data, (data: any) => {\n      callback && callback(data)\n    })\n  }\n\n  /**\n   * Saves an existing Item in the item store.\n   * @param item An existing Item to be saved.\n   * @param callback\n   * @param skipDebouncer\n   */\n  public saveItem(item: ItemPayload, callback?: () => void, skipDebouncer = false): void {\n    this.saveItems([item], callback, skipDebouncer)\n  }\n\n  /**\n   * Runs a callback before saving an Item.\n   * @param item An existing Item to be saved.\n   * @param presave Allows clients to perform any actions last second before the save actually occurs (like setting previews).\n   * Saves debounce by default, so if a client needs to compute a property on an item before saving, it's best to\n   * hook into the debounce cycle so that clients don't have to implement their own debouncing.\n   * @param callback\n   */\n  public saveItemWithPresave(item: ItemPayload, presave: any, callback?: () => void): void {\n    this.saveItemsWithPresave([item], presave, callback)\n  }\n\n  /**\n   * Runs a callback before saving a collection of Items.\n   * @param items A collection of existing Items to be saved.\n   * @param presave Allows clients to perform any actions last second before the save actually occurs (like setting previews).\n   * Saves debounce by default, so if a client needs to compute a property on an item before saving, it's best to\n   * hook into the debounce cycle so that clients don't have to implement their own debouncing.\n   * @param callback\n   */\n  public saveItemsWithPresave(items: ItemPayload[], presave: any, callback?: () => void): void {\n    this.saveItems(items, callback, false, presave)\n  }\n\n  private _performSavingOfItems({ items, presave, callback }: { items: ItemPayload[], presave: () => void, callback?: () => void }) {\n    /**\n     * Presave block allows client to gain the benefit of performing something in the debounce cycle.\n     */\n    presave && presave()\n\n    const mappedItems = []\n    for (const item of items) {\n      mappedItems.push(this.jsonObjectForItem(item))\n    }\n\n    this.postMessage(ComponentAction.SaveItems, { items: mappedItems }, () => {\n      callback && callback()\n    })\n  }\n\n  /**\n   * Saves a collection of existing Items.\n   * @param items The items to be saved.\n   * @param callback\n   * @param skipDebouncer Allows saves to go through right away rather than waiting for timeout.\n   * This should be used when saving items via other means besides keystrokes.\n   * @param presave\n   */\n  public saveItems(items: ItemPayload[], callback?: () => void, skipDebouncer = false, presave?: any): void {\n    /**\n     * We need to make sure that when we clear a pending save timeout,\n     * we carry over those pending items into the new save.\n     */\n    if (!this.pendingSaveItems) {\n      this.pendingSaveItems = []\n    }\n\n    if (this.coallesedSaving && !skipDebouncer) {\n      if (this.pendingSaveTimeout) {\n        clearTimeout(this.pendingSaveTimeout)\n      }\n\n      const incomingIds = items.map((item) => item.uuid)\n      /**\n       * Replace any existing save items with incoming values.\n       * Only keep items here who are not in incomingIds.\n       */\n      const preexistingItems = this.pendingSaveItems.filter((item) => {\n        return !incomingIds.includes(item.uuid)\n      })\n\n      // Add new items, now that we've made sure it's cleared of incoming items.\n      this.pendingSaveItems = preexistingItems.concat(items)\n\n      // We'll potentially need to commit early if stream-context-item message comes in.\n      this.pendingSaveParams = {\n        items: this.pendingSaveItems,\n        presave,\n        callback\n      }\n\n      this.pendingSaveTimeout = setTimeout(() => {\n        this._performSavingOfItems(this.pendingSaveParams)\n        this.pendingSaveItems = []\n        this.pendingSaveTimeout = undefined\n        this.pendingSaveParams = null\n      }, this.coallesedSavingDelay)\n    } else {\n      this._performSavingOfItems({ items, presave, callback })\n    }\n  }\n\n  /**\n   * Sets a new container size for the current component.\n   * @param width The new width.\n   * @param height The new height.\n   */\n  public setSize(width: string | number, height: string | number): void {\n    this.postMessage(ComponentAction.SetSize, { type: 'container', width, height })\n  }\n\n  /**\n   * Sends the KeyDown keyboard event to the Standard Notes parent application.\n   * @param keyboardModifier The keyboard modifier that was pressed.\n   */\n  private keyDownEvent(keyboardModifier: KeyboardModifier): void {\n    this.postMessage(ComponentAction.KeyDown, { keyboardModifier })\n  }\n\n  /**\n   * Sends the KeyUp keyboard event to the Standard Notes parent application.\n   * @param keyboardModifier The keyboard modifier that was released.\n   */\n  private keyUpEvent(keyboardModifier: KeyboardModifier): void {\n    this.postMessage(ComponentAction.KeyUp, { keyboardModifier })\n  }\n\n  /**\n   * Sends the Click mouse event to the Standard Notes parent application.\n   */\n  private mouseClickEvent(): void {\n    this.postMessage(ComponentAction.Click, {})\n  }\n\n  private jsonObjectForItem(item: SNItem | ItemPayload) {\n    const copy = Object.assign({}, item) as any\n    copy.children = null\n    copy.parent = null\n    return copy\n  }\n\n  /**\n   * Gets the Item's appData value for the specified key.\n   * Uses the default domain (org.standardnotes.sn).\n   * This function is used with Items returned from streamContextItem() and streamItems()\n   * @param item The Item to get the appData value from.\n   * @param key The key to get the value from.\n   */\n  public getItemAppDataValue(item: ItemMessagePayload | undefined, key: AppDataField | string): any {\n    const defaultDomain = 'org.standardnotes.sn'\n    return item?.content?.appData?.[defaultDomain][key]\n  }\n}\n"],"sourceRoot":""}