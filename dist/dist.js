(()=>{var e={297:(e,t,n)=>{"use strict";class i{static info(...e){this.enabled&&console.log(e)}static error(...e){console.error(e)}}i.enabled=!1;class r{static generateUuid(){const e=window.crypto||window.msCrypto;if(e){const t=new Uint32Array(4);e.getRandomValues(t);let n=-1;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{n++;const i=t[n>>3]>>n%8*4&15;return("x"===e?i:3&i|8).toString(16)}))}let t=(new Date).getTime();return window.performance&&"function"==typeof window.performance.now&&(t+=performance.now()),"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,(e=>{const n=(t+16*Math.random())%16|0;return t=Math.floor(t/16),("x"===e?n:3&n|8).toString(16)}))}static isValidJsonString(e){if("string"!=typeof e)return!1;try{const t=JSON.parse(e),n=Object.prototype.toString.call(t);return"[object Object]"===n||"[object Array]"===n}catch(e){return!1}}}var s,a=n(294);!function(e){e.Component="component"}(s||(s={}));const o={activeThemes:[]},c=class{constructor(e){var t,n,r;this.component=o,this.sentMessages=[],this.messageQueue=[],this.coallesedSaving=!1,this.coallesedSavingDelay=250,(null==e?void 0:e.initialPermissions)&&e.initialPermissions.length>0&&(this.initialPermissions=e.initialPermissions),(null==e||null===(t=e.options)||void 0===t?void 0:t.coallesedSaving)&&(this.coallesedSaving=e.options.coallesedSaving),(null==e||null===(n=e.options)||void 0===n?void 0:n.coallesedSavingDelay)&&(this.coallesedSavingDelay=e.options.coallesedSavingDelay),(null==e||null===(r=e.options)||void 0===r?void 0:r.loggingEnabled)&&(i.enabled=e.options.loggingEnabled),(null==e?void 0:e.onReady)&&(this.onReadyCallback=e.onReady),this.registerMessageHandler()}registerMessageHandler(){const e=e=>{if(i.info("Components API Message received:",e.data),document.referrer&&new URL(document.referrer).origin!==new URL(e.origin).origin)return;if(this.component.origin){if(e.origin!==this.component.origin)return}else this.component.origin=e.origin;const{data:t}=e,n=r.isValidJsonString(t)?JSON.parse(t):t;this.handleMessage(n)};document.addEventListener("message",(t=>{e(t)}),!1),window.addEventListener("message",(t=>{e(t)}),!1)}handleMessage(e){if(e.action===a.ComponentAction.ComponentRegistered)this.component.sessionKey=e.sessionKey,this.component.data=e.componentData,this.onReady(e.data),i.info("Component successfully registered with payload:",e);else if(e.action===a.ComponentAction.ActivateThemes)this.component.acceptsThemes&&this.activateThemes(e.data.themes);else if(e.original){const t=this.sentMessages.filter((t=>t.messageId===e.original.messageId))[0];t||alert("This extension is attempting to communicate with Standard Notes, but an error is preventing it from doing so. Please restart this extension and try again."),t.callback&&t.callback(e.data)}}onReady(e){this.component.environment=e.environment,this.component.platform=e.platform,this.component.uuid=e.uuid,this.component.isMobile=this.component.environment===a.Environment.Mobile,this.initialPermissions&&this.initialPermissions.length>0&&this.requestPermissions(this.initialPermissions);for(const e of this.messageQueue)this.postMessage(e.action,e.data,e.callback);this.messageQueue=[],i.info("Data passed to onReady:",e),this.activateThemes(e.activeThemeUrls||[]),this.onReadyCallback&&this.onReadyCallback()}getSelfComponentUUID(){return this.component.uuid}isRunningInDesktopApplication(){return this.component.environment===a.Environment.Desktop}getComponentDataValueForKey(e){return this.component.data[e]}setComponentDataValueForKey(e,t){this.component.data[e]=t,this.postMessage(a.ComponentAction.SetComponentData,{componentData:this.component.data})}clearComponentData(){this.component.data={},this.postMessage(a.ComponentAction.SetComponentData,{componentData:this.component.data})}postMessage(e,t,n){if(!this.component.sessionKey)return void this.messageQueue.push({action:e,data:t,api:s.Component,callback:n});const r={action:e,data:t,messageId:this.generateUUID(),sessionKey:this.component.sessionKey,api:s.Component},a=JSON.parse(JSON.stringify(r));if(a.callback=n,this.sentMessages.push(a),this.component.isMobile){const e=JSON.stringify(r);return i.info("Posting message:",e),void window.parent.postMessage(e,this.component.origin)}i.info("Posting message:",r),window.parent.postMessage(r,this.component.origin)}requestPermissions(e,t){this.postMessage(a.ComponentAction.RequestPermissions,e,(()=>{t&&t()}))}activateThemes(e=[]){if(i.info("Incoming themes:",e),this.component.activeThemes.sort().toString()==e.sort().toString())return;let t=e;const n=[];for(const i of this.component.activeThemes)e.includes(i)?t=t.filter((e=>e!==i)):n.push(i);i.info("Deactivating themes:",n),i.info("Activating themes:",t);for(const e of n)this.deactivateTheme(e);this.component.activeThemes=e;for(const e of t){if(!e)continue;const t=document.createElement("link");t.id=btoa(e),t.href=e,t.type="text/css",t.rel="stylesheet",t.media="screen,print",t.className="custom-theme",document.getElementsByTagName("head")[0].appendChild(t)}}themeElementForUrl(e){return Array.from(document.getElementsByClassName("custom-theme")).slice().find((t=>t.id==btoa(e)))}deactivateTheme(e){const t=this.themeElementForUrl(e);t||(t.setAttribute("disabled","true"),t.parentNode.removeChild(t))}generateUUID(){return r.generateUuid()}streamItems(e,t){this.postMessage(a.ComponentAction.StreamItems,{content_types:e},(e=>{t(e.items)}))}streamContextItem(e){this.postMessage(a.ComponentAction.StreamContextItem,{},(t=>{const{item:n}=t;(!this.lastStreamedItem||this.lastStreamedItem.uuid!==n.uuid)&&this.pendingSaveTimeout&&(clearTimeout(this.pendingSaveTimeout),this._performSavingOfItems(this.pendingSaveParams),this.pendingSaveTimeout=void 0,this.pendingSaveParams=void 0),this.lastStreamedItem=n,e(this.lastStreamedItem)}))}selectItem(e){e.content_type===a.ContentType.Tag&&this.postMessage(a.ComponentAction.SelectItem,{item:this.jsonObjectForItem(e)})}clearSelection(){this.postMessage(a.ComponentAction.ClearSelection,{content_type:a.ContentType.Tag})}createItem(e,t){this.postMessage(a.ComponentAction.CreateItem,{item:this.jsonObjectForItem(e)},(e=>{let{item:n}=e;!n&&e.items&&e.items.length>0&&(n=e.items[0]),this.associateItem(n),t&&t(n)}))}createItems(e,t){const n=e.map((e=>this.jsonObjectForItem(e)));this.postMessage(a.ComponentAction.CreateItems,{items:n},(e=>{t&&t(e.items)}))}associateItem(e){this.postMessage(a.ComponentAction.AssociateItem,{item:this.jsonObjectForItem(e)})}deassociateItem(e){this.postMessage(a.ComponentAction.DeassociateItem,{item:this.jsonObjectForItem(e)})}deleteItem(e,t){this.deleteItems([e],t)}deleteItems(e,t){const n={items:e.map((e=>this.jsonObjectForItem(e)))};this.postMessage(a.ComponentAction.DeleteItems,n,(e=>{t&&t(e)}))}sendCustomEvent(e,t,n){this.postMessage(e,t,(e=>{n&&n(e)}))}saveItem(e,t,n=!1){this.saveItems([e],t,n)}saveItemWithPresave(e,t,n){this.saveItemsWithPresave([e],t,n)}saveItemsWithPresave(e,t,n){this.saveItems(e,n,!1,t)}_performSavingOfItems({items:e,presave:t,callback:n}){t&&t();const i=[];for(const t of e)i.push(this.jsonObjectForItem(t));this.postMessage(a.ComponentAction.SaveItems,{items:i},(()=>{n&&n()}))}saveItems(e,t,n=!1,i){if(this.pendingSaveItems||(this.pendingSaveItems=[]),!0!==this.coallesedSaving||n)this._performSavingOfItems({items:e,presave:i,callback:t});else{this.pendingSaveTimeout&&clearTimeout(this.pendingSaveTimeout);const n=e.map((e=>e.uuid)),r=this.pendingSaveItems.filter((e=>!n.includes(e.uuid)));this.pendingSaveItems=r.concat(e),this.pendingSaveParams={items:this.pendingSaveItems,presave:i,callback:t},this.pendingSaveTimeout=setTimeout((()=>{this._performSavingOfItems(this.pendingSaveParams),this.pendingSaveItems=[],this.pendingSaveTimeout=void 0,this.pendingSaveParams=null}),this.coallesedSavingDelay)}}setSize(e,t,n){this.postMessage(a.ComponentAction.SetSize,{type:e,width:t,height:n})}jsonObjectForItem(e){const t=Object.assign({},e);return t.children=null,t.parent=null,t}getItemAppDataValue(e,t){const{safeContent:n}=e.payload,i=n.appData&&n.appData["org.standardnotes.sn"];return i?i[t]:null}};void 0!==(e=n.hmd(e)).exports&&(e.exports=c),window&&(window.ComponentManager=c)},294:e=>{var t;window,t=function(){return function(e){var t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={i,l:!1,exports:{}};return e[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=e,n.c=t,n.d=function(e,t,i){n.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:i})},n.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},n.t=function(e,t){if(1&t&&(e=n(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)n.d(i,r,function(t){return e[t]}.bind(null,r));return i},n.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return n.d(t,"a",t),t},n.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},n.p="/dist/",n(n.s=193)}([function(e,t,n){"use strict";(function(e){n.d(t,"n",(function(){return g})),n.d(t,"j",(function(){return f})),n.d(t,"u",(function(){return m})),n.d(t,"s",(function(){return v})),n.d(t,"m",(function(){return w})),n.d(t,"E",(function(){return S})),n.d(t,"f",(function(){return b})),n.d(t,"r",(function(){return P})),n.d(t,"p",(function(){return O})),n.d(t,"q",(function(){return D})),n.d(t,"t",(function(){return C})),n.d(t,"o",(function(){return I})),n.d(t,"K",(function(){return M})),n.d(t,"L",(function(){return j})),n.d(t,"x",(function(){return A})),n.d(t,"k",(function(){return E})),n.d(t,"H",(function(){return R})),n.d(t,"C",(function(){return k})),n.d(t,"b",(function(){return K})),n.d(t,"l",(function(){return _})),n.d(t,"c",(function(){return T})),n.d(t,"e",(function(){return x})),n.d(t,"D",(function(){return F})),n.d(t,"d",(function(){return L})),n.d(t,"y",(function(){return V})),n.d(t,"G",(function(){return N})),n.d(t,"A",(function(){return U})),n.d(t,"g",(function(){return W})),n.d(t,"I",(function(){return B})),n.d(t,"w",(function(){return H})),n.d(t,"z",(function(){return q})),n.d(t,"v",(function(){return z})),n.d(t,"a",(function(){return J})),n.d(t,"i",(function(){return Q})),n.d(t,"B",(function(){return G})),n.d(t,"h",(function(){return Y})),n.d(t,"J",(function(){return $})),n.d(t,"F",(function(){return X}));var i=n(19),r=n.n(i),s=n(17),a=n.n(s),o=n(15),c=n.n(o),l=n(78),u=n.n(l),d=n(79),h=n.n(d),p=n(23),y=n.n(p);function g(){return"undefined"!=typeof window?window:void 0!==e?e:null}function f(e){return Object.keys(e).map((t=>e[t]))}function m(){return null!==g()&&!v()&&!(document&&document.documentMode)||/Edge/.test(navigator.userAgent)&&window.crypto&&!!window.crypto.subtle}function v(){return"undefined"!=typeof navigator&&"ReactNative"===navigator.product}function w(e,t,n){return e.find((e=>e[t]===n))}function S(e,t){return a()(e,t)}function b(){let e=[];for(var t=arguments.length,n=new Array(t),i=0;i<t;i++)n[i]=arguments[i];for(const t of n)e=e.concat(t);return e}function P(e){return null!==e&&("function"==typeof e||"object"==typeof e)}function O(e){return null!==e&&"function"==typeof e}function D(e){return null==e}function C(e){return"string"==typeof e||e instanceof String}function I(e,t){return e>t?e:t}function M(e,t,n){return h()(e.concat(t),((e,t)=>{for(const i of n)if(e[i]!==t[i])return!1;return!0}))}function j(e){return y()(e)}function A(e){return e[e.length-1]}function E(e,t){for(const n of t)e.push(n)}function R(e,t){for(const n of t)k(e,n)}function k(e,t){const n=e.indexOf(t);-1!==n&&e.splice(n,1)}function K(e,t){return!e.includes(t)&&(e.push(t),!0)}function _(e,t){r()(e,t)}function T(e,t){return e.filter((e=>!t.includes(e))).concat(t.filter((t=>!e.includes(t))))}function x(e,t){return!(e&&!t||!e&&t)&&(e instanceof Date&&t instanceof Date?e.getTime()===t.getTime():e instanceof String&&t instanceof String?e===t:B(e,t))}function F(e,t){e.splice(t,1)}function L(e,t){const n=e.slice();return F(n,t),n}function V(e){const t=[];for(const n of Object.keys(e))t.push(e[n]);return t}function N(e){const t=Object.keys(e).sort(),n={};for(const i of t)n[i]=e[i];return J(n)}function U(e){const t={};for(const n of Object.keys(e))D(e[n])||(t[n]=e[n]);return t}function W(e,t){let n=!(arguments.length>2&&void 0!==arguments[2])||arguments[2];return e.sort(((e,i)=>{const r=e[t].getTime(),s=i[t].getTime(),a=n?1:-1;return r<s?-1*a:r>s?1*a:0}))}function B(e,t){if(!e&&!t)return!0;if(!e||!t)return!1;const n=Object.keys(e),i=Object.keys(t);if(n.length!==i.length)return!1;for(const i of n)if(e[i]!==t[i])return!1;return!0}function H(e){const t={};for(const n of Object.keys(e)){let i;try{i=JSON.parse(e[n])}catch(t){i=e[n]}t[n]=i}return t}function q(e,t){if(e)for(const n of t)delete e[n]}function z(){for(var e=arguments.length,t=new Array(e),n=0;n<e;n++)t[n]=arguments[n];return t.map(((e,t)=>0===t?e.trim().replace(/[\/]*$/g,""):e.trim().replace(/(^[\/]*|[\/]*$)/g,""))).filter((e=>e.length)).join("/")}function J(e){return e instanceof Date?new Date(e):P(e)?JSON.parse(JSON.stringify(e)):e}function Q(e,t){if(!e||!t)throw"Attempting to deepMerge with null values";return u()(e,t,((e,t)=>{if(c()(e))return t})),e}function G(e,t){const n={};for(const i of t)n[i]=e[i];return J(n)}function Y(e){const t=Object.getOwnPropertyNames(e);for(const n of t){const t=e[n];t&&"object"==typeof t&&!Object.isFrozen(t)?e[n]=Y(t):e[n]=t}return Object.freeze(e)}function $(e,t){const n=t/4;return e.substring(0,n)}async function X(e){return console.warn("Sleeping for ".concat(e,"ms")),new Promise((t=>{setTimeout((function(){t()}),e)}))}}).call(this,n(28))},function(e,t,n){"use strict";n.d(t,"e",(function(){return v})),n.d(t,"g",(function(){return w})),n.d(t,"d",(function(){return S})),n.d(t,"f",(function(){return b})),n.d(t,"b",(function(){return P})),n.d(t,"c",(function(){return D})),n.d(t,"a",(function(){return C}));var i=n(22),r=n(2),s=n(7),a=n(0),o=n(4);const c=[o.a.Uuid,o.a.ContentType,o.a.ItemsKeyId,o.a.EncItemKey,o.a.Content,o.a.CreatedAt,o.a.UpdatedAt,o.a.Deleted,o.a.Legacy003AuthHash,o.a.Legacy003AuthParams,o.a.Dirty,o.a.DirtiedDate,o.a.ErrorDecrypting,o.a.ErrorDecryptingChanged,o.a.WaitingForKey,o.a.LastSyncBegan,o.a.LastSyncEnd,o.a.DuplicateOf],l=[o.a.Uuid,o.a.ItemsKeyId,o.a.EncItemKey,o.a.Content,o.a.Legacy003AuthHash,o.a.ErrorDecrypting,o.a.ErrorDecryptingChanged,o.a.WaitingForKey],u=[o.a.Uuid,o.a.ContentType,o.a.ItemsKeyId,o.a.EncItemKey,o.a.Content,o.a.CreatedAt,o.a.UpdatedAt,o.a.Legacy003AuthHash,o.a.DuplicateOf],d=[o.a.Uuid,o.a.ContentType,o.a.ItemsKeyId,o.a.EncItemKey,o.a.Content,o.a.CreatedAt,o.a.UpdatedAt,o.a.Deleted,o.a.Legacy003AuthHash,o.a.Legacy003AuthParams,o.a.Dirty,o.a.DirtiedDate,o.a.ErrorDecrypting,o.a.WaitingForKey,o.a.DuplicateOf],h=[o.a.Uuid,o.a.ContentType,o.a.ItemsKeyId,o.a.EncItemKey,o.a.Content,o.a.CreatedAt,o.a.UpdatedAt,o.a.Deleted,o.a.Legacy003AuthHash,o.a.DuplicateOf],p=[o.a.Uuid,o.a.ContentType,o.a.Content,o.a.UpdatedAt],y=[o.a.Uuid,o.a.Content,o.a.CreatedAt],g=[o.a.Uuid,o.a.Content,o.a.ContentType,o.a.CreatedAt],f=[o.a.Uuid,o.a.ContentType,o.a.UpdatedAt,o.a.Deleted,o.a.Dirty,o.a.LastSyncEnd],m=h.slice();function v(e,t,n){return O(e,c.slice(),n,t)}function w(e,t,n,i){const r={},s=n||t.fields;for(const e of s)r[e]=t[e];if(i){const e=Object.keys(i);for(const t of e)r[t]=i[t]}return P(e,r)}function S(e,t,n){return O(e,function(e){if(e===s.b.FileEncrypted||e===s.b.FileDecrypted||e===s.b.FilePreferEncrypted)return u.slice();if(e===s.b.LocalStoragePreferEncrypted||e===s.b.LocalStorageDecrypted||e===s.b.LocalStorageEncrypted)return d.slice();if(e===s.b.Sync||e===s.b.SyncDecrypted)return h.slice();throw"No payload fields found for intent ".concat(e)}(t),r.a.Constructor,n)}function b(e,t,n){return O(e,function(e){if(e===r.a.FileImport)return u.slice();if(e===r.a.SessionHistory)return p.slice();if(e===r.a.RemoteHistory)return m.slice();if(e===r.a.ComponentRetrieved)return y.slice();if(e===r.a.ComponentCreated)return g.slice();if(e===r.a.LocalRetrieved||e===r.a.LocalChanged)return d.slice();if(e===r.a.RemoteRetrieved||e===r.a.ConflictData||e===r.a.ConflictUuid)return h.slice();if(e===r.a.LocalSaved||e===r.a.RemoteSaved)return f.slice();throw"No payload fields found for source ".concat(e)}(t),t,n)}function P(e,t){return O(e,e.fields,e.source,t)}function O(e,t,n,s){const o=Object(a.B)(e,t),c=s instanceof i.a?s.fields.slice():Object.keys(s||[]);for(const e of c){const t=s[e];o[e]=t?Object(a.a)(t):t}const l=Object(a.L)(t.concat(c));return new i.a(o,l,n||r.a.Constructor)}function D(e,t){return O(e,Object.keys(e),t)}function C(e,t){return O(e,l.slice(),void 0,t)}},function(e,t,n){"use strict";var i;function r(e){return[i.RemoteSaved,i.PreSyncSave].includes(e)}function s(e){return[i.RemoteRetrieved,i.ComponentRetrieved,i.RemoteActionRetrieved].includes(e)}n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r})),n.d(t,"c",(function(){return s})),function(e){e[e.RemoteRetrieved=1]="RemoteRetrieved",e[e.RemoteSaved=2]="RemoteSaved",e[e.LocalSaved=3]="LocalSaved",e[e.LocalRetrieved=4]="LocalRetrieved",e[e.LocalChanged=5]="LocalChanged",e[e.ComponentRetrieved=6]="ComponentRetrieved",e[e.DesktopInstalled=7]="DesktopInstalled",e[e.RemoteActionRetrieved=8]="RemoteActionRetrieved",e[e.FileImport=9]="FileImport",e[e.RemoteConflict=10]="RemoteConflict",e[e.ImportConflict=11]="ImportConflict",e[e.SavedOrSaving=12]="SavedOrSaving",e[e.DecryptedTransient=13]="DecryptedTransient",e[e.ConflictUuid=14]="ConflictUuid",e[e.ConflictData=15]="ConflictData",e[e.SessionHistory=16]="SessionHistory",e[e.Constructor=17]="Constructor",e[e.ComponentCreated=18]="ComponentCreated",e[e.PreSyncSave=19]="PreSyncSave",e[e.RemoteHistory=20]="RemoteHistory"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return i})),n.d(t,"a",(function(){return r})),n.d(t,"c",(function(){return s}));const i="org.standardnotes.sn";var r;function s(e){return{[r.Note]:"note",[r.Tag]:"tag",[r.SmartTag]:"smart tag",[r.ActionsExtension]:"action-based extension",[r.Component]:"component",[r.Editor]:"editor",[r.Theme]:"theme",[r.ServerExtension]:"server extension",[r.Mfa]:"two-factor authentication setting",[r.FilesafeCredentials]:"FileSafe credential",[r.FilesafeFileMetadata]:"FileSafe file",[r.FilesafeIntegration]:"FileSafe integration"}[e]}!function(e){e.Any="*",e.Item="SF|Item",e.RootKey="SN|RootKey|NoSync",e.ItemsKey="SN|ItemsKey",e.EncryptedStorage="SN|EncryptedStorage",e.Note="Note",e.Tag="Tag",e.SmartTag="SN|SmartTag",e.Component="SN|Component",e.Editor="SN|Editor",e.ActionsExtension="Extension",e.UserPrefs="SN|UserPreferences",e.Privileges="SN|Privileges",e.HistorySession="SN|HistorySession",e.Theme="SN|Theme",e.Mfa="SF|MFA",e.ServerExtension="SF|Extension",e.FilesafeCredentials="SN|FileSafe|Credentials",e.FilesafeFileMetadata="SN|FileSafe|FileMetadata",e.FilesafeIntegration="SN|FileSafe|Integration",e.ExtensionRepo="SN|ExtensionRepo"}(r||(r={}))},function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return i})),function(e){e.Uuid="uuid",e.ContentType="content_type",e.ItemsKeyId="items_key_id",e.EncItemKey="enc_item_key",e.Content="content",e.CreatedAt="created_at",e.UpdatedAt="updated_at",e.Deleted="deleted",e.Legacy003AuthHash="auth_hash",e.Legacy003AuthParams="auth_params",e.Dirty="dirty",e.DirtiedDate="dirtiedDate",e.WaitingForKey="waitingForKey",e.ErrorDecrypting="errorDecrypting",e.ErrorDecryptingChanged="errorDecryptingValueChanged",e.LastSyncBegan="lastSyncBegan",e.LastSyncEnd="lastSyncEnd",e.DuplicateOf="duplicate_of"}(i||(i={}))},function(e,t,n){"use strict";var i;function r(e,t){return Number(e)-Number(t)}function s(e,t){return r(e,t)>=0}function a(e,t){return r(e,t)<=0}n.d(t,"a",(function(){return i})),n.d(t,"b",(function(){return r})),n.d(t,"d",(function(){return s})),n.d(t,"c",(function(){return a})),function(e){e.V000Base64Decrypted="000",e.V001="001",e.V002="002",e.V003="003",e.V004="004",e[e.VersionLength=3]="VersionLength"}(i||(i={}))},function(e,t,n){"use strict";(function(e){n.d(t,"c",(function(){return i})),n.d(t,"a",(function(){return r})),n.d(t,"e",(function(){return s})),n.d(t,"d",(function(){return p})),n.d(t,"b",(function(){return y}));var i,r,s,a=n(8),o=n(13),c=n(1),l=n(0),u=n(14),d=n(3),h=n(2);!function(e){e[e.UserInteraction=1]="UserInteraction",e[e.Internal=2]="Internal",e[e.NonDirtying=3]="NonDirtying"}(i||(i={})),function(e){e.Pinned="pinned",e.Archived="archived",e.Locked="locked",e.UserModifiedDate="client_updated_at",e.DefaultEditor="defaultEditor",e.MobileRules="mobileRules",e.NotAvailableOnMobile="notAvailableOnMobile",e.MobileActive="mobileActive",e.LastSize="lastSize",e.PrefersPlainEditor="prefersPlainEditor",e.ComponentInstallError="installError"}(r||(r={})),function(e){e[e.KeepEarliest=1]="KeepEarliest"}(s||(s={}));class p{constructor(t){if(this.protected=!1,this.trashed=!1,this.pinned=!1,this.archived=!1,this.locked=!1,!t.uuid||!t.content_type)throw Error("Cannot create item without both uuid and content_type");if(t.format===a.a.DecryptedBareObject&&(t.enc_item_key||t.items_key_id||t.auth_hash))throw Error("Creating an item from a decrypted payload should not contain enc params");this.payload=t,this.conflictOf=t.safeContent.conflict_of,this.duplicateOf=t.duplicate_of,this.createdAtString=this.created_at&&this.dateToLocalizedString(this.created_at),t.format===a.a.DecryptedBareObject?(this.userModifiedDate=new Date(this.getAppDomainValue(r.UserModifiedDate)||this.updated_at),this.updatedAtString=this.dateToLocalizedString(this.userModifiedDate),this.protected=this.payload.safeContent.protected,this.trashed=this.payload.safeContent.trashed,this.pinned=this.getAppDomainValue(r.Pinned),this.archived=this.getAppDomainValue(r.Archived),this.locked=this.getAppDomainValue(r.Locked)):this.userModifiedDate=this.updated_at,e((()=>{Object(l.h)(this)}))}static DefaultAppDomain(){return d.b}get uuid(){return this.payload.uuid}get content(){return this.payload.content}get version(){if(this.payload.format===a.a.DecryptedBareObject)throw Error("Attempting to access version of decrypted payload");return this.payload.version}get safeContent(){return this.payload.safeContent}get references(){return this.payload.safeContent.references||[]}get deleted(){return this.payload.deleted}get content_type(){return this.payload.content_type}get created_at(){return this.payload.created_at}get updated_at(){return this.payload.updated_at}get dirtiedDate(){return this.payload.dirtiedDate}get dirty(){return this.payload.dirty}get errorDecrypting(){return this.payload.errorDecrypting}get waitingForKey(){return this.payload.waitingForKey}get errorDecryptingValueChanged(){return this.payload.errorDecryptingValueChanged}get lastSyncBegan(){return this.payload.lastSyncBegan}get lastSyncEnd(){return this.payload.lastSyncEnd}get auth_hash(){return this.payload.auth_hash}get auth_params(){return this.payload.auth_params}get duplicate_of(){return this.payload.duplicate_of}payloadRepresentation(e){return Object(c.b)(this.payload,e)}hasRelationshipWithItem(e){var t;return!!(null===(t=this.payload.safeContent.references)||void 0===t?void 0:t.find((t=>t.uuid===e.uuid)))}getDomainData(e){const t=this.payload.safeContent.appData;if(t)return t[e]}getAppDomainValue(e){return this.getDomainData(p.DefaultAppDomain())[e]}contentKeysToIgnoreWhenCheckingEquality(){return["conflict_of"]}appDataContentKeysToIgnoreWhenCheckingEquality(){return[r.UserModifiedDate]}getContentCopy(){return JSON.parse(JSON.stringify(this.content))}get neverSynced(){return!this.updated_at||0===this.updated_at.getTime()}get isSingleton(){return!1}get singletonPredicate(){throw"Must override SNItem.singletonPredicate"}get singletonStrategy(){return s.KeepEarliest}strategyWhenConflictingWithItem(e){if(this.errorDecrypting)return o.a.KeepLeftDuplicateRight;if(this.isSingleton)return o.a.KeepLeft;if(this.deleted)return o.a.KeepRight;if(e.deleted)return this.payload.source===h.a.FileImport?o.a.KeepLeft:o.a.KeepRight;if(!g(this,e))return o.a.KeepRight;if(g(this,e,["references"])){const t=2e4;return e.payload.source===h.a.FileImport||Date.now()-this.userModifiedDate.getTime()<t?o.a.KeepLeftDuplicateRight:o.a.DuplicateLeftKeepRight}return o.a.KeepLeftMergeRefs}isItemContentEqualWith(e){return f(this.payload.contentObject,e.payload.contentObject,this.contentKeysToIgnoreWhenCheckingEquality(),this.appDataContentKeysToIgnoreWhenCheckingEquality())}satisfiesPredicate(e){return u.a.ItemSatisfiesPredicate(this,e)}updatedAtTimestamp(){var e;return null===(e=this.updated_at)||void 0===e?void 0:e.getTime()}dateToLocalizedString(e){if("undefined"!=typeof Intl&&Intl.DateTimeFormat){if(!p.sharedDateFormatter){const e=navigator.languages&&navigator.languages.length?navigator.languages[0]:navigator.language;p.sharedDateFormatter=new Intl.DateTimeFormat(e,{year:"numeric",month:"short",day:"2-digit",weekday:"long",hour:"2-digit",minute:"2-digit"})}return p.sharedDateFormatter.format(e)}return e.toDateString()+" "+e.toLocaleTimeString()}}class y{constructor(e,t){this.item=e,this.type=t,this.payload=e.payload,this.payload.content&&(this.content=Object(l.a)(this.payload.content))}getUuid(){return this.payload.uuid}getItem(){return this.item}getResult(){return this.type===i.NonDirtying?Object(c.b)(this.payload,{content:this.content}):(this.payload.deleted||(this.type===i.UserInteraction?this.userModifiedDate=new Date:this.item.userModifiedDate||(this.userModifiedDate=new Date(this.item.updated_at))),Object(c.b)(this.payload,{content:this.content,dirty:!0,dirtiedDate:new Date}))}mergePayload(e){this.payload=Object(c.g)(this.payload,e),this.payload.content?this.content=Object(l.a)(this.payload.safeContent):this.content=void 0}setContent(e){this.content=Object(l.a)(e)}setDeleted(){this.content=void 0,this.payload=Object(c.b)(this.payload,{content:this.content,deleted:!0})}set lastSyncBegan(e){this.payload=Object(c.b)(this.payload,{content:this.content,lastSyncBegan:e})}set errorDecrypting(e){this.payload=Object(c.b)(this.payload,{content:this.content,errorDecrypting:e})}set updated_at(e){this.payload=Object(c.b)(this.payload,{updated_at:e})}set userModifiedDate(e){this.setAppDataItem(r.UserModifiedDate,e)}set conflictOf(e){this.content.conflict_of=e}set protected(e){this.content.protected=e}set trashed(e){this.content.trashed=e}set pinned(e){this.setAppDataItem(r.Pinned,e)}set archived(e){this.setAppDataItem(r.Archived,e)}set locked(e){this.setAppDataItem(r.Locked,e)}setDomainData(e,t){this.payload.errorDecrypting||(this.content.appData||(this.content.appData={}),this.content.appData[t]=e)}setDomainDataKey(e,t,n){if(this.payload.errorDecrypting)return;this.content.appData||(this.content.appData={});const i=this.content.appData;i[n]||(i[n]={}),i[n][e]=t}setAppDataItem(e,t){this.setDomainDataKey(e,t,p.DefaultAppDomain())}addItemAsRelationship(e){const t=this.content.references||[];t.find((t=>t.uuid===e.uuid))||t.push({uuid:e.uuid,content_type:e.content_type}),this.content.references=t}removeItemAsRelationship(e){let t=this.content.references||[];t=t.filter((t=>t.uuid!==e.uuid)),this.content.references=t}}function g(e,t,n){return n||(n=[]),!f(e.content,t.content,e.contentKeysToIgnoreWhenCheckingEquality().concat(n),e.appDataContentKeysToIgnoreWhenCheckingEquality())}function f(e,t,n,i){if((e=Object(l.G)(e)).appData){const t=e.appData[d.b];Object(l.z)(t,i),t?0===Object.keys(t).length&&delete e.appData:delete e.appData}if(Object(l.z)(e,n),(t=Object(l.G)(t)).appData){const e=t.appData[d.b];Object(l.z)(e,i),e?0===Object.keys(e).length&&delete t.appData:delete t.appData}return Object(l.z)(t,n),JSON.stringify(e)===JSON.stringify(t)}}).call(this,n(76).setImmediate)},function(e,t,n){"use strict";n.d(t,"a",(function(){return s})),n.d(t,"b",(function(){return i})),n.d(t,"f",(function(){return a})),n.d(t,"e",(function(){return o})),n.d(t,"d",(function(){return c})),n.d(t,"c",(function(){return l}));var i,r=n(3);function s(e){return e===r.a.RootKey||e===r.a.ItemsKey||e===r.a.EncryptedStorage}function a(e){return e===i.LocalStorageEncrypted||e===i.LocalStorageDecrypted||e===i.LocalStoragePreferEncrypted}function o(e){return e===i.FileEncrypted||e===i.FileDecrypted||e===i.FilePreferEncrypted}function c(e){return e===i.SyncDecrypted||e===i.LocalStorageDecrypted||e===i.FileDecrypted}function l(e){return e===i.Sync||e===i.LocalStorageEncrypted||e===i.FileEncrypted}!function(e){e[e.Sync=0]="Sync",e[e.SyncDecrypted=1]="SyncDecrypted",e[e.LocalStorageEncrypted=2]="LocalStorageEncrypted",e[e.LocalStorageDecrypted=3]="LocalStorageDecrypted",e[e.LocalStoragePreferEncrypted=4]="LocalStoragePreferEncrypted",e[e.FileEncrypted=5]="FileEncrypted",e[e.FileDecrypted=6]="FileDecrypted",e[e.FilePreferEncrypted=7]="FilePreferEncrypted"}(i||(i={}))},function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return i})),function(e){e[e.EncryptedString=0]="EncryptedString",e[e.DecryptedBareObject=1]="DecryptedBareObject",e[e.DecryptedBase64String=2]="DecryptedBase64String",e[e.Deleted=3]="Deleted"}(i||(i={}))},function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return i})),function(e){e.FullSyncCompleted="sync =full-completed",e.SingleSyncCompleted="sync =single-completed",e.SyncWillBegin="sync =will-begin",e.DownloadFirstSyncCompleted="sync =download-first-completed",e.SyncTakingTooLong="sync =taking-too-long",e.SyncError="sync =error",e.InvalidSession="sync =invalid-session",e.MajorDataChange="major-data-change",e.LocalDataIncrementalLoad="local-data-incremental-load",e.LocalDataLoaded="local-data-loaded",e.EnterOutOfSync="enter-out-of-sync",e.ExitOutOfSync="exit-out-of-sync",e.StatusChanged="status-changed",e.DatabaseWriteError="database-write-error",e.DatabaseReadError="database-read-error"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"b",(function(){return r})),n.d(t,"a",(function(){return s}));var i=n(3);function r(e){return e.map((e=>e.uuid))}function s(e){return e.references||(e.references=[]),e.appData||(e.appData={}),e.appData[i.b]||(e.appData[i.b]={}),e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return r}));var i=n(0);class r{constructor(){this.eventObservers=[],this.loggingEnabled=!1,this.criticalPromises=[]}addEventObserver(e){return this.eventObservers.push(e),()=>{Object(i.C)(this.eventObservers,e)}}async notifyEvent(e,t){for(const n of this.eventObservers)await n(e,t||{})}async blockDeinit(){await Promise.all(this.criticalPromises)}deinit(){this.eventObservers.length=0,this.deviceInterface=void 0}async executeCriticalFunction(e){const t=e();return this.criticalPromises.push(t),t}async handleApplicationStage(e){}log(e){for(var t=arguments.length,n=new Array(t>1?t-1:0),i=1;i<t;i++)n[i-1]=arguments[i];if(this.loggingEnabled){const t=new Date,i=t.toLocaleTimeString().replace(" PM","").replace(" AM",""),r="".concat(i,".").concat(t.getMilliseconds());n?(n=n.map((e=>Array.isArray(e)?e.slice():e)),console.log(r,e,...n)):console.log(r,e)}}}},function(e,t,n){"use strict";n.d(t,"a",(function(){return i})),n.d(t,"c",(function(){return s}));var i,r=n(9);function s(e){return{[r.a.FullSyncCompleted]:i.CompletedFullSync,[r.a.SingleSyncCompleted]:i.CompletedIncrementalSync,[r.a.SyncError]:i.FailedSync,[r.a.SyncTakingTooLong]:i.HighLatencySync,[r.a.EnterOutOfSync]:i.EnteredOutOfSync,[r.a.ExitOutOfSync]:i.ExitedOutOfSync,[r.a.LocalDataLoaded]:i.LocalDataLoaded,[r.a.MajorDataChange]:i.MajorDataChange,[r.a.LocalDataIncrementalLoad]:i.LocalDataIncrementalLoad,[r.a.StatusChanged]:i.SyncStatusChanged,[r.a.SyncWillBegin]:i.WillSync,[r.a.InvalidSession]:i.InvalidSyncSession,[r.a.DatabaseReadError]:i.LocalDatabaseReadError,[r.a.DatabaseWriteError]:i.LocalDatabaseWriteError}[e]}n.d(t,"b",(function(){return r.a})),function(e){e[e.SignedIn=2]="SignedIn",e[e.SignedOut=3]="SignedOut",e[e.CompletedFullSync=5]="CompletedFullSync",e[e.FailedSync=6]="FailedSync",e[e.HighLatencySync=7]="HighLatencySync",e[e.EnteredOutOfSync=8]="EnteredOutOfSync",e[e.ExitedOutOfSync=9]="ExitedOutOfSync",e[e.StorageReady=24]="StorageReady",e[e.Started=10]="Started",e[e.MigrationsLoaded=23]="MigrationsLoaded",e[e.Launched=11]="Launched",e[e.LocalDataLoaded=12]="LocalDataLoaded",e[e.KeyStatusChanged=13]="KeyStatusChanged",e[e.MajorDataChange=14]="MajorDataChange",e[e.CompletedRestart=15]="CompletedRestart",e[e.LocalDataIncrementalLoad=16]="LocalDataIncrementalLoad",e[e.SyncStatusChanged=17]="SyncStatusChanged",e[e.WillSync=18]="WillSync",e[e.InvalidSyncSession=19]="InvalidSyncSession",e[e.LocalDatabaseReadError=20]="LocalDatabaseReadError",e[e.LocalDatabaseWriteError=21]="LocalDatabaseWriteError",e[e.CompletedIncrementalSync=22]="CompletedIncrementalSync"}(i||(i={}))},function(e,t,n){"use strict";var i;n.d(t,"a",(function(){return i})),function(e){e[e.KeepLeft=1]="KeepLeft",e[e.KeepRight=2]="KeepRight",e[e.KeepLeftDuplicateRight=3]="KeepLeftDuplicateRight",e[e.DuplicateLeftKeepRight=4]="DuplicateLeftKeepRight",e[e.KeepLeftMergeRefs=5]="KeepLeftMergeRefs"}(i||(i={}))},function(e,t,n){"use strict";n.d(t,"a",(function(){return s}));var i=n(0);function r(e){return e instanceof s?e:Array.isArray(e)?s.FromArray(e):s.FromJson(e)}class s{constructor(e,t,n){if(this.keypath=e,this.operator=t,this.value=n,this.isRecursive()){const e=this.value;this.value=e.map((e=>r(e)))}else"true"!==this.value&&"false"!==this.value||(this.value=JSON.parse(this.value))}static FromJson(e){return new s(e.keypath,e.operator,e.value)}static FromArray(e){return new s(e[0],e[1],e[2])}isRecursive(){return["and","or"].includes(this.operator)}arrayRepresentation(){return[this.keypath,this.operator,this.value]}valueAsArray(){return this.value}keypathIncludesVerb(e){if(this.isRecursive()){for(const t of this.value)if(t.keypathIncludesVerb(e))return!0;return!1}return this.keypath.includes(e)}static CompoundPredicate(e){return new s("ignored","and",e)}static ObjectSatisfiesPredicate(e,t){if((t=r(t)).isRecursive()){if("and"===t.operator){for(const n of t.valueAsArray())if(!this.ObjectSatisfiesPredicate(e,n))return!1;return!0}if("or"===t.operator){for(const n of t.valueAsArray())if(this.ObjectSatisfiesPredicate(e,n))return!0;return!1}}let n=t.value;if("string"==typeof n&&n.includes(".ago")&&(n=this.DateFromString(n)),"not"===t.operator)return!this.ObjectSatisfiesPredicate(e,n);const i=t.keypath.split(".").reduce(((e,t)=>e&&e[t]),e),s=[!1,"",null,void 0,NaN];return void 0===i?"!="===t.operator?!s.includes(t.value):s.includes(t.value):"="===t.operator?Array.isArray(i)?JSON.stringify(i)===JSON.stringify(n):i===n:"!="===t.operator?Array.isArray(i)?JSON.stringify(i)!==JSON.stringify(n):i!==n:"<"===t.operator?i<n:">"===t.operator?i>n:"<="===t.operator?i<=n:">="===t.operator?i>=n:"startsWith"===t.operator?i.startsWith(n):"in"===t.operator?-1!==n.indexOf(i):"includes"===t.operator?this.resolveIncludesPredicate(i,n):"matches"===t.operator&&new RegExp(n).test(i)}static resolveIncludesPredicate(e,t){if(Object(i.t)(t))return e.includes(t);{let n;n=Array.isArray(t)?s.FromArray(t):t;for(const t of e)if(this.ObjectSatisfiesPredicate(t,n))return!0;return!1}}static ItemSatisfiesPredicate(e,t){return this.ObjectSatisfiesPredicate(e,t)}static ItemSatisfiesPredicates(e,t){for(const n of t)if(!this.ItemSatisfiesPredicate(e,n))return!1;return!0}static DateFromString(e){const t=e.split("."),n=t[1],i=new Date,r=parseInt(t[0]);return"days"===n?i.setDate(i.getDate()-r):"hours"===n&&i.setHours(i.getHours()-r),i}}},function(e,t,n){"use strict";var i=Array.isArray;e.exports=i},function(e,t,n){"use strict";var i=n(55),r="object"==typeof self&&self&&self.Object===Object&&self,s=i||r||Function("return this")();e.exports=s},function(e,t,n){"use strict";var i=n(155)(n(156));e.exports=i},function(e,t,n){"use strict";e.exports=function(e){var t=typeof e;return null!=e&&("object"==t||"function"==t)}},function(e,t,n){"use strict";var i=n(37),r=n(150);e.exports=function(e,t){var n=[];if(!e||!e.length)return n;var s=-1,a=[],o=e.length;for(t=i(t,3);++s<o;){var c=e[s];t(c,s,e)&&(n.push(c),a.push(s))}return r(e,a),n}},function(e,t,n){"use strict";var i=n(92),r=n(97);e.exports=function(e,t){var n=r(e,t);return i(n)?n:void 0}},function(e,t,n){"use strict";e.exports=function(e){return null!=e&&"object"==typeof e}},function(e,t,n){"use strict";n.d(t,"a",(function(){return l}));var i=n(10),r=n(4),s=n(2),a=n(5),o=n(0),c=n(8);class l{constructor(e,t,n){if(this.fields=t||Object.keys(e),this.source=n||s.a.Constructor,this.uuid=e.uuid,!this.uuid&&this.fields.includes(r.a.Uuid))throw Error("uuid is null, yet this payloads fields indicate it shouldnt be. Content type: ".concat(e.content_type));this.content_type=e.content_type,e.content&&(Object(o.r)(e.content)?this.content=Object(i.a)(e.content):this.content=e.content),this.deleted=e.deleted,this.items_key_id=e.items_key_id,this.enc_item_key=e.enc_item_key,this.created_at=new Date(e.created_at||new Date),this.updated_at=new Date(e.updated_at||new Date(0)),e.dirtiedDate&&(this.dirtiedDate=new Date(e.dirtiedDate)),this.dirty=e.dirty,this.errorDecrypting=e.errorDecrypting,this.waitingForKey=e.waitingForKey,this.errorDecryptingValueChanged=e.errorDecryptingValueChanged,this.lastSyncBegan=e.lastSyncBegan?new Date(e.lastSyncBegan):void 0,this.lastSyncEnd=e.lastSyncEnd?new Date(e.lastSyncEnd):void 0,this.auth_hash=e.auth_hash,this.auth_params=e.auth_params,this.duplicate_of=e.duplicate_of,Object(o.t)(this.content)?this.content.startsWith(a.a.V000Base64Decrypted)?this.format=c.a.DecryptedBase64String:this.format=c.a.EncryptedString:Object(o.r)(this.content)?this.format=c.a.DecryptedBareObject:this.format=c.a.Deleted,Object(o.t)(this.content)?this.version=this.content.substring(0,a.a.VersionLength):this.content&&(this.version=this.content.version),Object(o.h)(this)}ejected(){const e=[r.a.Legacy003AuthHash,r.a.Deleted],t=[r.a.DirtiedDate,r.a.ErrorDecrypting,r.a.ErrorDecryptingChanged,r.a.WaitingForKey,r.a.LastSyncBegan,r.a.LastSyncEnd],n={};for(const i of this.fields){if(t.includes(i))continue;const r=this[i];Object(o.q)(r)&&e.includes(i)||(n[i]=r)}return n}get safeContent(){return this.format===c.a.DecryptedBareObject?this.content:{}}get references(){return this.safeReferences}get safeReferences(){return this.safeContent.references||[]}get contentObject(){if(this.format!==c.a.DecryptedBareObject)throw Error("Attempting to access non-object content as object");return this.content}get contentString(){if(this.format===c.a.DecryptedBareObject)throw Error("Attempting to access non-string content as string");return this.content}get discardable(){return this.deleted&&!this.dirty}}},function(e,t,n){"use strict";var i=n(75);e.exports=function(e){return e&&e.length?i(e):[]}},function(e,t,n){"use strict";var i=n(31),r=n(93),s=n(94),a=i?i.toStringTag:void 0;e.exports=function(e){return null==e?void 0===e?"[object Undefined]":"[object Null]":a&&a in Object(e)?r(e):s(e)}},function(e,t,n){"use strict";e.exports=function(e,t){return e===t||e!=e&&t!=t}},function(e,t,n){"use strict";var i=n(40),r=n(48);e.exports=function(e){return null!=e&&r(e.length)&&!i(e)}},function(e,t,n){"use strict";var i=n(35);e.exports=function(e){if("string"==typeof e||i(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}},function(e,t,n){"use strict";var i;i=function(){return this}();try{i=i||new Function("return this")()}catch(e){"object"==typeof window&&(i=window)}e.exports=i},function(e,t,n){"use strict";var i=n(82),r=n(83),s=n(84),a=n(85),o=n(86);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}c.prototype.clear=i,c.prototype.delete=r,c.prototype.get=s,c.prototype.has=a,c.prototype.set=o,e.exports=c},function(e,t,n){"use strict";var i=n(25);e.exports=function(e,t){for(var n=e.length;n--;)if(i(e[n][0],t))return n;return-1}},function(e,t,n){"use strict";var i=n(16).Symbol;e.exports=i},function(e,t,n){"use strict";var i=n(20)(Object,"create");e.exports=i},function(e,t,n){"use strict";var i=n(106);e.exports=function(e,t){var n=e.__data__;return i(t)?n["string"==typeof t?"string":"hash"]:n.map}},function(e,t,n){"use strict";var i=/^(?:0|[1-9]\d*)$/;e.exports=function(e,t){var n=typeof e;return!!(t=null==t?9007199254740991:t)&&("number"==n||"symbol"!=n&&i.test(e))&&e>-1&&e%1==0&&e<t}},function(e,t,n){"use strict";var i=n(24),r=n(21);e.exports=function(e){return"symbol"==typeof e||r(e)&&"[object Symbol]"==i(e)}},function(e,t,n){"use strict";var i=n(68),r=n(74)((function(e,t,n){i(e,t,n)}));e.exports=r},function(e,t,n){"use strict";var i=n(80),r=n(136),s=n(53),a=n(15),o=n(147);e.exports=function(e){return"function"==typeof e?e:null==e?s:"object"==typeof e?a(e)?r(e[0],e[1]):i(e):o(e)}},function(e,t,n){"use strict";var i=n(29),r=n(87),s=n(88),a=n(89),o=n(90),c=n(91);function l(e){var t=this.__data__=new i(e);this.size=t.size}l.prototype.clear=r,l.prototype.delete=s,l.prototype.get=a,l.prototype.has=o,l.prototype.set=c,e.exports=l},function(e,t,n){"use strict";var i=n(20)(n(16),"Map");e.exports=i},function(e,t,n){"use strict";var i=n(24),r=n(18);e.exports=function(e){if(!r(e))return!1;var t=i(e);return"[object Function]"==t||"[object GeneratorFunction]"==t||"[object AsyncFunction]"==t||"[object Proxy]"==t}},function(e,t,n){"use strict";var i=n(98),r=n(105),s=n(107),a=n(108),o=n(109);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}c.prototype.clear=i,c.prototype.delete=r,c.prototype.get=s,c.prototype.has=a,c.prototype.set=o,e.exports=c},function(e,t,n){"use strict";e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e){n[++t]=e})),n}},function(e,t,n){"use strict";var i=n(62),r=n(129),s=n(26);e.exports=function(e){return s(e)?i(e):r(e)}},function(e,t,n){"use strict";var i=n(124),r=n(21),s=Object.prototype,a=s.hasOwnProperty,o=s.propertyIsEnumerable,c=i(function(){return arguments}())?i:function(e){return r(e)&&a.call(e,"callee")&&!o.call(e,"callee")};e.exports=c},function(e,t,n){"use strict";(function(e){var i=n(16),r=n(125),s=t&&!t.nodeType&&t,a=s&&"object"==typeof e&&e&&!e.nodeType&&e,o=a&&a.exports===s?i.Buffer:void 0,c=(o?o.isBuffer:void 0)||r;e.exports=c}).call(this,n(46)(e))},function(e,t,n){"use strict";e.exports=function(e){return e.webpackPolyfill||(e.deprecate=function(){},e.paths=[],e.children||(e.children=[]),Object.defineProperty(e,"loaded",{enumerable:!0,get:function(){return e.l}}),Object.defineProperty(e,"id",{enumerable:!0,get:function(){return e.i}}),e.webpackPolyfill=1),e}},function(e,t,n){"use strict";var i=n(126),r=n(127),s=n(128),a=s&&s.isTypedArray,o=a?r(a):i;e.exports=o},function(e,t,n){"use strict";e.exports=function(e){return"number"==typeof e&&e>-1&&e%1==0&&e<=9007199254740991}},function(e,t,n){"use strict";var i=Object.prototype;e.exports=function(e){var t=e&&e.constructor;return e===("function"==typeof t&&t.prototype||i)}},function(e,t,n){"use strict";var i=n(51),r=n(27);e.exports=function(e,t){for(var n=0,s=(t=i(t,e)).length;null!=e&&n<s;)e=e[r(t[n++])];return n&&n==s?e:void 0}},function(e,t,n){"use strict";var i=n(15),r=n(52),s=n(138),a=n(141);e.exports=function(e,t){return i(e)?e:r(e,t)?[e]:s(a(e))}},function(e,t,n){"use strict";var i=n(15),r=n(35),s=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,a=/^\w*$/;e.exports=function(e,t){if(i(e))return!1;var n=typeof e;return!("number"!=n&&"symbol"!=n&&"boolean"!=n&&null!=e&&!r(e))||a.test(e)||!s.test(e)||null!=t&&e in Object(t)}},function(e,t,n){"use strict";e.exports=function(e){return e}},function(e,t,n){"use strict";var i=n(70);e.exports=function(e,t,n){"__proto__"==t&&i?i(e,t,{configurable:!0,enumerable:!0,value:n,writable:!0}):e[t]=n}},function(e,t,n){"use strict";(function(t){var n="object"==typeof t&&t&&t.Object===Object&&t;e.exports=n}).call(this,n(28))},function(e,t,n){"use strict";var i=Function.prototype.toString;e.exports=function(e){if(null!=e){try{return i.call(e)}catch(e){}try{return e+""}catch(e){}}return""}},function(e,t,n){"use strict";var i=n(110),r=n(21);e.exports=function e(t,n,s,a,o){return t===n||(null==t||null==n||!r(t)&&!r(n)?t!=t&&n!=n:i(t,n,s,a,e,o))}},function(e,t,n){"use strict";var i=n(59),r=n(113),s=n(60);e.exports=function(e,t,n,a,o,c){var l=1&n,u=e.length,d=t.length;if(u!=d&&!(l&&d>u))return!1;var h=c.get(e);if(h&&c.get(t))return h==t;var p=-1,y=!0,g=2&n?new i:void 0;for(c.set(e,t),c.set(t,e);++p<u;){var f=e[p],m=t[p];if(a)var v=l?a(m,f,p,t,e,c):a(f,m,p,e,t,c);if(void 0!==v){if(v)continue;y=!1;break}if(g){if(!r(t,(function(e,t){if(!s(g,t)&&(f===e||o(f,e,n,a,c)))return g.push(t)}))){y=!1;break}}else if(f!==m&&!o(f,m,n,a,c)){y=!1;break}}return c.delete(e),c.delete(t),y}},function(e,t,n){"use strict";var i=n(41),r=n(111),s=n(112);function a(e){var t=-1,n=null==e?0:e.length;for(this.__data__=new i;++t<n;)this.add(e[t])}a.prototype.add=a.prototype.push=r,a.prototype.has=s,e.exports=a},function(e,t,n){"use strict";e.exports=function(e,t){return e.has(t)}},function(e,t,n){"use strict";var i=n(16).Uint8Array;e.exports=i},function(e,t,n){"use strict";var i=n(123),r=n(44),s=n(15),a=n(45),o=n(34),c=n(47),l=Object.prototype.hasOwnProperty;e.exports=function(e,t){var n=s(e),u=!n&&r(e),d=!n&&!u&&a(e),h=!n&&!u&&!d&&c(e),p=n||u||d||h,y=p?i(e.length,String):[],g=y.length;for(var f in e)!t&&!l.call(e,f)||p&&("length"==f||d&&("offset"==f||"parent"==f)||h&&("buffer"==f||"byteLength"==f||"byteOffset"==f)||o(f,g))||y.push(f);return y}},function(e,t,n){"use strict";e.exports=function(e,t){return function(n){return e(t(n))}}},function(e,t,n){"use strict";var i=n(20)(n(16),"Set");e.exports=i},function(e,t,n){"use strict";var i=n(18);e.exports=function(e){return e==e&&!i(e)}},function(e,t,n){"use strict";e.exports=function(e,t){return function(n){return null!=n&&n[e]===t&&(void 0!==t||e in Object(n))}}},function(e,t,n){"use strict";e.exports=function(e,t,n,i){for(var r=e.length,s=n+(i?1:-1);i?s--:++s<r;)if(t(e[s],s,e))return s;return-1}},function(e,t,n){"use strict";var i=n(38),r=n(69),s=n(160),a=n(162),o=n(18),c=n(73),l=n(72);e.exports=function e(t,n,u,d,h){t!==n&&s(n,(function(s,c){if(h||(h=new i),o(s))a(t,n,c,u,e,d,h);else{var p=d?d(l(t,c),s,c+"",t,n,h):void 0;void 0===p&&(p=s),r(t,c,p)}}),c)}},function(e,t,n){"use strict";var i=n(54),r=n(25);e.exports=function(e,t,n){(void 0!==n&&!r(e[t],n)||void 0===n&&!(t in e))&&i(e,t,n)}},function(e,t,n){"use strict";var i=n(20),r=function(){try{var e=i(Object,"defineProperty");return e({},"",{}),e}catch(e){}}();e.exports=r},function(e,t,n){"use strict";var i=n(63)(Object.getPrototypeOf,Object);e.exports=i},function(e,t,n){"use strict";e.exports=function(e,t){if(("constructor"!==t||"function"!=typeof e[t])&&"__proto__"!=t)return e[t]}},function(e,t,n){"use strict";var i=n(62),r=n(174),s=n(26);e.exports=function(e){return s(e)?i(e,!0):r(e)}},function(e,t,n){"use strict";var i=n(176),r=n(183);e.exports=function(e){return i((function(t,n){var i=-1,s=n.length,a=s>1?n[s-1]:void 0,o=s>2?n[2]:void 0;for(a=e.length>3&&"function"==typeof a?(s--,a):void 0,o&&r(n[0],n[1],o)&&(a=s<3?void 0:a,s=1),t=Object(t);++i<s;){var c=n[i];c&&e(t,c,i,a)}return t}))}},function(e,t,n){"use strict";var i=n(59),r=n(184),s=n(188),a=n(60),o=n(189),c=n(42);e.exports=function(e,t,n){var l=-1,u=r,d=e.length,h=!0,p=[],y=p;if(n)h=!1,u=s;else if(d>=200){var g=t?null:o(e);if(g)return c(g);h=!1,u=a,y=new i}else y=t?[]:p;e:for(;++l<d;){var f=e[l],m=t?t(f):f;if(f=n||0!==f?f:0,h&&m==m){for(var v=y.length;v--;)if(y[v]===m)continue e;t&&y.push(m),p.push(f)}else u(y,m,n)||(y!==p&&y.push(m),p.push(f))}return p}},function(e,t,n){"use strict";(function(e){var i=void 0!==e&&e||"undefined"!=typeof self&&self||window,r=Function.prototype.apply;function s(e,t){this._id=e,this._clearFn=t}t.setTimeout=function(){return new s(r.call(setTimeout,i,arguments),clearTimeout)},t.setInterval=function(){return new s(r.call(setInterval,i,arguments),clearInterval)},t.clearTimeout=t.clearInterval=function(e){e&&e.close()},s.prototype.unref=s.prototype.ref=function(){},s.prototype.close=function(){this._clearFn.call(i,this._id)},t.enroll=function(e,t){clearTimeout(e._idleTimeoutId),e._idleTimeout=t},t.unenroll=function(e){clearTimeout(e._idleTimeoutId),e._idleTimeout=-1},t._unrefActive=t.active=function(e){clearTimeout(e._idleTimeoutId);var t=e._idleTimeout;t>=0&&(e._idleTimeoutId=setTimeout((function(){e._onTimeout&&e._onTimeout()}),t))},n(191),t.setImmediate="undefined"!=typeof self&&self.setImmediate||void 0!==e&&e.setImmediate||this&&this.setImmediate,t.clearImmediate="undefined"!=typeof self&&self.clearImmediate||void 0!==e&&e.clearImmediate||this&&this.clearImmediate}).call(this,n(28))},function(e,t,n){"use strict";(function(e){n.d(t,"a",(function(){return s}));var i=n(11),r=n(12);class s extends i.a{constructor(t){super(),this.application=t,e((()=>{this.addAppEventObserver()}))}deinit(){this.application=void 0,this.unsubApp(),this.unsubApp=void 0,super.deinit()}addAppEventObserver(){this.application.isStarted()&&this.onAppStart(),this.application.isLaunched()&&this.onAppLaunch(),this.unsubApp=this.application.addEventObserver((async e=>{await this.onAppEvent(e),e===r.a.Started?this.onAppStart():e===r.a.Launched?this.onAppLaunch():e===r.a.CompletedFullSync?this.onAppFullSync():e===r.a.CompletedIncrementalSync?this.onAppIncrementalSync():e===r.a.KeyStatusChanged&&this.onAppKeyChange()}))}async onAppEvent(e){}async onAppStart(){}async onAppLaunch(){}async onAppKeyChange(){}onAppIncrementalSync(){}onAppFullSync(){}}}).call(this,n(76).setImmediate)},function(e,t,n){"use strict";var i=n(68),r=n(74)((function(e,t,n,r){i(e,t,n,r)}));e.exports=r},function(e,t,n){"use strict";var i=n(75);e.exports=function(e,t){return t="function"==typeof t?t:void 0,e&&e.length?i(e,void 0,t):[]}},function(e,t,n){"use strict";var i=n(81),r=n(135),s=n(66);e.exports=function(e){var t=r(e);return 1==t.length&&t[0][2]?s(t[0][0],t[0][1]):function(n){return n===e||i(n,e,t)}}},function(e,t,n){"use strict";var i=n(38),r=n(57);e.exports=function(e,t,n,s){var a=n.length,o=a,c=!s;if(null==e)return!o;for(e=Object(e);a--;){var l=n[a];if(c&&l[2]?l[1]!==e[l[0]]:!(l[0]in e))return!1}for(;++a<o;){var u=(l=n[a])[0],d=e[u],h=l[1];if(c&&l[2]){if(void 0===d&&!(u in e))return!1}else{var p=new i;if(s)var y=s(d,h,u,e,t,p);if(!(void 0===y?r(h,d,3,s,p):y))return!1}}return!0}},function(e,t,n){"use strict";e.exports=function(){this.__data__=[],this.size=0}},function(e,t,n){"use strict";var i=n(30),r=Array.prototype.splice;e.exports=function(e){var t=this.__data__,n=i(t,e);return!(n<0||(n==t.length-1?t.pop():r.call(t,n,1),--this.size,0))}},function(e,t,n){"use strict";var i=n(30);e.exports=function(e){var t=this.__data__,n=i(t,e);return n<0?void 0:t[n][1]}},function(e,t,n){"use strict";var i=n(30);e.exports=function(e){return i(this.__data__,e)>-1}},function(e,t,n){"use strict";var i=n(30);e.exports=function(e,t){var n=this.__data__,r=i(n,e);return r<0?(++this.size,n.push([e,t])):n[r][1]=t,this}},function(e,t,n){"use strict";var i=n(29);e.exports=function(){this.__data__=new i,this.size=0}},function(e,t,n){"use strict";e.exports=function(e){var t=this.__data__,n=t.delete(e);return this.size=t.size,n}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.get(e)}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){"use strict";var i=n(29),r=n(39),s=n(41);e.exports=function(e,t){var n=this.__data__;if(n instanceof i){var a=n.__data__;if(!r||a.length<199)return a.push([e,t]),this.size=++n.size,this;n=this.__data__=new s(a)}return n.set(e,t),this.size=n.size,this}},function(e,t,n){"use strict";var i=n(40),r=n(95),s=n(18),a=n(56),o=/^\[object .+?Constructor\]$/,c=Function.prototype,l=Object.prototype,u=c.toString,d=l.hasOwnProperty,h=RegExp("^"+u.call(d).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");e.exports=function(e){return!(!s(e)||r(e))&&(i(e)?h:o).test(a(e))}},function(e,t,n){"use strict";var i=n(31),r=Object.prototype,s=r.hasOwnProperty,a=r.toString,o=i?i.toStringTag:void 0;e.exports=function(e){var t=s.call(e,o),n=e[o];try{e[o]=void 0;var i=!0}catch(e){}var r=a.call(e);return i&&(t?e[o]=n:delete e[o]),r}},function(e,t,n){"use strict";var i=Object.prototype.toString;e.exports=function(e){return i.call(e)}},function(e,t,n){"use strict";var i,r=n(96),s=(i=/[^.]+$/.exec(r&&r.keys&&r.keys.IE_PROTO||""))?"Symbol(src)_1."+i:"";e.exports=function(e){return!!s&&s in e}},function(e,t,n){"use strict";var i=n(16)["__core-js_shared__"];e.exports=i},function(e,t,n){"use strict";e.exports=function(e,t){return null==e?void 0:e[t]}},function(e,t,n){"use strict";var i=n(99),r=n(29),s=n(39);e.exports=function(){this.size=0,this.__data__={hash:new i,map:new(s||r),string:new i}}},function(e,t,n){"use strict";var i=n(100),r=n(101),s=n(102),a=n(103),o=n(104);function c(e){var t=-1,n=null==e?0:e.length;for(this.clear();++t<n;){var i=e[t];this.set(i[0],i[1])}}c.prototype.clear=i,c.prototype.delete=r,c.prototype.get=s,c.prototype.has=a,c.prototype.set=o,e.exports=c},function(e,t,n){"use strict";var i=n(32);e.exports=function(){this.__data__=i?i(null):{},this.size=0}},function(e,t,n){"use strict";e.exports=function(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}},function(e,t,n){"use strict";var i=n(32),r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;if(i){var n=t[e];return"__lodash_hash_undefined__"===n?void 0:n}return r.call(t,e)?t[e]:void 0}},function(e,t,n){"use strict";var i=n(32),r=Object.prototype.hasOwnProperty;e.exports=function(e){var t=this.__data__;return i?void 0!==t[e]:r.call(t,e)}},function(e,t,n){"use strict";var i=n(32);e.exports=function(e,t){var n=this.__data__;return this.size+=this.has(e)?0:1,n[e]=i&&void 0===t?"__lodash_hash_undefined__":t,this}},function(e,t,n){"use strict";var i=n(33);e.exports=function(e){var t=i(this,e).delete(e);return this.size-=t?1:0,t}},function(e,t,n){"use strict";e.exports=function(e){var t=typeof e;return"string"==t||"number"==t||"symbol"==t||"boolean"==t?"__proto__"!==e:null===e}},function(e,t,n){"use strict";var i=n(33);e.exports=function(e){return i(this,e).get(e)}},function(e,t,n){"use strict";var i=n(33);e.exports=function(e){return i(this,e).has(e)}},function(e,t,n){"use strict";var i=n(33);e.exports=function(e,t){var n=i(this,e),r=n.size;return n.set(e,t),this.size+=n.size==r?0:1,this}},function(e,t,n){"use strict";var i=n(38),r=n(58),s=n(114),a=n(116),o=n(131),c=n(15),l=n(45),u=n(47),d="[object Arguments]",h="[object Array]",p="[object Object]",y=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,g,f,m){var v=c(e),w=c(t),S=v?h:o(e),b=w?h:o(t),P=(S=S==d?p:S)==p,O=(b=b==d?p:b)==p,D=S==b;if(D&&l(e)){if(!l(t))return!1;v=!0,P=!1}if(D&&!P)return m||(m=new i),v||u(e)?r(e,t,n,g,f,m):s(e,t,S,n,g,f,m);if(!(1&n)){var C=P&&y.call(e,"__wrapped__"),I=O&&y.call(t,"__wrapped__");if(C||I){var M=C?e.value():e,j=I?t.value():t;return m||(m=new i),f(M,j,n,g,m)}}return!!D&&(m||(m=new i),a(e,t,n,g,f,m))}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.set(e,"__lodash_hash_undefined__"),this}},function(e,t,n){"use strict";e.exports=function(e){return this.__data__.has(e)}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,i=null==e?0:e.length;++n<i;)if(t(e[n],n,e))return!0;return!1}},function(e,t,n){"use strict";var i=n(31),r=n(61),s=n(25),a=n(58),o=n(115),c=n(42),l=i?i.prototype:void 0,u=l?l.valueOf:void 0;e.exports=function(e,t,n,i,l,d,h){switch(n){case"[object DataView]":if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case"[object ArrayBuffer]":return!(e.byteLength!=t.byteLength||!d(new r(e),new r(t)));case"[object Boolean]":case"[object Date]":case"[object Number]":return s(+e,+t);case"[object Error]":return e.name==t.name&&e.message==t.message;case"[object RegExp]":case"[object String]":return e==t+"";case"[object Map]":var p=o;case"[object Set]":var y=1&i;if(p||(p=c),e.size!=t.size&&!y)return!1;var g=h.get(e);if(g)return g==t;i|=2,h.set(e,t);var f=a(p(e),p(t),i,l,d,h);return h.delete(e),f;case"[object Symbol]":if(u)return u.call(e)==u.call(t)}return!1}},function(e,t,n){"use strict";e.exports=function(e){var t=-1,n=Array(e.size);return e.forEach((function(e,i){n[++t]=[i,e]})),n}},function(e,t,n){"use strict";var i=n(117),r=Object.prototype.hasOwnProperty;e.exports=function(e,t,n,s,a,o){var c=1&n,l=i(e),u=l.length;if(u!=i(t).length&&!c)return!1;for(var d=u;d--;){var h=l[d];if(!(c?h in t:r.call(t,h)))return!1}var p=o.get(e);if(p&&o.get(t))return p==t;var y=!0;o.set(e,t),o.set(t,e);for(var g=c;++d<u;){var f=e[h=l[d]],m=t[h];if(s)var v=c?s(m,f,h,t,e,o):s(f,m,h,e,t,o);if(!(void 0===v?f===m||a(f,m,n,s,o):v)){y=!1;break}g||(g="constructor"==h)}if(y&&!g){var w=e.constructor,S=t.constructor;w==S||!("constructor"in e)||!("constructor"in t)||"function"==typeof w&&w instanceof w&&"function"==typeof S&&S instanceof S||(y=!1)}return o.delete(e),o.delete(t),y}},function(e,t,n){"use strict";var i=n(118),r=n(120),s=n(43);e.exports=function(e){return i(e,s,r)}},function(e,t,n){"use strict";var i=n(119),r=n(15);e.exports=function(e,t,n){var s=t(e);return r(e)?s:i(s,n(e))}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,i=t.length,r=e.length;++n<i;)e[r+n]=t[n];return e}},function(e,t,n){"use strict";var i=n(121),r=n(122),s=Object.prototype.propertyIsEnumerable,a=Object.getOwnPropertySymbols,o=a?function(e){return null==e?[]:(e=Object(e),i(a(e),(function(t){return s.call(e,t)})))}:r;e.exports=o},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,i=null==e?0:e.length,r=0,s=[];++n<i;){var a=e[n];t(a,n,e)&&(s[r++]=a)}return s}},function(e,t,n){"use strict";e.exports=function(){return[]}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,i=Array(e);++n<e;)i[n]=t(n);return i}},function(e,t,n){"use strict";var i=n(24),r=n(21);e.exports=function(e){return r(e)&&"[object Arguments]"==i(e)}},function(e,t,n){"use strict";e.exports=function(){return!1}},function(e,t,n){"use strict";var i=n(24),r=n(48),s=n(21),a={};a["[object Float32Array]"]=a["[object Float64Array]"]=a["[object Int8Array]"]=a["[object Int16Array]"]=a["[object Int32Array]"]=a["[object Uint8Array]"]=a["[object Uint8ClampedArray]"]=a["[object Uint16Array]"]=a["[object Uint32Array]"]=!0,a["[object Arguments]"]=a["[object Array]"]=a["[object ArrayBuffer]"]=a["[object Boolean]"]=a["[object DataView]"]=a["[object Date]"]=a["[object Error]"]=a["[object Function]"]=a["[object Map]"]=a["[object Number]"]=a["[object Object]"]=a["[object RegExp]"]=a["[object Set]"]=a["[object String]"]=a["[object WeakMap]"]=!1,e.exports=function(e){return s(e)&&r(e.length)&&!!a[i(e)]}},function(e,t,n){"use strict";e.exports=function(e){return function(t){return e(t)}}},function(e,t,n){"use strict";(function(e){var i=n(55),r=t&&!t.nodeType&&t,s=r&&"object"==typeof e&&e&&!e.nodeType&&e,a=s&&s.exports===r&&i.process,o=function(){try{return s&&s.require&&s.require("util").types||a&&a.binding&&a.binding("util")}catch(e){}}();e.exports=o}).call(this,n(46)(e))},function(e,t,n){"use strict";var i=n(49),r=n(130),s=Object.prototype.hasOwnProperty;e.exports=function(e){if(!i(e))return r(e);var t=[];for(var n in Object(e))s.call(e,n)&&"constructor"!=n&&t.push(n);return t}},function(e,t,n){"use strict";var i=n(63)(Object.keys,Object);e.exports=i},function(e,t,n){"use strict";var i=n(132),r=n(39),s=n(133),a=n(64),o=n(134),c=n(24),l=n(56),u="[object Map]",d="[object Promise]",h="[object Set]",p="[object WeakMap]",y="[object DataView]",g=l(i),f=l(r),m=l(s),v=l(a),w=l(o),S=c;(i&&S(new i(new ArrayBuffer(1)))!=y||r&&S(new r)!=u||s&&S(s.resolve())!=d||a&&S(new a)!=h||o&&S(new o)!=p)&&(S=function(e){var t=c(e),n="[object Object]"==t?e.constructor:void 0,i=n?l(n):"";if(i)switch(i){case g:return y;case f:return u;case m:return d;case v:return h;case w:return p}return t}),e.exports=S},function(e,t,n){"use strict";var i=n(20)(n(16),"DataView");e.exports=i},function(e,t,n){"use strict";var i=n(20)(n(16),"Promise");e.exports=i},function(e,t,n){"use strict";var i=n(20)(n(16),"WeakMap");e.exports=i},function(e,t,n){"use strict";var i=n(65),r=n(43);e.exports=function(e){for(var t=r(e),n=t.length;n--;){var s=t[n],a=e[s];t[n]=[s,a,i(a)]}return t}},function(e,t,n){"use strict";var i=n(57),r=n(137),s=n(144),a=n(52),o=n(65),c=n(66),l=n(27);e.exports=function(e,t){return a(e)&&o(t)?c(l(e),t):function(n){var a=r(n,e);return void 0===a&&a===t?s(n,e):i(t,a,3)}}},function(e,t,n){"use strict";var i=n(50);e.exports=function(e,t,n){var r=null==e?void 0:i(e,t);return void 0===r?n:r}},function(e,t,n){"use strict";var i=n(139),r=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,s=/\\(\\)?/g,a=i((function(e){var t=[];return 46===e.charCodeAt(0)&&t.push(""),e.replace(r,(function(e,n,i,r){t.push(i?r.replace(s,"$1"):n||e)})),t}));e.exports=a},function(e,t,n){"use strict";var i=n(140);e.exports=function(e){var t=i(e,(function(e){return 500===n.size&&n.clear(),e})),n=t.cache;return t}},function(e,t,n){"use strict";var i=n(41);function r(e,t){if("function"!=typeof e||null!=t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function n(){var i=arguments,r=t?t.apply(this,i):i[0],s=n.cache;if(s.has(r))return s.get(r);var a=e.apply(this,i);return n.cache=s.set(r,a)||s,a};return n.cache=new(r.Cache||i),n}r.Cache=i,e.exports=r},function(e,t,n){"use strict";var i=n(142);e.exports=function(e){return null==e?"":i(e)}},function(e,t,n){"use strict";var i=n(31),r=n(143),s=n(15),a=n(35),o=i?i.prototype:void 0,c=o?o.toString:void 0;e.exports=function e(t){if("string"==typeof t)return t;if(s(t))return r(t,e)+"";if(a(t))return c?c.call(t):"";var n=t+"";return"0"==n&&1/t==-1/0?"-0":n}},function(e,t,n){"use strict";e.exports=function(e,t){for(var n=-1,i=null==e?0:e.length,r=Array(i);++n<i;)r[n]=t(e[n],n,e);return r}},function(e,t,n){"use strict";var i=n(145),r=n(146);e.exports=function(e,t){return null!=e&&r(e,t,i)}},function(e,t,n){"use strict";e.exports=function(e,t){return null!=e&&t in Object(e)}},function(e,t,n){"use strict";var i=n(51),r=n(44),s=n(15),a=n(34),o=n(48),c=n(27);e.exports=function(e,t,n){for(var l=-1,u=(t=i(t,e)).length,d=!1;++l<u;){var h=c(t[l]);if(!(d=null!=e&&n(e,h)))break;e=e[h]}return d||++l!=u?d:!!(u=null==e?0:e.length)&&o(u)&&a(h,u)&&(s(e)||r(e))}},function(e,t,n){"use strict";var i=n(148),r=n(149),s=n(52),a=n(27);e.exports=function(e){return s(e)?i(a(e)):r(e)}},function(e,t,n){"use strict";e.exports=function(e){return function(t){return null==t?void 0:t[e]}}},function(e,t,n){"use strict";var i=n(50);e.exports=function(e){return function(t){return i(t,e)}}},function(e,t,n){"use strict";var i=n(151),r=n(34),s=Array.prototype.splice;e.exports=function(e,t){for(var n=e?t.length:0,a=n-1;n--;){var o=t[n];if(n==a||o!==c){var c=o;r(o)?s.call(e,o,1):i(e,o)}}return e}},function(e,t,n){"use strict";var i=n(51),r=n(152),s=n(153),a=n(27);e.exports=function(e,t){return t=i(t,e),null==(e=s(e,t))||delete e[a(r(t))]}},function(e,t,n){"use strict";e.exports=function(e){var t=null==e?0:e.length;return t?e[t-1]:void 0}},function(e,t,n){"use strict";var i=n(50),r=n(154);e.exports=function(e,t){return t.length<2?e:i(e,r(t,0,-1))}},function(e,t,n){"use strict";e.exports=function(e,t,n){var i=-1,r=e.length;t<0&&(t=-t>r?0:r+t),(n=n>r?r:n)<0&&(n+=r),r=t>n?0:n-t>>>0,t>>>=0;for(var s=Array(r);++i<r;)s[i]=e[i+t];return s}},function(e,t,n){"use strict";var i=n(37),r=n(26),s=n(43);e.exports=function(e){return function(t,n,a){var o=Object(t);if(!r(t)){var c=i(n,3);t=s(t),n=function(e){return c(o[e],e,o)}}var l=e(t,n,a);return l>-1?o[c?t[l]:l]:void 0}}},function(e,t,n){"use strict";var i=n(67),r=n(37),s=n(157),a=Math.max;e.exports=function(e,t,n){var o=null==e?0:e.length;if(!o)return-1;var c=null==n?0:s(n);return c<0&&(c=a(o+c,0)),i(e,r(t,3),c)}},function(e,t,n){"use strict";var i=n(158);e.exports=function(e){var t=i(e),n=t%1;return t==t?n?t-n:t:0}},function(e,t,n){"use strict";var i=n(159);e.exports=function(e){return e?Infinity===(e=i(e))||e===-1/0?17976931348623157e292*(e<0?-1:1):e==e?e:0:0===e?e:0}},function(e,t,n){"use strict";var i=n(18),r=n(35),s=/^\s+|\s+$/g,a=/^[-+]0x[0-9a-f]+$/i,o=/^0b[01]+$/i,c=/^0o[0-7]+$/i,l=parseInt;e.exports=function(e){if("number"==typeof e)return e;if(r(e))return NaN;if(i(e)){var t="function"==typeof e.valueOf?e.valueOf():e;e=i(t)?t+"":t}if("string"!=typeof e)return 0===e?e:+e;e=e.replace(s,"");var n=o.test(e);return n||c.test(e)?l(e.slice(2),n?2:8):a.test(e)?NaN:+e}},function(e,t,n){"use strict";var i=n(161)();e.exports=i},function(e,t,n){"use strict";e.exports=function(e){return function(t,n,i){for(var r=-1,s=Object(t),a=i(t),o=a.length;o--;){var c=a[e?o:++r];if(!1===n(s[c],c,s))break}return t}}},function(e,t,n){"use strict";var i=n(69),r=n(163),s=n(164),a=n(166),o=n(167),c=n(44),l=n(15),u=n(169),d=n(45),h=n(40),p=n(18),y=n(170),g=n(47),f=n(72),m=n(171);e.exports=function(e,t,n,v,w,S,b){var P=f(e,n),O=f(t,n),D=b.get(O);if(D)i(e,n,D);else{var C=S?S(P,O,n+"",e,t,b):void 0,I=void 0===C;if(I){var M=l(O),j=!M&&d(O),A=!M&&!j&&g(O);C=O,M||j||A?l(P)?C=P:u(P)?C=a(P):j?(I=!1,C=r(O,!0)):A?(I=!1,C=s(O,!0)):C=[]:y(O)||c(O)?(C=P,c(P)?C=m(P):p(P)&&!h(P)||(C=o(O))):I=!1}I&&(b.set(O,C),w(C,O,v,S,b),b.delete(O)),i(e,n,C)}}},function(e,t,n){"use strict";(function(e){var i=n(16),r=t&&!t.nodeType&&t,s=r&&"object"==typeof e&&e&&!e.nodeType&&e,a=s&&s.exports===r?i.Buffer:void 0,o=a?a.allocUnsafe:void 0;e.exports=function(e,t){if(t)return e.slice();var n=e.length,i=o?o(n):new e.constructor(n);return e.copy(i),i}}).call(this,n(46)(e))},function(e,t,n){"use strict";var i=n(165);e.exports=function(e,t){var n=t?i(e.buffer):e.buffer;return new e.constructor(n,e.byteOffset,e.length)}},function(e,t,n){"use strict";var i=n(61);e.exports=function(e){var t=new e.constructor(e.byteLength);return new i(t).set(new i(e)),t}},function(e,t,n){"use strict";e.exports=function(e,t){var n=-1,i=e.length;for(t||(t=Array(i));++n<i;)t[n]=e[n];return t}},function(e,t,n){"use strict";var i=n(168),r=n(71),s=n(49);e.exports=function(e){return"function"!=typeof e.constructor||s(e)?{}:i(r(e))}},function(e,t,n){"use strict";var i=n(18),r=Object.create,s=function(){function e(){}return function(t){if(!i(t))return{};if(r)return r(t);e.prototype=t;var n=new e;return e.prototype=void 0,n}}();e.exports=s},function(e,t,n){"use strict";var i=n(26),r=n(21);e.exports=function(e){return r(e)&&i(e)}},function(e,t,n){"use strict";var i=n(24),r=n(71),s=n(21),a=Function.prototype,o=Object.prototype,c=a.toString,l=o.hasOwnProperty,u=c.call(Object);e.exports=function(e){if(!s(e)||"[object Object]"!=i(e))return!1;var t=r(e);if(null===t)return!0;var n=l.call(t,"constructor")&&t.constructor;return"function"==typeof n&&n instanceof n&&c.call(n)==u}},function(e,t,n){"use strict";var i=n(172),r=n(73);e.exports=function(e){return i(e,r(e))}},function(e,t,n){"use strict";var i=n(173),r=n(54);e.exports=function(e,t,n,s){var a=!n;n||(n={});for(var o=-1,c=t.length;++o<c;){var l=t[o],u=s?s(n[l],e[l],l,n,e):void 0;void 0===u&&(u=e[l]),a?r(n,l,u):i(n,l,u)}return n}},function(e,t,n){"use strict";var i=n(54),r=n(25),s=Object.prototype.hasOwnProperty;e.exports=function(e,t,n){var a=e[t];s.call(e,t)&&r(a,n)&&(void 0!==n||t in e)||i(e,t,n)}},function(e,t,n){"use strict";var i=n(18),r=n(49),s=n(175),a=Object.prototype.hasOwnProperty;e.exports=function(e){if(!i(e))return s(e);var t=r(e),n=[];for(var o in e)("constructor"!=o||!t&&a.call(e,o))&&n.push(o);return n}},function(e,t,n){"use strict";e.exports=function(e){var t=[];if(null!=e)for(var n in Object(e))t.push(n);return t}},function(e,t,n){"use strict";var i=n(53),r=n(177),s=n(179);e.exports=function(e,t){return s(r(e,t,i),e+"")}},function(e,t,n){"use strict";var i=n(178),r=Math.max;e.exports=function(e,t,n){return t=r(void 0===t?e.length-1:t,0),function(){for(var s=arguments,a=-1,o=r(s.length-t,0),c=Array(o);++a<o;)c[a]=s[t+a];a=-1;for(var l=Array(t+1);++a<t;)l[a]=s[a];return l[t]=n(c),i(e,this,l)}}},function(e,t,n){"use strict";e.exports=function(e,t,n){switch(n.length){case 0:return e.call(t);case 1:return e.call(t,n[0]);case 2:return e.call(t,n[0],n[1]);case 3:return e.call(t,n[0],n[1],n[2])}return e.apply(t,n)}},function(e,t,n){"use strict";var i=n(180),r=n(182)(i);e.exports=r},function(e,t,n){"use strict";var i=n(181),r=n(70),s=n(53),a=r?function(e,t){return r(e,"toString",{configurable:!0,enumerable:!1,value:i(t),writable:!0})}:s;e.exports=a},function(e,t,n){"use strict";e.exports=function(e){return function(){return e}}},function(e,t,n){"use strict";var i=Date.now;e.exports=function(e){var t=0,n=0;return function(){var r=i(),s=16-(r-n);if(n=r,s>0){if(++t>=800)return arguments[0]}else t=0;return e.apply(void 0,arguments)}}},function(e,t,n){"use strict";var i=n(25),r=n(26),s=n(34),a=n(18);e.exports=function(e,t,n){if(!a(n))return!1;var o=typeof t;return!!("number"==o?r(n)&&s(t,n.length):"string"==o&&t in n)&&i(n[t],e)}},function(e,t,n){"use strict";var i=n(185);e.exports=function(e,t){return!(null==e||!e.length)&&i(e,t,0)>-1}},function(e,t,n){"use strict";var i=n(67),r=n(186),s=n(187);e.exports=function(e,t,n){return t==t?s(e,t,n):i(e,r,n)}},function(e,t,n){"use strict";e.exports=function(e){return e!=e}},function(e,t,n){"use strict";e.exports=function(e,t,n){for(var i=n-1,r=e.length;++i<r;)if(e[i]===t)return i;return-1}},function(e,t,n){"use strict";e.exports=function(e,t,n){for(var i=-1,r=null==e?0:e.length;++i<r;)if(n(t,e[i]))return!0;return!1}},function(e,t,n){"use strict";var i=n(64),r=n(190),s=n(42),a=i&&1/s(new i([,-0]))[1]==1/0?function(e){return new i(e)}:r;e.exports=a},function(e,t,n){"use strict";e.exports=function(){}},function(e,t,n){"use strict";(function(e,t){!function(e,n){if(!e.setImmediate){var i,r,s,a,o,c=1,l={},u=!1,d=e.document,h=Object.getPrototypeOf&&Object.getPrototypeOf(e);h=h&&h.setTimeout?h:e,"[object process]"==={}.toString.call(e.process)?i=function(e){t.nextTick((function(){y(e)}))}:function(){if(e.postMessage&&!e.importScripts){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}()?(a="setImmediate$"+Math.random()+"$",o=function(t){t.source===e&&"string"==typeof t.data&&0===t.data.indexOf(a)&&y(+t.data.slice(a.length))},e.addEventListener?e.addEventListener("message",o,!1):e.attachEvent("onmessage",o),i=function(t){e.postMessage(a+t,"*")}):e.MessageChannel?((s=new MessageChannel).port1.onmessage=function(e){y(e.data)},i=function(e){s.port2.postMessage(e)}):d&&"onreadystatechange"in d.createElement("script")?(r=d.documentElement,i=function(e){var t=d.createElement("script");t.onreadystatechange=function(){y(e),t.onreadystatechange=null,r.removeChild(t),t=null},r.appendChild(t)}):i=function(e){setTimeout(y,0,e)},h.setImmediate=function(e){"function"!=typeof e&&(e=new Function(""+e));for(var t=new Array(arguments.length-1),n=0;n<t.length;n++)t[n]=arguments[n+1];var r={callback:e,args:t};return l[c]=r,i(c),c++},h.clearImmediate=p}function p(e){delete l[e]}function y(e){if(u)setTimeout(y,0,e);else{var t=l[e];if(t){u=!0;try{!function(e){var t=e.callback,n=e.args;switch(n.length){case 0:t();break;case 1:t(n[0]);break;case 2:t(n[0],n[1]);break;case 3:t(n[0],n[1],n[2]);break;default:t.apply(void 0,n)}}(t)}finally{p(e),u=!1}}}}}("undefined"==typeof self?void 0===e?this:e:self)}).call(this,n(28),n(192))},function(e,t,n){"use strict";var i,r,s=e.exports={};function a(){throw new Error("setTimeout has not been defined")}function o(){throw new Error("clearTimeout has not been defined")}function c(e){if(i===setTimeout)return setTimeout(e,0);if((i===a||!i)&&setTimeout)return i=setTimeout,setTimeout(e,0);try{return i(e,0)}catch(t){try{return i.call(null,e,0)}catch(t){return i.call(this,e,0)}}}!function(){try{i="function"==typeof setTimeout?setTimeout:a}catch(e){i=a}try{r="function"==typeof clearTimeout?clearTimeout:o}catch(e){r=o}}();var l,u=[],d=!1,h=-1;function p(){d&&l&&(d=!1,l.length?u=l.concat(u):h=-1,u.length&&y())}function y(){if(!d){var e=c(p);d=!0;for(var t=u.length;t;){for(l=u,u=[];++h<t;)l&&l[h].run();h=-1,t=u.length}l=null,d=!1,function(e){if(r===clearTimeout)return clearTimeout(e);if((r===o||!r)&&clearTimeout)return r=clearTimeout,clearTimeout(e);try{r(e)}catch(t){try{return r.call(null,e)}catch(t){return r.call(this,e)}}}(e)}}function g(e,t){this.fun=e,this.array=t}function f(){}s.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];u.push(new g(e,t)),1!==u.length||d||c(y)},g.prototype.run=function(){this.fun.apply(null,this.array)},s.title="browser",s.browser=!0,s.env={},s.argv=[],s.version="",s.versions={},s.on=f,s.addListener=f,s.once=f,s.off=f,s.removeListener=f,s.removeAllListeners=f,s.emit=f,s.prependListener=f,s.prependOnceListener=f,s.listeners=function(e){return[]},s.binding=function(e){throw new Error("process.binding is not supported")},s.cwd=function(){return"/"},s.chdir=function(e){throw new Error("process.chdir is not supported")},s.umask=function(){return 0}},function(e,t,n){"use strict";n.r(t),n.d(t,"SNApplicationGroup",(function(){return d})),n.d(t,"DeinitSource",(function(){return o})),n.d(t,"KeyParamsOrigination",(function(){return h})),n.d(t,"KeyRecoveryStrings",(function(){return j})),n.d(t,"SNApplication",(function(){return Si})),n.d(t,"SNProtocolService",(function(){return kn})),n.d(t,"KeyMode",(function(){return En})),n.d(t,"SNProtocolOperator001",(function(){return mn})),n.d(t,"SNProtocolOperator002",(function(){return bn})),n.d(t,"SNProtocolOperator003",(function(){return Pn})),n.d(t,"SNProtocolOperator004",(function(){return In})),n.d(t,"SNRootKey",(function(){return It})),n.d(t,"DeviceInterface",(function(){return bi})),n.d(t,"SNItem",(function(){return U.d})),n.d(t,"ItemMutator",(function(){return U.b})),n.d(t,"AppDataField",(function(){return U.a})),n.d(t,"SNItemsKey",(function(){return fe})),n.d(t,"SNPredicate",(function(){return W.a})),n.d(t,"SNNote",(function(){return ye})),n.d(t,"NoteMutator",(function(){return ge})),n.d(t,"SNTag",(function(){return ue})),n.d(t,"TagMutator",(function(){return de})),n.d(t,"SNSmartTag",(function(){return he})),n.d(t,"SNActionsExtension",(function(){return ce})),n.d(t,"Action",(function(){return oe})),n.d(t,"SNTheme",(function(){return Z})),n.d(t,"ThemeMutator",(function(){return ee})),n.d(t,"SNComponent",(function(){return $})),n.d(t,"ComponentAction",(function(){return Q})),n.d(t,"ComponentMutator",(function(){return X})),n.d(t,"SNEditor",(function(){return te})),n.d(t,"SNUserPrefs",(function(){return B})),n.d(t,"UserPrefsMutator",(function(){return H})),n.d(t,"WebPrefKey",(function(){return F})),n.d(t,"MutationType",(function(){return U.c})),n.d(t,"ComponentArea",(function(){return J})),n.d(t,"LiveItem",(function(){return Pi})),n.d(t,"SNComponentManager",(function(){return zt})),n.d(t,"SessionHistoryMap",(function(){return Fn})),n.d(t,"ItemSessionHistory",(function(){return xn})),n.d(t,"ItemHistoryEntry",(function(){return Kn})),n.d(t,"SNPrivileges",(function(){return q})),n.d(t,"ProtectedAction",(function(){return L})),n.d(t,"PrivilegeCredential",(function(){return V})),n.d(t,"PayloadManager",(function(){return Jt})),n.d(t,"ItemManager",(function(){return Jn})),n.d(t,"SNHttpService",(function(){return Rt})),n.d(t,"ChallengeService",(function(){return fi})),n.d(t,"PureService",(function(){return l.a})),n.d(t,"ApplicationService",(function(){return Oi.a})),n.d(t,"SNStorageService",(function(){return Te})),n.d(t,"StoragePersistencePolicies",(function(){return Me})),n.d(t,"StorageEncryptionPolicies",(function(){return je})),n.d(t,"StorageValueModes",(function(){return Ae})),n.d(t,"ValueModesKeys",(function(){return Ee})),n.d(t,"Challenge",(function(){return xe})),n.d(t,"ChallengeReason",(function(){return ke})),n.d(t,"ChallengeResponse",(function(){return Ve})),n.d(t,"ChallengeValidation",(function(){return Re})),n.d(t,"ChallengeValue",(function(){return Le})),n.d(t,"ChallengePrompt",(function(){return Fe})),n.d(t,"SNSyncService",(function(){return yi})),n.d(t,"SyncSources",(function(){return oi})),n.d(t,"SyncModes",(function(){return ai})),n.d(t,"SyncQueueStrategy",(function(){return si})),n.d(t,"SortPayloadsByRecentAndContentPriority",(function(){return $n})),n.d(t,"SNSessionManager",(function(){return Et})),n.d(t,"SNMigrationService",(function(){return dn})),n.d(t,"ButtonType",(function(){return ht})),n.d(t,"SNHistoryManager",(function(){return Ln})),n.d(t,"SNPrivilegesService",(function(){return Wn})),n.d(t,"SNSingletonManager",(function(){return Yt})),n.d(t,"SNApiService",(function(){return Tt})),n.d(t,"addIfUnique",(function(){return c.b})),n.d(t,"arrayByDifference",(function(){return c.c})),n.d(t,"Copy",(function(){return c.a})),n.d(t,"dateSorted",(function(){return c.g})),n.d(t,"deepMerge",(function(){return c.i})),n.d(t,"dictToArray",(function(){return c.j})),n.d(t,"extendArray",(function(){return c.k})),n.d(t,"findInArray",(function(){return c.m})),n.d(t,"getGlobalScope",(function(){return c.n})),n.d(t,"greaterOfTwoDates",(function(){return c.o})),n.d(t,"isNullOrUndefined",(function(){return c.q})),n.d(t,"jsonParseEmbeddedKeys",(function(){return c.w})),n.d(t,"omitUndefinedCopy",(function(){return c.A})),n.d(t,"removeFromArray",(function(){return c.C})),n.d(t,"removeFromIndex",(function(){return c.D})),n.d(t,"subtractFromArray",(function(){return c.H})),n.d(t,"topLevelCompare",(function(){return c.I})),n.d(t,"truncateHexString",(function(){return c.J})),n.d(t,"uniqCombineObjArrays",(function(){return c.K})),n.d(t,"Uuid",(function(){return u})),n.d(t,"EncryptionIntent",(function(){return _e.b})),n.d(t,"isLocalStorageIntent",(function(){return _e.f})),n.d(t,"isFileIntent",(function(){return _e.e})),n.d(t,"isDecryptedIntent",(function(){return _e.d})),n.d(t,"intentRequiresEncryption",(function(){return _e.c})),n.d(t,"ContentTypeUsesRootKeyEncryption",(function(){return _e.a})),n.d(t,"ContentType",(function(){return Y.a})),n.d(t,"CreateItemFromPayload",(function(){return we})),n.d(t,"Uuids",(function(){return ft.b})),n.d(t,"FillItemContent",(function(){return ft.a})),n.d(t,"ApplicationEvent",(function(){return mt.a})),n.d(t,"Environment",(function(){return be})),n.d(t,"Platform",(function(){return Pe})),n.d(t,"isEnvironmentWebOrDesktop",(function(){return Ce})),n.d(t,"isEnvironmentMobile",(function(){return Ie})),n.d(t,"platformFromString",(function(){return De})),n.d(t,"SyncEvent",(function(){return Gt.a})),n.d(t,"MutableCollection",(function(){return et})),n.d(t,"ImmutablePayloadCollection",(function(){return tt})),n.d(t,"ItemCollection",(function(){return nn})),n.d(t,"CollectionSort",(function(){return Qt})),n.d(t,"CreateMaxPayloadFromAnyObject",(function(){return Oe.e})),n.d(t,"CreateSourcedPayloadFromObject",(function(){return Oe.f})),n.d(t,"CreateIntentPayloadFromObject",(function(){return Oe.d})),n.d(t,"CreateEncryptionParameters",(function(){return Oe.c})),n.d(t,"PayloadByMerging",(function(){return Oe.g})),n.d(t,"CopyPayload",(function(){return Oe.b})),n.d(t,"PayloadSource",(function(){return Ye.a})),n.d(t,"isPayloadSourceRetrieved",(function(){return Ye.c})),n.d(t,"isPayloadSourceInternalChange",(function(){return Ye.b})),n.d(t,"ProtocolVersion",(function(){return p.a})),n.d(t,"PayloadFormat",(function(){return pe.a})),n.d(t,"PurePayload",(function(){return $e.a})),n.d(t,"PayloadField",(function(){return N.a})),n.d(t,"StorageKey",(function(){return r})),n.d(t,"RawStorageKey",(function(){return i})),n.d(t,"BaseMigration",(function(){return un})),n.d(t,"PrivilegeSessionLength",(function(){return Vn})),n.d(t,"SNLog",(function(){return vn}));var i,r,s={};function a(e,t){return e?"".concat(e,"-").concat(t):t}n.r(s),n.d(s,"Migration20200115",(function(){return ln})),function(e){e.StorageObject="storage",e.LastMigrationTimestamp="last_migration_timestamp",e.DescriptorRecord="descriptors"}(i||(i={})),function(e){e.RootKeyParams="ROOT_KEY_PARAMS",e.WrappedRootKey="WRAPPED_ROOT_KEY",e.RootKeyWrapperKeyParams="ROOT_KEY_WRAPPER_KEY_PARAMS",e.Session="session",e.User="user",e.ServerHost="server",e.LegacyUuid="uuid",e.LastSyncToken="syncToken",e.PaginationToken="cursorToken",e.BiometricsState="biometrics_state",e.MobilePasscodeTiming="passcode_timing",e.MobileBiometricsTiming="biometrics_timing",e.MobilePasscodeKeyboardType="passcodeKeyboardType",e.MobilePreferences="preferences",e.PrivilegesExpirey="SessionExpiresAtKey",e.PrivilegesSessionLength="SessionLengthKey",e.SessionHistoryPersistable="sessionHistory_persist",e.SessionHistoryRevisions="sessionHistory_revisions",e.SessionHistoryOptimize="sessionHistory_autoOptimize",e.KeyRecoveryUndecryptableItems="key_recovery_undecryptable",e.StorageEncryptionPolicy="storage_policy"}(r||(r={}));var o,c=n(0);!function(e){e[e.SignOut=1]="SignOut",e[e.Lock=2]="Lock",e[e.AppGroupUnload=3]="AppGroupUnload"}(o||(o={}));var l=n(11);class u{static SetGenerators(e,t){this.syncUuidFunc=t,this.asyncUuidFunc=e}static canGenSync(){return!Object(c.q)(this.syncUuidFunc)}static async GenerateUuid(){return this.syncUuidFunc?this.syncUuidFunc():this.asyncUuidFunc()}static GenerateUuidSynchronously(){return this.syncUuidFunc()}}class d extends l.a{constructor(e){super(),this.deviceInterface=e,this.changeObservers=[],this.applications=[],this.onApplicationDeinit=(e,t)=>{const n=t!==o.AppGroupUnload;if(this.primaryApplication===e&&(this.primaryApplication=void 0),Object(c.C)(this.applications,e),t===o.SignOut){if(this.removeDescriptor(this.descriptorForApplication(e)),n){const e=this.getDescriptors();return 0===e.length?this.addNewApplication():this.loadApplicationForDescriptor(e[0])}}else if(t===o.Lock&&n){const t=this.descriptorForApplication(e);return this.loadApplicationForDescriptor(t)}}}deinit(){super.deinit(),this.deviceInterface.deinit(),this.deviceInterface=void 0}async initialize(e){this.callback=e,this.descriptorRecord=await this.deviceInterface.getJsonParsedRawStorageValue(i.DescriptorRecord),this.descriptorRecord||await this.createDescriptorRecord();const t=this.findPrimaryDescriptor();if(!t)throw Error("No primary application descriptor found. Ensure migrations have been run.");const n=this.buildApplication(t);this.applications.push(n),this.setPrimaryApplication(n,!1)}async createDescriptorRecord(){const e="standardnotes",t={[e]:{identifier:e,label:"Main Application",primary:!0}};this.deviceInterface.setRawStorageValue(i.DescriptorRecord,JSON.stringify(t)),this.descriptorRecord=t,this.persistDescriptors()}getApplications(){return this.applications}getDescriptors(){return Object.values(this.descriptorRecord)}findPrimaryDescriptor(){for(const e of this.getDescriptors())if(e.primary)return e}addApplicationChangeObserver(e){return this.changeObservers.push(e),this.primaryApplication&&e(),()=>{Object(c.C)(this.changeObservers,e)}}notifyObserversOfAppChange(){for(const e of this.changeObservers)e()}async setPrimaryApplication(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(this.primaryApplication===e)return;if(!this.applications.includes(e))throw Error("Application must be inserted before attempting to switch to it");this.primaryApplication&&this.primaryApplication.deinit(o.AppGroupUnload),this.primaryApplication=e;const n=this.descriptorForApplication(e);this.setDescriptorAsPrimary(n),this.notifyObserversOfAppChange(),t&&await this.persistDescriptors()}setDescriptorAsPrimary(e){for(const t of this.getDescriptors())t.primary=t===e}async persistDescriptors(){this.deviceInterface.setRawStorageValue(i.DescriptorRecord,JSON.stringify(this.descriptorRecord))}async renameDescriptor(e,t){e.label=t,await this.persistDescriptors()}removeDescriptor(e){return delete this.descriptorRecord[e.identifier],this.persistDescriptors()}descriptorForApplication(e){return this.descriptorRecord[e.identifier]}async addNewApplication(e){const t=await u.GenerateUuid(),n=this.getDescriptors().length+1,i={identifier:t,label:e||"Application ".concat(n),primary:!1},r=this.buildApplication(i);this.applications.push(r),this.descriptorRecord[t]=i,await this.setPrimaryApplication(r),await this.persistDescriptors()}applicationForDescriptor(e){return this.applications.find((t=>t.identifier===e.identifier))}async loadApplicationForDescriptor(e){let t=this.applicationForDescriptor(e);t||(t=this.buildApplication(e),this.applications.push(t)),await this.setPrimaryApplication(t)}buildApplication(e){const t=this.callback.applicationCreator(e,this.deviceInterface);return t.setOnDeinit(this.onApplicationDeinit),t}}var h,p=n(5);function y(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function g(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?y(Object(n),!0).forEach((function(t){f(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):y(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function f(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function m(e){if(e.content)throw Error("Raw key params shouldnt have content; perhaps you passed in a SNRootKeyParams object.");return new S(e)}function v(e){return e.version?e.version:e.pw_nonce?p.a.V001:p.a.V002}function w(e,t){return m({identifier:t||e.identifier,pw_cost:e.pw_cost,pw_nonce:e.pw_nonce,pw_salt:e.pw_salt,version:v(e),origination:e.origination,created:e.created})}!function(e){e.Registration="registration",e.EmailChange="email-change",e.PasswordChange="password-change",e.ProtocolUpgrade="protocol-upgrade",e.PasscodeCreate="passcode-create",e.PasscodeChange="passcode-change"}(h||(h={}));class S{constructor(e){this.content=g(g({},e),{},{origination:e.origination||h.Registration})}get isKeyParamsObject(){return!0}get identifier(){return this.content004.identifier||this.content002.email}get version(){return this.content.version}get origination(){return this.content.origination}get content001(){return this.content}get content002(){return this.content}get content003(){return this.content}get content004(){return this.content}get createdDate(){if(this.content004.created)return new Date(Number(this.content004.created))}compare(e){if(this.version!==e.version)return!1;if([p.a.V004,p.a.V003].includes(this.version))return this.identifier===e.identifier&&this.content004.pw_nonce===e.content003.pw_nonce;if([p.a.V002,p.a.V001].includes(this.version))return this.identifier===e.identifier&&this.content002.pw_salt===e.content001.pw_salt;throw Error("Unhandled version in KeyParams.compare")}getPortableValue(){return this.content}}const b="A server error occurred while trying to sign in. Please try again.",P="Could not connect to server.",O="Invalid email or password.",D="Do not close the application until this process completes.";function C(e){return"Your password must be at least ".concat(e," characters in length. For your security, please choose a longer password or, ideally, a passphrase, and try again.")}const I="Incorrect two-factor authentication code. Please try again.",M="Your sign in request has been canceled.",j={KeyRecoveryLoginFlowPrompt:e=>{var t;const n=null===(t=e.createdDate)||void 0===t?void 0:t.toLocaleString();switch(e.origination){case h.EmailChange:return"Enter your account password as it was when you changed your email on ".concat(n,".");case h.PasswordChange:return"Enter your account password after it was changed on ".concat(n,".");case h.Registration:return"Enter your account password as it was when you registered ".concat(n,".");case h.ProtocolUpgrade:return"Enter your account password as it was when you upgraded your encryption version on ".concat(n,".");case h.PasscodeChange:return"Enter your application passcode after it was changed on ".concat(n,".");case h.PasscodeCreate:return"Enter your application passcode as it was when you created it on ".concat(n,".");default:throw Error("Unhandled KeyParamsOrigination case for KeyRecoveryLoginFlowPrompt")}},KeyRecoveryLoginFlowReason:"Your account password is required to revalidate your session.",KeyRecoveryLoginFlowInvalidPassword:"Incorrect credentials entered. Please try again.",KeyRecoveryRootKeyReplaced:"Your credentials have successfully been updated.",KeyRecoveryPasscodeRequiredTitle:"Passcode Required",KeyRecoveryPasscodeRequiredText:"You must enter your passcode in order to save your new credentials.",KeyRecoveryPasswordRequired:"Your account password is required to recover an encryption key.",KeyRecoveryKeyRecovered:"Your key has successfully been recovered.",KeyRecoveryUnableToRecover:"Unable to recover your key with the attempted password. Please try again."},A="Please enter your account email and password.",E=e=>"Your credentials are needed for ".concat(e," to refresh your session with the server."),R="Your session has been successfully restored.",k="Please enter your two-factor authentication code.",K="Two-factor authentication code",_="Email",T="Password",x="Application Passcode";var F,L,V,N=n(4),U=n(6),W=n(14);!function(e){e.TagsPanelWidth="tagsPanelWidth",e.NotesPanelWidth="notesPanelWidth",e.EditorWidth="editorWidth",e.EditorLeft="editorLeft",e.EditorMonospaceEnabled="monospaceFont",e.EditorSpellcheck="spellcheck",e.EditorResizersEnabled="marginResizersEnabled",e.SortNotesBy="sortBy",e.SortNotesReverse="sortReverse",e.NotesShowArchived="showArchived",e.NotesHidePinned="hidePinned",e.NotesHideNotePreview="hideNotePreview",e.NotesHideDate="hideDate",e.NotesHideTags="hideTags"}(F||(F={}));class B extends U.d{get isSingleton(){return!0}get singletonPredicate(){return new W.a("content_type","=",this.content_type)}getPref(e){return this.getAppDomainValue(e)}}class H extends U.b{setWebPref(e,t){this.setAppDataItem(e,t)}}!function(e){e.ManageExtensions="ActionManageExtensions",e.ManageBackups="ActionManageBackups",e.ViewProtectedNotes="ActionViewProtectedNotes",e.ManagePrivileges="ActionManagePrivileges",e.ManagePasscode="ActionManagePasscode",e.DeleteNote="ActionDeleteNote"}(L||(L={})),function(e){e.AccountPassword="CredentialAccountPassword",e.LocalPasscode="CredentialLocalPasscode"}(V||(V={}));class q extends U.d{constructor(e){super(e),this.privilegeMap={},this.privilegeMap=e.safeContent.desktopPrivileges||{}}get isSingleton(){return!0}get singletonPredicate(){return new W.a("content_type","=",this.content_type)}getCredentialsForAction(e){return this.privilegeMap[e]||[]}isCredentialRequiredForAction(e,t){return this.getCredentialsForAction(e).includes(t)}}class z extends U.b{constructor(e,t){super(e,t),this.privilegeMap={},this.privileges=e,this.privilegeMap=Object(c.a)(this.payload.safeContent.desktopPrivileges||{})}getResult(){return this.content&&(this.content.desktopPrivileges=this.privilegeMap),super.getResult()}setCredentialsForAction(e,t){this.privilegeMap[e]=t}toggleCredentialForAction(e,t){this.privileges.isCredentialRequiredForAction(e,t)?this.removeCredentialForAction(e,t):this.addCredentialForAction(e,t)}removeCredentialForAction(e,t){Object(c.C)(this.privilegeMap[e],t)}addCredentialForAction(e,t){const n=this.privileges.getCredentialsForAction(e).slice();n.push(t),this.setCredentialsForAction(e,n)}}var J,Q,G=n(13),Y=n(3);!function(e){e.Editor="editor-editor",e.Themes="themes",e.TagsList="tags-list",e.EditorStack="editor-stack",e.NoteTags="note-tags",e.Rooms="rooms",e.Modal="modal",e.Any="*"}(J||(J={})),function(e){e.SetSize="set-size",e.StreamItems="stream-items",e.StreamContextItem="stream-context-item",e.SaveItems="save-items",e.SelectItem="select-item",e.AssociateItem="associate-item",e.DeassociateItem="deassociate-item",e.ClearSelection="clear-selection",e.CreateItem="create-item",e.CreateItems="create-items",e.DeleteItems="delete-items",e.SetComponentData="set-component-data",e.InstallLocalComponent="install-local-component",e.ToggleActivateComponent="toggle-activate-component",e.RequestPermissions="request-permissions",e.PresentConflictResolution="present-conflict-resolution",e.DuplicateItem="duplicate-item",e.ComponentRegistered="component-registered",e.ActivateThemes="themes",e.Reply="reply",e.SaveSuccess="save-success",e.SaveError="save-error"}(Q||(Q={}));class $ extends U.d{constructor(e){super(e),this.permissions=[],this.componentData=this.payload.safeContent.componentData||{},this.legacy_url=this.payload.safeContent.legacy_url,this.hosted_url=this.payload.safeContent.hosted_url||this.payload.safeContent.url,this.local_url=this.payload.safeContent.local_url,this.valid_until=new Date(this.payload.safeContent.valid_until),this.offlineOnly=this.payload.safeContent.offlineOnly,this.name=this.payload.safeContent.name,this.area=this.payload.safeContent.area,this.package_info=this.payload.safeContent.package_info,this.permissions=this.payload.safeContent.permissions||[],this.active=this.payload.safeContent.active,this.autoupdateDisabled=this.payload.safeContent.autoupdateDisabled,this.disassociatedItemIds=this.payload.safeContent.disassociatedItemIds||[],this.associatedItemIds=this.payload.safeContent.associatedItemIds||[],this.isMobileDefault=this.payload.safeContent.isMobileDefault,this.legacy_url=this.payload.safeContent.hosted_url?void 0:this.payload.safeContent.url}strategyWhenConflictingWithItem(e){return this.errorDecrypting?super.strategyWhenConflictingWithItem(e):G.a.KeepLeft}isEditor(){return this.area===J.Editor}isTheme(){return this.content_type===Y.a.Theme||this.area===J.Themes}isDefaultEditor(){return!0===this.getAppDomainValue(U.a.DefaultEditor)}getLastSize(){return this.getAppDomainValue(U.a.LastSize)}acceptsThemes(){var e;return null===(e=this.payload.safeContent.package_info)||void 0===e?void 0:e.acceptsThemes}getClientDataKey(){return this.legacy_url?this.legacy_url:this.uuid}hasValidHostedUrl(){return this.hosted_url||this.legacy_url}contentKeysToIgnoreWhenCheckingEquality(){return["active","disassociatedItemIds","associatedItemIds"].concat(super.contentKeysToIgnoreWhenCheckingEquality())}static associativeAreas(){return[J.Editor]}isAssociative(){return $.associativeAreas().includes(this.area)}isExplicitlyEnabledForItem(e){return-1!==this.associatedItemIds.indexOf(e)}isExplicitlyDisabledForItem(e){return-1!==this.disassociatedItemIds.indexOf(e)}}class X extends U.b{get typedContent(){return this.content}set active(e){this.typedContent.active=e}set isMobileDefault(e){this.typedContent.isMobileDefault=e}set defaultEditor(e){this.setAppDataItem(U.a.DefaultEditor,e)}set componentData(e){this.typedContent.componentData=e}set package_info(e){this.typedContent.package_info=e}set local_url(e){this.typedContent.local_url=e}set hosted_url(e){this.typedContent.hosted_url=e}set permissions(e){this.typedContent.permissions=e}associateWithItem(e){const t=this.typedContent.associatedItemIds||[];Object(c.b)(t,e),this.typedContent.associatedItemIds=t}disassociateWithItem(e){const t=this.typedContent.disassociatedItemIds||[];Object(c.b)(t,e),this.typedContent.disassociatedItemIds=t}removeAssociatedItemId(e){Object(c.C)(this.typedContent.associatedItemIds||[],e)}removeDisassociatedItemId(e){Object(c.C)(this.typedContent.disassociatedItemIds||[],e)}setLastSize(e){this.setAppDataItem(U.a.LastSize,e)}}class Z extends ${constructor(){super(...arguments),this.area=J.Themes}isLayerable(){return this.package_info&&this.package_info.layerable}strategyWhenConflictingWithItem(e){return this.errorDecrypting?super.strategyWhenConflictingWithItem(e):G.a.KeepLeft}getMobileRules(){return this.getAppDomainValue(U.a.MobileRules)||{constants:{},rules:{}}}hasMobileRules(){return this.getAppDomainValue(U.a.MobileRules)}getNotAvailOnMobile(){return this.getAppDomainValue(U.a.NotAvailableOnMobile)}isMobileActive(){return this.getAppDomainValue(U.a.MobileActive)}}class ee extends U.b{setMobileRules(e){this.setAppDataItem(U.a.MobileRules,e)}setNotAvailOnMobile(e){this.setAppDataItem(U.a.NotAvailableOnMobile,e)}set local_url(e){this.content.local_url=e}setMobileActive(e){this.setAppDataItem(U.a.MobileActive,e)}}class te extends U.d{constructor(e){super(e),this.notes=[],this.data={},this.url=e.safeContent.url,this.name=e.safeContent.name,this.data=e.safeContent.data||{},this.isDefault=e.safeContent.default,this.systemEditor=e.safeContent.systemEditor}}var ne,ie,re=n(36),se=n.n(re);!function(e){e.Encrypted="encrypted",e.Decrypted="decrypted"}(ne||(ne={})),function(e){e.Get="get",e.Render="render",e.Show="show",e.Post="post",e.Nested="nested"}(ie||(ie={}));let ae=Number.MIN_SAFE_INTEGER;class oe{constructor(e){var t,n,i;this.id=(ae+=1,ae===Number.MAX_SAFE_INTEGER&&(ae=Number.MIN_SAFE_INTEGER),ae),se()(this,e),this.running=null!==(t=e.running)&&void 0!==t&&t,this.error=null!==(n=e.error)&&void 0!==n&&n,this.lastExecuted&&(this.lastExecuted=new Date(this.lastExecuted)),this.subactions=null===(i=e.subactions)||void 0===i?void 0:i.map((e=>new oe(e)))}}class ce extends U.d{constructor(e){super(e),this.actions=[],this.description=e.safeContent.description,this.url=e.safeContent.url,this.name=e.safeContent.name,this.package_info=e.safeContent.package_info,this.supported_types=e.safeContent.supported_types,this.deprecation=e.safeContent.deprecation,e.safeContent.actions&&(this.actions=e.safeContent.actions.map((e=>new oe(e))))}actionsWithContextForItem(e){return this.actions.filter((t=>t.context===e.content_type||"Item"===t.context))}}class le extends U.b{set description(e){this.content.description=e}set supported_types(e){this.content.supported_types=e}set actions(e){this.content.actions=e}set deprecation(e){this.content.deprecation=e}}class ue extends U.d{constructor(e){super(e),this.title=this.payload.safeContent.title}get noteCount(){return this.payload.safeReferences.length}isSmartTag(){return this.content_type===Y.a.SmartTag}get isAllTag(){return this.payload.safeContent.isAllTag}get isTrashTag(){return this.payload.safeContent.isTrashTag}get isArchiveTag(){return this.payload.safeContent.isArchiveTag}static arrayToDisplayString(e){return e.sort(((e,t)=>e.title>t.title?1:-1)).map((e=>"#"+e.title)).join(" ")}}class de extends U.b{set title(e){this.content.title=e}}class he extends ue{constructor(e){super(e),e.safeContent.predicate&&(this.predicate=W.a.FromJson(e.safeContent.predicate))}}var pe=n(8);class ye extends U.d{constructor(e){super(e),this.text="",this.hidePreview=!1,this.title=this.payload.safeContent.title,this.text=this.payload.safeContent.text,this.preview_plain=this.payload.safeContent.preview_plain,this.preview_html=this.payload.safeContent.preview_html,this.hidePreview=this.payload.safeContent.hidePreview,e.format===pe.a.DecryptedBareObject&&(this.prefersPlainEditor=this.getAppDomainValue(U.a.PrefersPlainEditor)),Object(c.q)(this.payload.safeContent.mobilePrefersPlainEditor)||(this.mobilePrefersPlainEditor=this.payload.safeContent.mobilePrefersPlainEditor)}safeText(){return this.text||""}safeTitle(){return this.title||""}}class ge extends U.b{get typedContent(){return this.content}set title(e){this.typedContent.title=e}set text(e){this.typedContent.text=e}set hidePreview(e){this.typedContent.hidePreview=e}set preview_plain(e){this.typedContent.preview_plain=e}set preview_html(e){this.typedContent.preview_html=e}set prefersPlainEditor(e){this.setAppDataItem(U.a.PrefersPlainEditor,e)}}class fe extends U.d{strategyWhenConflictingWithItem(e){return this.errorDecrypting?super.strategyWhenConflictingWithItem(e):G.a.KeepLeft}get keyVersion(){return this.payload.safeContent.version}get isItemsKey(){return!0}get isDefault(){return this.payload.safeContent.isDefault}get itemsKey(){return this.payload.safeContent.itemsKey}get dataAuthenticationKey(){if(this.keyVersion===p.a.V004)throw"Attempting to access legacy data authentication key.";return this.payload.safeContent.dataAuthenticationKey}}class me extends U.b{set isDefault(e){this.content.isDefault=e}}const ve={[Y.a.Note]:ye,[Y.a.Tag]:ue,[Y.a.ItemsKey]:fe,[Y.a.SmartTag]:he,[Y.a.ActionsExtension]:ce,[Y.a.Editor]:te,[Y.a.Theme]:Z,[Y.a.Component]:$,[Y.a.Privileges]:q,[Y.a.UserPrefs]:B};function we(e){return new(ve[e.content_type]||U.d)(e)}var Se;!function(e){e[e.PreparingForLaunch_0=0]="PreparingForLaunch_0",e[e.ReadyForLaunch_05=.5]="ReadyForLaunch_05",e[e.StorageDecrypted_09=.9]="StorageDecrypted_09",e[e.Launched_10=1]="Launched_10",e[e.LoadingDatabase_11=1.1]="LoadingDatabase_11",e[e.LoadedDatabase_12=1.2]="LoadedDatabase_12",e[e.FullSyncCompleted_13=1.3]="FullSyncCompleted_13",e[e.SignedIn_30=3]="SignedIn_30"}(Se||(Se={}));var be,Pe,Oe=n(1);function De(e){return{"mac-web":Pe.MacWeb,"mac-desktop":Pe.MacDesktop,"linux-web":Pe.LinuxWeb,"linux-desktop":Pe.LinuxDesktop,"windows-web":Pe.WindowsWeb,"windows-desktop":Pe.WindowsDesktop,ios:Pe.Ios,android:Pe.Android}[e]}function Ce(e){return e===be.Web||e===be.Desktop}function Ie(e){return e===be.Mobile}!function(e){e[e.Web=1]="Web",e[e.Desktop=2]="Desktop",e[e.Mobile=3]="Mobile"}(be||(be={})),function(e){e[e.Ios=1]="Ios",e[e.Android=2]="Android",e[e.MacWeb=3]="MacWeb",e[e.MacDesktop=4]="MacDesktop",e[e.WindowsWeb=5]="WindowsWeb",e[e.WindowsDesktop=6]="WindowsDesktop",e[e.LinuxWeb=7]="LinuxWeb",e[e.LinuxDesktop=8]="LinuxDesktop"}(Pe||(Pe={}));var Me,je,Ae,Ee,Re,ke,Ke,_e=n(7);!function(e){e[e.Default=1]="Default",e[e.Ephemeral=2]="Ephemeral"}(Me||(Me={})),function(e){e[e.Default=1]="Default",e[e.Disabled=2]="Disabled"}(je||(je={})),function(e){e[e.Default=1]="Default",e[e.Nonwrapped=2]="Nonwrapped"}(Ae||(Ae={})),function(e){e.Wrapped="wrapped",e.Unwrapped="unwrapped",e.Nonwrapped="nonwrapped"}(Ee||(Ee={}));class Te extends l.a{constructor(e,t,n){super(),this.environment=n,this.storagePersistable=!1,this.needsPersist=!1,this.deviceInterface=e,this.identifier=t,this.setPersistencePolicy(Me.Default),this.setEncryptionPolicy(je.Default,!1)}deinit(){this.deviceInterface=void 0,this.encryptionDelegate=void 0,super.deinit()}async handleApplicationStage(e){if(await super.handleApplicationStage(e),e===Se.Launched_10)this.storagePersistable=!0,this.needsPersist&&this.persistValuesToDisk();else if(e===Se.StorageDecrypted_09){const e=await this.getValue(r.StorageEncryptionPolicy);e&&this.setEncryptionPolicy(e,!1)}}async setPersistencePolicy(e){this.persistencePolicy=e,this.persistencePolicy===Me.Ephemeral&&(await this.deviceInterface.removeAllRawStorageValues(),await this.clearAllPayloads())}async setEncryptionPolicy(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];if(e===je.Disabled&&this.environment!==be.Mobile)throw Error("Disabling storage encryption is only available on mobile.");this.encryptionPolicy=e,t&&await this.setValue(r.StorageEncryptionPolicy,e)}isEphemeralSession(){return this.persistencePolicy===Me.Ephemeral}async initializeFromDisk(){const e=await this.deviceInterface.getRawStorageValue(this.getPersistenceKey()),t=e?JSON.parse(e):void 0;this.setInitialValues(t)}setInitialValues(e){e||(e=this.defaultValuesObject()),e[Ee.Unwrapped]||(e[Ee.Unwrapped]={}),this.values=e}isStorageWrapped(){const e=this.values[Ee.Wrapped];return!Object(c.q)(e)&&Object.keys(e).length>0}async canDecryptWithKey(e){const t=this.values[Ee.Wrapped];return!(await this.decryptWrappedValue(t,e)).errorDecrypting}async decryptWrappedValue(e,t){if(!(null==e?void 0:e.content_type))throw Error("Attempting to decrypt nonexistent wrapped value");const n=Object(Oe.e)(e,{content_type:Y.a.EncryptedStorage});return await this.encryptionDelegate.payloadByDecryptingPayload(n,t)}async decryptStorage(){const e=this.values[Ee.Wrapped],t=await this.decryptWrappedValue(e);if(t.errorDecrypting)throw Error("Unable to decrypt storage.");this.values[Ee.Unwrapped]=Object(c.a)(t.contentObject)}async persistValuesToDisk(){if(!this.storagePersistable)return void(this.needsPersist=!0);if(this.persistencePolicy===Me.Ephemeral)return;this.needsPersist=!1;const e=await this.immediatelyPersistValuesToDisk();this.values[Ee.Wrapped]=e[Ee.Wrapped]}async immediatelyPersistValuesToDisk(){return this.executeCriticalFunction((async()=>{const e=await this.generatePersistableValues();return await this.deviceInterface.setRawStorageValue(this.getPersistenceKey(),JSON.stringify(e)),e}))}async generatePersistableValues(){const e=Object.assign({},this.values),t=e[Ee.Unwrapped],n=Object(Oe.e)({uuid:await u.GenerateUuid(),content:t,content_type:Y.a.EncryptedStorage}),i=await this.encryptionDelegate.payloadByEncryptingPayload(n,_e.b.LocalStoragePreferEncrypted);return e[Ee.Wrapped]=i.ejected(),e[Ee.Unwrapped]=void 0,e}async setValue(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ae.Default;if(!this.values)throw Error("Attempting to set storage key ".concat(e," before loading local storage."));return this.values[this.domainKeyForMode(n)][e]=t,this.persistValuesToDisk()}async getValue(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ae.Default,n=arguments.length>2?arguments[2]:void 0;if(!this.values)throw Error("Attempting to get storage key ".concat(e," before loading local storage."));if(!this.values[this.domainKeyForMode(t)])throw Error("Storage domain mode not available ".concat(t," for key ").concat(e));const i=this.values[this.domainKeyForMode(t)][e];return Object(c.q)(i)?n:i}async removeValue(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ae.Default;if(!this.values)throw Error("Attempting to remove storage key ".concat(e," before loading local storage."));const n=this.values[this.domainKeyForMode(t)];if(null==n?void 0:n[e])return delete n[e],this.persistValuesToDisk()}getStorageEncryptionPolicy(){return this.encryptionPolicy}getPersistenceKey(){return a(this.identifier,i.StorageObject)}defaultValuesObject(e,t,n){return Te.defaultValuesObject(e,t,n)}static defaultValuesObject(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return{[Ee.Wrapped]:e,[Ee.Unwrapped]:t,[Ee.Nonwrapped]:n}}domainKeyForMode(e){if(e===Ae.Default)return Ee.Unwrapped;if(e===Ae.Nonwrapped)return Ee.Nonwrapped;throw Error("Invalid mode")}async clearValues(){this.setInitialValues(),await this.immediatelyPersistValuesToDisk()}async getAllRawPayloads(){return this.deviceInterface.getAllRawDatabasePayloads(this.identifier)}async savePayload(e){return this.savePayloads([e])}async savePayloads(e){if(this.persistencePolicy===Me.Ephemeral)return;const t=[];for(const n of e)if(n.discardable)await this.deletePayloadWithId(n.uuid);else{if(!n.uuid)throw Error("Attempting to persist payload with no uuid");const e=await this.encryptionDelegate.payloadByEncryptingPayload(n,this.encryptionPolicy===je.Default?_e.b.LocalStoragePreferEncrypted:_e.b.LocalStorageDecrypted);t.push(e.ejected())}return this.executeCriticalFunction((async()=>this.deviceInterface.saveRawDatabasePayloads(t,this.identifier)))}async deletePayloads(e){for(const t of e)await this.deletePayloadWithId(t.uuid)}async deletePayloadWithId(e){return this.executeCriticalFunction((async()=>this.deviceInterface.removeRawDatabasePayloadWithId(e,this.identifier)))}async clearAllPayloads(){return this.executeCriticalFunction((async()=>this.deviceInterface.removeAllRawDatabasePayloads(this.identifier)))}clearAllData(){return this.executeCriticalFunction((async()=>{await this.clearValues(),await this.clearAllPayloads(),await this.deviceInterface.removeRawStorageValue(a(this.identifier,i.LastMigrationTimestamp)),await this.deviceInterface.removeRawStorageValue(this.getPersistenceKey())}))}}!function(e){e[e.None=0]="None",e[e.LocalPasscode=1]="LocalPasscode",e[e.AccountPassword=2]="AccountPassword",e[e.Biometric=3]="Biometric"}(Re||(Re={})),function(e){e[e.ApplicationUnlock=1]="ApplicationUnlock",e[e.ResaveRootKey=2]="ResaveRootKey",e[e.ProtocolUpgrade=3]="ProtocolUpgrade",e[e.Migration=4]="Migration",e[e.Custom=5]="Custom"}(ke||(ke={})),function(e){e.Alphanumeric="default",e.Numeric="numeric"}(Ke||(Ke={}));class xe{constructor(e,t,n,i,r){this.prompts=e,this.reason=t,this.cancelable=n,this._heading=i,this._subheading=r,this.id=Math.random(),Object.freeze(this)}get modalTitle(){switch(this.reason){case ke.Migration:return"Storage Update";default:return"Authentication Required"}}get heading(){if(this._heading)return this._heading;switch(this.reason){case ke.ApplicationUnlock:return"Authentication is required to unlock the application";case ke.Migration:return"Enter your application passcode";case ke.ResaveRootKey:return"Enter your application passcode to continue";case ke.ProtocolUpgrade:return"Enter your credentials to perform encryption upgrade";default:return}}get subheading(){if(this._subheading)return this._subheading;switch(this.reason){case ke.Migration:return"Your application passcode is required to perform an upgrade of your local data storage structure.";default:return}}hasPromptForValidationType(e){for(const t of this.prompts)if(t.validation===e)return!0;return!1}}class Fe{constructor(e,t,n){let i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=arguments.length>4?arguments[4]:void 0;this.validation=e,this._title=t,this.placeholder=n,this.secureTextEntry=i,this.keyboardType=r,this.id=Math.random(),Object.freeze(this)}get validates(){return this.validation!==Re.None}get title(){if(this._title)return this._title;switch(this.validation){case Re.AccountPassword:return"Account Password";case Re.Biometric:return"Biometrics";case Re.LocalPasscode:return"Application Passcode";default:return}}}class Le{constructor(e,t){this.prompt=e,this.value=t,Object.freeze(this)}}class Ve{constructor(e,t,n){this.challenge=e,this.values=t,this.artifacts=n,Object.freeze(this)}getValueForType(e){return this.values.find((t=>t.prompt.validation===e))}getDefaultValue(){if(this.values.length>1)throw Error("Attempting to retrieve default response value when more than one value exists");return this.values[0]}}var Ne=n(19),Ue=n.n(Ne);function We(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Be(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?We(Object(n),!0).forEach((function(t){He(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):We(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function He(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const qe={[Y.a.Note]:function(e,t,n){const i=n.all(Y.a.Component).map((e=>we(e))).filter((e=>e.area===J.Editor)).find((t=>t.isExplicitlyEnabledForItem(e.uuid)));if(!i)return;const r=new X(i,U.c.Internal);return r.associateWithItem(t.uuid),[r.getResult()]}};async function ze(e,t,n,i){const r=[],s={uuid:await u.GenerateUuid(),dirty:!0,dirtiedDate:new Date,lastSyncBegan:null,lastSyncEnd:null,duplicate_of:e.uuid};s.content=Be(Be({},e.safeContent),i),n&&(s.content.conflict_of=e.uuid);const a=Object(Oe.b)(e,s);r.push(a);const o=t.elementsReferencingElement(e),l=await Qe(o,[{uuid:a.uuid,content_type:a.content_type}]);Object(c.k)(r,l);const d=qe[e.content_type];if(d){const n=d(e,a,t);n&&Object(c.k)(r,n)}return r}async function Je(e,t){const n=[],i=Object(Oe.b)(e,{uuid:await u.GenerateUuid(),dirty:!0,dirtiedDate:new Date,lastSyncBegan:null,lastSyncEnd:null});n.push(i);const r=t.elementsReferencingElement(e),s=await Qe(r,[{uuid:i.uuid,content_type:i.content_type}],[e.uuid]);Object(c.k)(n,s);const a=Object(Oe.b)(e,{deleted:!0,dirty:!1,content:void 0});return n.push(a),n}async function Qe(e,t,n){const i=[];for(const r of e){const e=r.contentObject.references.slice();if(t)for(const n of t)e.push(n);if(n)for(const t of n)Ue()(e,{uuid:t});const s=Object(Oe.b)(r,{dirty:!0,dirtiedDate:new Date,content:Be(Be({},r.safeContent),{},{references:e})});i.push(s)}return i}function Ge(e,t){const n=we(e),i=we(t);return n.isItemContentEqualWith(i)}var Ye=n(2),$e=n(22);class Xe{constructor(e,t,n){this.baseCollection=e,this.applyCollection=t,this.relatedCollectionSet=n}async resultingCollection(){throw"Must override PayloadDelta.resultingCollection."}findBasePayload(e){return this.baseCollection.find(e)}findRelatedPayload(e,t){var n;const i=null===(n=this.relatedCollectionSet)||void 0===n?void 0:n.collectionForSource(t);return null==i?void 0:i.find(e)}}class Ze{constructor(){this.directMap={},this.inverseMap={}}makeCopy(){const e=new Ze;return e.directMap=Object.assign({},this.directMap),e.inverseMap=Object.assign({},this.inverseMap),e}getDirectRelationships(e){return this.directMap[e]||[]}getInverseRelationships(e){return this.inverseMap[e]||[]}establishRelationship(e,t){this.establishDirectRelationship(e,t),this.establishInverseRelationship(e,t)}deestablishRelationship(e,t){this.deestablishDirectRelationship(e,t),this.deestablishInverseRelationship(e,t)}setAllRelationships(e,t){const n=this.directMap[e]||[];this.directMap[e]=t;for(const t of n)this.deestablishInverseRelationship(e,t);for(const n of t)this.establishInverseRelationship(e,n)}removeFromMap(e){const t=this.directMap[e]||[];for(const n of t)Object(c.C)(this.inverseMap[n]||[],e);delete this.directMap[e];const n=this.inverseMap[e]||[];for(const t of n)Object(c.C)(this.directMap[t]||[],e);delete this.inverseMap[e]}establishDirectRelationship(e,t){const n=this.directMap[e]||[];Object(c.b)(n,t),this.directMap[e]=n}establishInverseRelationship(e,t){const n=this.inverseMap[t]||[];Object(c.b)(n,e),this.inverseMap[t]=n}deestablishDirectRelationship(e,t){const n=this.directMap[e]||[];Object(c.C)(n,t),this.directMap[e]=n}deestablishInverseRelationship(e,t){const n=this.inverseMap[t]||[];Object(c.C)(n,e),this.inverseMap[t]=n}}class et{constructor(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1?arguments[1]:void 0,n=arguments.length>2?arguments[2]:void 0,i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;this.map={},this.typedMap=({}={}),this.dirtyIndex=new Set,this.invalidsIndex=new Set,this.nondeletedIndex=new Set,e?(this.map=t,this.typedMap=n,this.referenceMap=i,this.conflictMap=r):(this.referenceMap=new Ze,this.conflictMap=new Ze)}uuids(){return Object.keys(this.map)}all(e){if(e){if(Array.isArray(e)){const t=[];for(const n of e)Object(c.k)(t,this.typedMap[n]||[]);return t}var t;return(null===(t=this.typedMap[e])||void 0===t?void 0:t.slice())||[]}return Object.keys(this.map).map((e=>this.map[e]))}find(e){return this.map[e]}dirtyElements(){const e=Array.from(this.dirtyIndex);return this.findAll(e)}invalidElements(){const e=Array.from(this.invalidsIndex);return this.findAll(e)}nondeletedElements(){const e=Array.from(this.nondeletedIndex);return this.findAll(e)}findAll(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];const n=[];for(const i of e){const e=this.map[i];(e||t)&&n.push(e)}return n}set(e){if(0!==(e=Array.isArray(e)?e:[e]).length)for(const t of e)if(this.map[t.uuid]=t,this.setToTypedMap(t),t.dirty?this.dirtyIndex.add(t.uuid):this.dirtyIndex.delete(t.uuid),t.errorDecrypting||t.waitingForKey?this.invalidsIndex.add(t.uuid):this.invalidsIndex.delete(t.uuid),t.deleted)this.referenceMap.removeFromMap(t.uuid),this.nondeletedIndex.delete(t.uuid);else{this.nondeletedIndex.add(t.uuid);const e=t.safeContent.conflict_of;e&&this.conflictMap.establishRelationship(e,t.uuid),this.referenceMap.setAllRelationships(t.uuid,t.references.map((e=>e.uuid)))}else console.warn("Attempting to set 0 elements onto collection")}discard(e){e=Array.isArray(e)?e:[e];for(const t of e)this.conflictMap.removeFromMap(t.uuid),this.referenceMap.removeFromMap(t.uuid),this.deleteFromTypedMap(t),delete this.map[t.uuid]}setToTypedMap(e){const t=this.typedMap[e.content_type]||[];Ue()(t,{uuid:e.uuid}),t.push(e),this.typedMap[e.content_type]=t}deleteFromTypedMap(e){const t=this.typedMap[e.content_type]||[];Ue()(t,{uuid:e.uuid}),this.typedMap[e.content_type]=t}uuidsThatReferenceUuid(e){if(!Object(c.t)(e))throw Error("Must use uuid string");return this.referenceMap.getInverseRelationships(e)}elementsReferencingElement(e){const t=this.uuidsThatReferenceUuid(e.uuid);return this.findAll(t)}uuidReferencesForUuid(e){if(!Object(c.t)(e))throw Error("Must use uuid string");return this.referenceMap.getDirectRelationships(e)}referencesForElement(e){const t=this.referenceMap.getDirectRelationships(e.uuid);return this.findAll(t)}conflictsOf(e){const t=this.conflictMap.getDirectRelationships(e);return this.findAll(t)}}class tt extends et{static WithPayloads(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[],t=arguments.length>1?arguments[1]:void 0;const n=new tt;return n.source=t,e.length>0&&n.set(e),Object.freeze(n),n}static FromCollection(e){const t=Object.freeze(Object.assign({},e.map)),n=Object.freeze(Object.assign({},e.typedMap)),i=Object.freeze(e.referenceMap.makeCopy()),r=Object.freeze(e.conflictMap.makeCopy()),s=new tt(!0,t,n,i,r);return Object.freeze(s),s}get payloads(){return this.all()}}function nt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function it(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?nt(Object(n),!0).forEach((function(t){rt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):nt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function rt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class st{constructor(e,t,n,i){this.baseCollection=e,this.basePayload=t,this.applyPayload=n,this.source=i}async resultingCollection(){const e=we(this.basePayload),t=we(this.applyPayload),n=e.strategyWhenConflictingWithItem(t),i=await this.payloadsByHandlingStrategy(n);return tt.WithPayloads(i,this.source)}async payloadsByHandlingStrategy(e){const t=this.baseCollection.conflictsOf(this.applyPayload.uuid)[0];if(t&&Ge(t,this.applyPayload))return[];if(e===G.a.KeepLeft){const e=Object(c.o)(this.basePayload.updated_at,this.applyPayload.updated_at);return[Object(Oe.b)(this.basePayload,{updated_at:e,dirty:!0,dirtiedDate:new Date})]}if(e===G.a.KeepRight)return[Object(Oe.g)(this.applyPayload,this.basePayload,[N.a.LastSyncBegan],{lastSyncEnd:new Date})];if(e===G.a.KeepLeftDuplicateRight){const e=Object(c.o)(this.basePayload.updated_at,this.applyPayload.updated_at),t=Object(Oe.b)(this.basePayload,{updated_at:e,dirty:!0,dirtiedDate:new Date}),n=await ze(this.applyPayload,this.baseCollection,!0);return[t].concat(n)}if(e===G.a.DuplicateLeftKeepRight){const e=await ze(this.basePayload,this.baseCollection,!0),t=Object(Oe.g)(this.applyPayload,this.basePayload,[N.a.LastSyncBegan],{lastSyncEnd:new Date});return e.concat([t])}if(e===G.a.KeepLeftMergeRefs){const e=Object(c.K)(this.basePayload.contentObject.references,this.applyPayload.contentObject.references,["uuid","content_type"]),t=Object(c.o)(this.basePayload.updated_at,this.applyPayload.updated_at);return[Object(Oe.b)(this.basePayload,{updated_at:t,dirty:!0,dirtiedDate:new Date,content:it(it({},this.basePayload.safeContent),{},{references:e})})]}throw"Unhandled strategy"}}class at extends Xe{async resultingCollection(){const e=[];for(const t of this.applyCollection.all()){const n=(await this.payloadsByHandlingPayload(t,e)).map((e=>Object(Oe.b)(e,{dirty:!0,dirtiedDate:new Date,deleted:!1})));Object(c.k)(e,n)}return tt.WithPayloads(e,Ye.a.FileImport)}async payloadsByHandlingPayload(e,t){let n=t.find((t=>t.contentObject.conflict_of===e.uuid));if(n||(n=t.find((t=>t.uuid===e.uuid))),n||(n=this.findBasePayload(e.uuid)),!n)return[e];const i=new st(this.baseCollection,n,e,Ye.a.FileImport);return(await i.resultingCollection()).all()}}class ot extends Xe{async resultingCollection(){const e=[];for(const t of this.applyCollection.all()){e.push(t);const n=this.findBasePayload(t.uuid);if(!n)continue;if(Ge(t,n))continue;const i=await ze(n,this.baseCollection,!0);Object(c.k)(e,i)}return tt.WithPayloads(e,Ye.a.RemoteRetrieved)}}class ct extends Xe{async resultingCollection(){if(this.applyCollection.source===Ye.a.ConflictUuid)return this.collectionsByHandlingUuidConflicts();if(this.applyCollection.source===Ye.a.ConflictData)return this.collectionsByHandlingDataConflicts();throw"Unhandled conflict type ".concat(this.applyCollection.source)}async collectionsByHandlingDataConflicts(){const e=[];for(const t of this.applyCollection.all()){const n=this.findBasePayload(t.uuid);if(!n){e.push(t);continue}const i=this.findRelatedPayload(t.uuid,Ye.a.DecryptedTransient);if(!i&&!t.deleted)throw"Unable to find decrypted counterpart for data conflict.";const r=new st(this.baseCollection,n,i||t,Ye.a.ConflictData),s=(await r.resultingCollection()).all();Object(c.k)(e,s)}return tt.WithPayloads(e,Ye.a.RemoteRetrieved)}async collectionsByHandlingUuidConflicts(){const e=[];for(const t of this.applyCollection.all()){const n=this.findRelatedPayload(t.uuid,Ye.a.DecryptedTransient),i=await Je(n,this.baseCollection);Object(c.k)(e,i)}return tt.WithPayloads(e,Ye.a.RemoteRetrieved)}}class lt extends Xe{async resultingCollection(){const e=[],t=[];for(const n of this.applyCollection.all()){const i=this.findRelatedPayload(n.uuid,Ye.a.SavedOrSaving),r=this.findRelatedPayload(n.uuid,Ye.a.DecryptedTransient);if(!r){if(!n.deleted)throw"Cannot find decrypted for non-deleted payload.";e.push(n);continue}if(i){t.push(r);continue}const s=this.findBasePayload(n.uuid);s&&s.dirty?t.push(r):e.push(r)}const n=[];for(const e of t){const t=this.findRelatedPayload(e.uuid,Ye.a.DecryptedTransient);if(!t)continue;const i=this.findBasePayload(e.uuid);if(!i)continue;const r=new st(this.baseCollection,i,t,Ye.a.ConflictData),s=(await r.resultingCollection()).all();Object(c.k)(n,s)}return tt.WithPayloads(e.concat(n),Ye.a.RemoteRetrieved)}}class ut extends Xe{async resultingCollection(){const e=[];for(const t of this.applyCollection.all()){const n=this.findBasePayload(t.uuid),i=n?n.deleted:t.deleted,r=Object(Oe.f)(t,Ye.a.RemoteSaved,{lastSyncEnd:new Date,deleted:i});e.push(r)}return tt.WithPayloads(e,Ye.a.RemoteSaved)}}class dt extends l.a{constructor(e,t,n,i,r,s,a,o,c){super(),this.itemManager=e,this.modelManager=t,this.apiService=n,this.sessionManager=i,this.protocolService=r,this.challengeService=s,this.alertService=a,this.storageService=o,this.syncService=c,this.decryptionQueue=[],this.isProcessingQueue=!1,this.removeItemObserver=this.itemManager.addObserver([Y.a.ItemsKey],((e,t,n,i,r)=>{if(r===Ye.a.LocalChanged)return;const s=e.concat(t).filter((e=>e.errorDecrypting));s.length>0&&this.handleUndecryptableItemsKeys(s),i.length>0&&this.handleIgnoredItemsKeys(i)}))}deinit(){this.itemManager=void 0,this.modelManager=void 0,this.apiService=void 0,this.sessionManager=void 0,this.protocolService=void 0,this.challengeService=void 0,this.alertService=void 0,this.removeItemObserver(),this.removeItemObserver=void 0,super.deinit()}async handleApplicationStage(e){super.handleApplicationStage(e),e===Se.LoadedDatabase_12&&this.processPersistedUndecryptables()}async handleIgnoredItemsKeys(e){(!(arguments.length>1&&void 0!==arguments[1])||arguments[1])&&await this.saveToUndecryptables(e),await this.addKeysToQueue(e,((e,t)=>{t.success&&this.removeFromUndecryptables(e)})),await this.beginProcessingQueue()}async handleUndecryptableItemsKeys(e){await this.addKeysToQueue(e),await this.beginProcessingQueue()}async processPersistedUndecryptables(){const e=await this.getUndecryptables(),t=Object.values(e);if(0===t.length)return;const n=t.map((e=>Object(Oe.e)(e))).map((e=>we(e)));return this.handleIgnoredItemsKeys(n,!1)}async getUndecryptables(){return this.storageService.getValue(r.KeyRecoveryUndecryptableItems,Ae.Default,{})}async persistUndecryptables(e){await this.storageService.setValue(r.KeyRecoveryUndecryptableItems,e)}async saveToUndecryptables(e){const t=await this.getUndecryptables();for(const n of e)t[n.uuid]=n.payload.ejected();await this.persistUndecryptables(t)}async removeFromUndecryptables(e){const t=await this.getUndecryptables();delete t[e.uuid],await this.persistUndecryptables(t)}get queuePromise(){return Promise.all(this.decryptionQueue.map((e=>e.promise)))}async getClientKeyParams(){return this.protocolService.getAccountKeyParams()}serverKeyParamsAreSafe(e){return Object(p.d)(this.serverParams.version,e.version)}async performServerSignIn(e){const t=new xe([new Fe(Re.None,void 0,void 0,!0)],ke.Custom,!0,j.KeyRecoveryLoginFlowPrompt(e),j.KeyRecoveryLoginFlowReason),n=await this.challengeService.promptForChallengeResponse(t);if(!n)return;this.challengeService.completeChallenge(t);const i=n.values[0].value,r=await this.protocolService.computeRootKey(i,e);if((await this.sessionManager.bypassChecksAndSignInWithRootKey(e.identifier,r)).error)return await this.alertService.alert(j.KeyRecoveryLoginFlowInvalidPassword),this.performServerSignIn(e);this.alertService.alert(j.KeyRecoveryRootKeyReplaced)}async getWrappingKeyIfApplicable(){if(!this.protocolService.hasPasscode())return;const{wrappingKey:e,canceled:t}=await this.challengeService.getWrappingKeyIfApplicable();return t?(await this.alertService.alert(j.KeyRecoveryPasscodeRequiredText,j.KeyRecoveryPasscodeRequiredTitle),this.getWrappingKeyIfApplicable()):e}async addKeysToQueue(e,t){for(const n of e){const e=await this.protocolService.getKeyEmbeddedKeyParams(n);if(!e)continue;const i={key:n,keyParams:e,callback:t},r=new Promise((e=>{i.resolve=e}));i.promise=r,this.decryptionQueue.push(i)}}readdQueueItem(e){const t=new Promise((t=>{e.resolve=t}));e.promise=t,this.decryptionQueue.unshift(e)}async beginProcessingQueue(){if(this.isProcessingQueue)return;this.isProcessingQueue=!0;const e=await this.getClientKeyParams();if(!this.serverParams&&e){const t=await this.apiService.getAccountKeyParams(e.identifier);t.error||(this.serverParams=w(t))}let t=this.decryptionQueue[0];for(;t;)this.popQueueItem(t),await t.promise,t=this.decryptionQueue[0];this.queuePromise.then((async()=>{if(this.isProcessingQueue=!1,this.serverParams){const e=await this.getClientKeyParams(),t=e&&!this.serverParams.compare(e);this.serverKeyParamsAreSafe(e)&&t&&await this.performServerSignIn(this.serverParams)}this.syncService.isOutOfSync()&&this.syncService.sync({checkIntegrity:!0})}))}async popQueueItem(e){if(!e.resolve)throw Error("Attempting to pop queue element with no resolve function");Object(c.C)(this.decryptionQueue,e);const t=e.keyParams,n=e.key,i=e.resolve;let r=!1;const s=await this.getClientKeyParams();if(this.serverParams&&s&&!s.compare(this.serverParams)&&t.compare(this.serverParams)&&this.serverKeyParamsAreSafe(this.serverParams)){const e=Object(c.g)(this.itemManager.nonErroredItemsForContentType(Y.a.ItemsKey),N.a.CreatedAt,!1)[0],t=!Object(c.q)(e),i=n.created_at>(null==e?void 0:e.created_at);r=!t||i}const a=new xe([new Fe(Re.None,void 0,void 0,!0)],ke.Custom,!0,j.KeyRecoveryLoginFlowPrompt(t),j.KeyRecoveryPasswordRequired),o=await this.challengeService.promptForChallengeResponse(a);if(!o){var l;const t={success:!1};return i(t),void(null===(l=e.callback)||void 0===l||l.call(e,n,t))}const u=o.values[0].value,d=await this.protocolService.computeRootKey(u,t),h=await this.protocolService.payloadByDecryptingPayload(n.payload,d);if(this.challengeService.completeChallenge(a),h.errorDecrypting)await this.alertService.alert(j.KeyRecoveryUnableToRecover),this.readdQueueItem(e),i({success:!1});else{var p;const s=this.popQueueForKeyParams(t),a=await this.protocolService.payloadsByDecryptingPayloads(s.map((e=>e.key.payload)),d),o=[h].concat(a);if(this.modelManager.emitPayloads(o,Ye.a.DecryptedTransient),await this.storageService.savePayloads(o),r){const e=await this.getWrappingKeyIfApplicable();await this.protocolService.setRootKey(d,e),this.alertService.alert(j.KeyRecoveryRootKeyReplaced)}else this.alertService.alert(j.KeyRecoveryKeyRecovered);const c={success:!0};i(c),null===(p=e.callback)||void 0===p||p.call(e,n,c);for(const e of s){var y;e.resolve(c),null===(y=e.callback)||void 0===y||y.call(e,e.key,c)}}}popQueueForKeyParams(e){const t=[],n=[];for(const i of this.decryptionQueue)i.keyParams.compare(e)?t.push(i):n.push(i);return this.decryptionQueue=n,t}}var ht,pt,yt,gt,ft=n(10),mt=n(12);!function(e){e[e.Info=0]="Info",e[e.Danger=1]="Danger"}(ht||(ht={}));class vt{static FromRawStorageValue(e){if(e.jwt)return new wt(e.jwt);{const t=e;return new St(t.accessToken,t.accessExpiration,t.refreshToken,t.refreshExpiration)}}}class wt extends vt{constructor(e){super(),this.jwt=e}get authorizationValue(){return this.jwt}canExpire(){return!1}}class St extends vt{constructor(e,t,n,i){super(),this.accessToken=e,this.accessExpiration=t,this.refreshToken=n,this.refreshExpiration=i}static FromApiResponse(e){const t=e.session.access_token,n=e.session.refresh_token,i=e.session.access_expiration,r=e.session.refresh_expiration;return new St(t,i,n,r)}getExpireAt(){return this.accessExpiration||0}get authorizationValue(){return this.accessToken}canExpire(){return!0}isExpired(){return this.getExpireAt()<Date.now()}}function bt(e){return e.status===yt.HttpStatusExpiredAccessToken}function Pt(e,t){const n=String(e);let i=String(t);const r=n.length;let s=0;r!==i.length&&(i=n,s=1);for(let e=0;e<r;e++)s|=n.charCodeAt(e)^i.charCodeAt(e);return 0===s}function Ot(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Dt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Ot(Object(n),!0).forEach((function(t){Ct(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Ot(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Ct(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e.LastSyncToken="sync_token",e.PaginationToken="cursor_token",e.IntegrityCheck="compute_integrity",e.IntegrityResult="integrity_hash",e.SyncDlLimit="limit",e.SyncPayloads="items",e.ApiVersion="api"}(pt||(pt={})),function(e){e[e.HttpStatusMinSuccess=200]="HttpStatusMinSuccess",e[e.HttpStatusMaxSuccess=299]="HttpStatusMaxSuccess",e[e.HttpStatusExpiredAccessToken=498]="HttpStatusExpiredAccessToken",e[e.HttpStatusInvalidSession=401]="HttpStatusInvalidSession",e[e.LocalValidationError=10]="LocalValidationError",e[e.CanceledMfa=11]="CanceledMfa"}(yt||(yt={})),function(e){e.ConflictingData="sync_conflict",e.UuidConflict="uuid_conflict"}(gt||(gt={}));class It extends U.d{constructor(e,t){super(e),this.keyParams=t}static async Create(e,t){t||(t=await u.GenerateUuid()),e.version||(e.dataAuthenticationKey?e.version=p.a.V002:e.version=p.a.V001);const n=Object(Oe.e)({uuid:t,content_type:Y.a.RootKey,content:Object(ft.a)(e)}),i=e.keyParams;if(!i)throw Error("Attempting to create root key without key params");const r=i instanceof S?i:new S(i);return new It(n,r)}static async ExpandedCopy(e,t){const n=e.typedContent;return await this.Create(Dt(Dt({},n),{},{keyParams:t||n.keyParams}))}get typedContent(){return this.safeContent}get keyVersion(){if(!this.payload.safeContent.version)throw"Attempting to create key without version.";return this.payload.safeContent.version}get isRootKey(){return!0}get itemsKey(){return this.masterKey}get masterKey(){return this.payload.safeContent.masterKey}get serverPassword(){return this.payload.safeContent.serverPassword}get dataAuthenticationKey(){return this.payload.safeContent.dataAuthenticationKey}compare(e){if(this.keyVersion!==e.keyVersion)return!1;const t=this.serverPassword&&e.serverPassword;return Pt(this.masterKey,e.masterKey)&&(!t||Pt(this.serverPassword,e.serverPassword))}persistableValueWhenWrapping(){const e=this.getKeychainValue();return e.keyParams=this.keyParams.getPortableValue(),e}getKeychainValue(){const e={version:this.keyVersion};return this.masterKey&&(e.masterKey=this.masterKey),this.dataAuthenticationKey&&(e.dataAuthenticationKey=this.dataAuthenticationKey),e}}const Mt=e=>e.trim().toLowerCase();var jt,At;!function(e){e.SessionRestored="SessionRestored"}(jt||(jt={}));class Et extends l.a{constructor(e,t,n,i,r){super(),this.storageService=e,this.apiService=t,this.alertService=n,this.protocolService=i,this.challengeService=r,this.isSessionRenewChallengePresented=!1,t.setInvalidSessionObserver((()=>{this.reauthenticateInvalidSession()}))}deinit(){this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.alertService=void 0,this.user=void 0,super.deinit()}async initializeFromDisk(){if(this.user=await this.storageService.getValue(r.User),!this.user){const e=await this.storageService.getValue(r.LegacyUuid);e&&(this.user={uuid:e})}const e=await this.storageService.getValue(r.Session);e&&await this.setSession(vt.FromRawStorageValue(e),!1)}async setSession(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];await this.apiService.setSession(e,t)}online(){return!this.offline()}offline(){return Object(c.q)(this.apiService.getSession())}getUser(){if(this.user&&!this.apiService.getSession())throw Error("User is defined but no session is present.");return this.user}async signOut(){this.user=void 0;const e=this.apiService.getSession();e&&e.canExpire()&&await this.apiService.signOut()}async reauthenticateInvalidSession(){if(this.isSessionRenewChallengePresented)return;this.isSessionRenewChallengePresented=!0;const e=new xe([new Fe(Re.None,void 0,_,!1),new Fe(Re.None,void 0,T)],ke.Custom,!0,A,E(this.getUser().email));this.challengeService.addChallengeObserver(e,{onCancel:()=>{this.isSessionRenewChallengePresented=!1},onComplete:()=>{this.isSessionRenewChallengePresented=!1},onNonvalidatedSubmit:async t=>{const n=t.values[0].value,i=t.values[1].value,r=await this.protocolService.getAccountKeyParams();(await this.signIn(n,i,!1,r.version)).response.error?this.challengeService.setValidationStatusForChallenge(e,t.values[1],!1):(this.challengeService.completeChallenge(e),this.notifyEvent(jt.SessionRestored),this.alertService.alert(R))}}),this.challengeService.promptForChallengeResponse(e)}async promptForMfaValue(){const e=new xe([new Fe(Re.None,void 0,K,!1,Ke.Numeric)],ke.Custom,!0,k),t=await this.challengeService.promptForChallengeResponse(e);if(t)return this.challengeService.completeChallenge(e),t.values[0].value}async register(e,t){if(t.length<8)return{response:this.apiService.createErrorResponse(C(8))};const{wrappingKey:n,canceled:i}=await this.challengeService.getWrappingKeyIfApplicable();if(i)return{response:this.apiService.createErrorResponse("Your passcode is required in order to register for an account.",yt.LocalValidationError)};e=Mt(e);const r=await this.protocolService.createRootKey(e,t,h.Registration),s=r.serverPassword,a=r.keyParams,o=await this.apiService.register(e,s,a);return o.error||await this.handleSuccessAuthResponse(o,r,n),{response:o,rootKey:r}}async retrieveKeyParams(e,t,n){const i=await this.apiService.getAccountKeyParams(e,t,n);if(i.error){var r;if(n&&await this.alertService.alert(I),null===(r=i.error.payload)||void 0===r?void 0:r.mfa_key){const t=await this.promptForMfaValue();return t?this.retrieveKeyParams(e,i.error.payload.mfa_key,t):{response:this.apiService.createErrorResponse(M,yt.CanceledMfa)}}return{response:i}}const s=w(i,e);return s&&s.version?{keyParams:s,response:i,mfaKeyPath:t,mfaCode:n}:{response:this.apiService.createErrorResponse(O)}}async signIn(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;const r=await this.performSignIn(e,t,n,i);if(r.response.error&&r.response.error.status!==yt.LocalValidationError&&r.response.error.status!==yt.CanceledMfa){const r=Mt(e);return await this.performSignIn(r,t,n,i)}return r}async performSignIn(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;const r=await this.retrieveKeyParams(e);if(r.response.error)return{response:r.response};const s=r.keyParams;if(!this.protocolService.supportedVersions().includes(s.version))return this.protocolService.isVersionNewerThanLibraryVersion(s.version)?{response:this.apiService.createErrorResponse("This version of the application does not support your newer account type. Please upgrade to the latest version of Standard Notes to sign in.")}:{response:this.apiService.createErrorResponse("The protocol version associated with your account is outdated and no longer supported by this application. Please visit standardnotes.org/help/security for more information.")};if(this.protocolService.isProtocolVersionOutdated(s.version)){const e=this.protocolService.costMinimumForVersion(s.version);if(s.content002.pw_cost<e)return{response:this.apiService.createErrorResponse("Unable to login due to insecure password parameters. Please visit standardnotes.org/help/security for more information.")};const t="The encryption version for your account is outdated and requires upgrade. You may proceed with login, but are advised to perform a security update using the web or desktop application. Please visit standardnotes.org/help/security for more information.";if(!await this.alertService.confirm(t,"Update Recommended","Sign In"))return{response:this.apiService.createErrorResponse(O)}}if(!this.protocolService.platformSupportsKeyDerivation(s))return{response:this.apiService.createErrorResponse("Your account was created on a platform with higher security capabilities than this browser supports. If we attempted to generate your login keys here, it would take hours. Please use a browser with more up to date security capabilities, like Google Chrome or Firefox, to log in.")};if(n&&(i=this.protocolService.getLatestVersion()),!Object(c.q)(i)&&!Object(p.d)(s.version,i))return{response:this.apiService.createErrorResponse((a=s.version,o=i,"Strict Sign In has refused the server's sign-in parameters. The latest account version is ".concat(o,", but the server is reporting a version of ").concat(a," for your account. If you'd like to proceed with sign in anyway, please disable Strict Sign In and try again.")))};var a,o;const l=await this.protocolService.computeRootKey(t,s);return{response:await this.bypassChecksAndSignInWithRootKey(e,l,r.mfaKeyPath,r.mfaCode)}}async bypassChecksAndSignInWithRootKey(e,t,n,i){const{wrappingKey:r,canceled:s}=await this.challengeService.getWrappingKeyIfApplicable();if(s)return this.apiService.createErrorResponse("Your passcode is required in order to sign in to your account.",yt.LocalValidationError);const a=await this.apiService.signIn(e,t.serverPassword,n,i);if(a.error){var o;if(null===(o=a.error.payload)||void 0===o?void 0:o.mfa_key){i&&await this.alertService.alert(I);const n=await this.promptForMfaValue();return n?this.bypassChecksAndSignInWithRootKey(e,t,a.error.payload.mfa_key,n):this.apiService.createErrorResponse(M,yt.CanceledMfa)}return a}{const e=await It.ExpandedCopy(t,a.key_params);return await this.handleSuccessAuthResponse(a,e,r),a}}async changePassword(e,t,n){const i=await this.apiService.changePassword(e,t.serverPassword,t.keyParams);return i.error||await this.handleSuccessAuthResponse(i,t,n),{response:i,keyParams:i.key_params}}getSessionsList(){return this.apiService.getSessionsList()}async handleSuccessAuthResponse(e,t,n){await this.protocolService.setRootKey(t,n);const i=e.user;if(this.user=i,await this.storageService.setValue(r.User,i),e.token){const t=new wt(e.token);await this.setSession(t)}else if(e.session){const t=St.FromApiResponse(e);await this.setSession(t)}}}!function(e){e.Get="get",e.Post="post",e.Patch="patch"}(At||(At={}));class Rt extends l.a{async getAbsolute(e,t,n){return this.runHttp({url:e,params:t,verb:At.Get,authentication:n})}async postAbsolute(e,t,n){return this.runHttp({url:e,params:t,verb:At.Post,authentication:n})}async patchAbsolute(e,t,n){return this.runHttp({url:e,params:t,verb:At.Patch,authentication:n})}async runHttp(e){const t=this.createXmlRequest(e);return this.runRequest(t,e.verb,e.params)}createXmlRequest(e){const t=new XMLHttpRequest;return e.params&&e.verb===At.Get&&Object.keys(e.params).length>0&&(e.url=this.urlForUrlAndParams(e.url,e.params)),t.open(e.verb,e.url,!0),t.setRequestHeader("Content-type","application/json"),e.authentication&&t.setRequestHeader("Authorization","Bearer "+e.authentication),t}async runRequest(e,t,n){return new Promise(((i,r)=>{e.onreadystatechange=()=>{this.stateChangeHandlerForRequest(e,i,r)},t===At.Post||t===At.Patch?e.send(JSON.stringify(n)):e.send()}))}stateChangeHandlerForRequest(e,t,n){if(4!==e.readyState)return;const i=e.status;let r={status:i};try{const t=JSON.parse(e.responseText);r.object=t,Object.assign(r,t)}catch(e){}i>=yt.HttpStatusMinSuccess&&i<=yt.HttpStatusMaxSuccess?t(r):(r.error||(r.error={message:"Unknown error.",status:i}),n(r))}urlForUrlAndParams(e,t){const n=Object.keys(t).map((e=>e+"="+encodeURIComponent(t[e]))).join("&");return e.includes("?")?e+"&"+n:e+"?"+n}}function kt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Kt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?kt(Object(n),!0).forEach((function(t){_t(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):kt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function _t(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Tt extends l.a{constructor(e,t,n){super(),this.httpService=e,this.storageService=t,this.registering=!1,this.authenticating=!1,this.changing=!1,this.refreshingSession=!1,this.host=n}deinit(){this.httpService=void 0,this.storageService=void 0,this.invalidSessionObserver=void 0,this.host=void 0,this.session=void 0,super.deinit()}setInvalidSessionObserver(e){this.invalidSessionObserver=e}async loadHost(){const e=await this.storageService.getValue(r.ServerHost);this.host=e||this.host||window._default_sync_server}async setHost(e){this.host=e,await this.storageService.setValue(r.ServerHost,e)}async getHost(){return this.host}async setSession(e){let t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this.session=e,t&&await this.storageService.setValue(r.Session,e)}getSession(){return this.session}async path(e){const t=await this.getHost();if(!t)throw"Attempting to build path ".concat(e," with no host.");if(!e)throw"Attempting to build path with null path.";return Object(c.v)(t,e)}params(e){return se()(e,{[pt.ApiVersion]:"20200115"})}createErrorResponse(e,t){return{error:{message:e,status:t}}}errorResponseWithFallbackMessage(e,t){return e.error.message||(e.error.message=t),e}async getAccountKeyParams(e,t,n){var i;const r=await this.path("/auth/params"),s=this.params({email:e});return t&&(s[t]=n),await this.httpService.getAbsolute(r,s,null===(i=this.session)||void 0===i?void 0:i.authorizationValue).catch((e=>this.errorResponseWithFallbackMessage(e,b)))}async register(e,t,n){if(this.registering)return this.createErrorResponse("An existing registration request is already in progress.");this.registering=!0;const i=await this.path("/auth"),r=this.params(Kt({password:t,email:e},n.getPortableValue())),s=await this.httpService.postAbsolute(i,r).catch((e=>this.errorResponseWithFallbackMessage(e,"A server error occurred while trying to register. Please try again.")));return this.registering=!1,s}async signIn(e,t,n,i){if(this.authenticating)return this.createErrorResponse("An existing sign in request is already in progress.");this.authenticating=!0;const r=await this.path("/auth/sign_in"),s=this.params({email:e,password:t});n&&(s[n]=i);const a=await this.httpService.postAbsolute(r,s).catch((e=>this.errorResponseWithFallbackMessage(e,b)));return this.authenticating=!1,a}async signOut(){const e=await this.path("/auth/sign_out");return this.httpService.postAbsolute(e,void 0,this.session.authorizationValue).catch((e=>e))}async changePassword(e,t,n){if(this.changing)return this.createErrorResponse("An existing change password request is already in progress.");const i=this.preprocessingError();if(i)return i;this.changing=!0;const r=await this.path("/auth/change_pw"),s=this.params(Kt({current_password:e,new_password:t},n.getPortableValue())),a=await this.httpService.postAbsolute(r,s,this.session.authorizationValue).catch((async e=>bt(e)?this.refreshSessionThenRetryRequest({verb:At.Post,url:r,params:s}):this.errorResponseWithFallbackMessage(e,"Something went wrong while changing your password. Your password was not changed. Please try again.")));return this.changing=!1,a}async sync(e,t,n,i){let r=arguments.length>4&&void 0!==arguments[4]&&arguments[4],s=arguments.length>5?arguments[5]:void 0,a=arguments.length>6?arguments[6]:void 0;const o=this.preprocessingError();if(o)return o;const c=await this.path("/items/sync"),l=this.params({[pt.SyncPayloads]:e.map((e=>e.ejected())),[pt.LastSyncToken]:t,[pt.PaginationToken]:n,[pt.IntegrityCheck]:r,[pt.SyncDlLimit]:i,content_type:s,event:a});return await this.httpService.postAbsolute(c,l,this.session.authorizationValue).catch((async e=>(this.preprocessAuthenticatedErrorResponse(e),bt(e)?this.refreshSessionThenRetryRequest({verb:At.Post,url:c,params:l}):this.errorResponseWithFallbackMessage(e,P))))}async refreshSessionThenRetryRequest(e){const t=await this.refreshSession();return(null==t?void 0:t.error)?t:this.httpService.runHttp(Kt(Kt({},e),{},{authentication:this.session.authorizationValue})).catch((e=>e))}async refreshSession(){const e=this.preprocessingError();if(e)return e;this.refreshingSession=!0;const t=await this.path("/session/refresh"),n=this.session,i=this.params({access_token:n.accessToken,refresh_token:n.refreshToken}),r=await this.httpService.postAbsolute(t,i).then((async e=>{const t=St.FromApiResponse(e);return await this.setSession(t),e})).catch((e=>(this.preprocessAuthenticatedErrorResponse(e),this.errorResponseWithFallbackMessage(e,"A server error occurred while trying to refresh your session. Please try again."))));return this.refreshingSession=!1,r}async getSessionsList(){const e=this.preprocessingError();if(e)return e;const t=await this.path("/sessions");return await this.httpService.getAbsolute(t,{},this.session.authorizationValue).catch((async e=>(this.preprocessAuthenticatedErrorResponse(e),bt(e)?this.refreshSessionThenRetryRequest({verb:At.Get,url:t}):this.errorResponseWithFallbackMessage(e,P))))}async getItemRevisions(e){const t=this.preprocessingError();if(t)return t;const n="/items/:item_id/revisions".replace(/:item_id/,e),i=await this.path(n);return await this.httpService.getAbsolute(i,void 0,this.session.authorizationValue).catch((e=>(this.preprocessAuthenticatedErrorResponse(e),bt(e)?this.refreshSessionThenRetryRequest({verb:At.Get,url:i}):this.errorResponseWithFallbackMessage(e,P))))}async getRevision(e,t){const n=this.preprocessingError();if(n)return n;const i="/items/:item_id/revisions/:id".replace(/:item_id/,t).replace(/:id/,e.uuid),r=await this.path(i);return await this.httpService.getAbsolute(r,void 0,this.session.authorizationValue).catch((e=>(this.preprocessAuthenticatedErrorResponse(e),bt(e)?this.refreshSessionThenRetryRequest({verb:At.Get,url:r}):this.errorResponseWithFallbackMessage(e,P))))}preprocessingError(){return this.refreshingSession?this.createErrorResponse("Your account session is being renewed with the server. Please try your request again."):this.session?void 0:this.createErrorResponse("Please sign in to an account in order to continue with your request.")}preprocessAuthenticatedErrorResponse(e){var t;e.status===yt.HttpStatusInvalidSession&&this.session&&(null===(t=this.invalidSessionObserver)||void 0===t||t.call(this))}}var xt=n(17),Ft=n.n(xt),Lt=n(23),Vt=n.n(Lt);function Nt(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Ut(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Nt(Object(n),!0).forEach((function(t){Wt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Nt(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Wt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const Bt="sn://",Ht="localhost",qt="org.standardnotes.sn.components";class zt extends l.a{constructor(e,t,n,i,r,s){super(),this.componentState={},this.streamObservers=[],this.contextStreamObservers=[],this.permissionDialogs=[],this.handlers=[],this.templateComponents=[],this.detectFocusChange=()=>{const e=this.allComponentIframes();for(const t of e)if(document.activeElement===t){this.timeout((()=>{const e=this.findComponent(t.dataset.componentId);for(const t of this.handlers)t.focusHandler&&t.focusHandler(e,!0)}));break}},this.onWindowMessage=e=>{e.data.sessionKey&&(this.log("Component manager received message",e.data),this.handleMessage(this.componentForSessionKey(e.data.sessionKey),e.data))},this.timeout=s||setTimeout.bind(window),this.itemManager=e,this.syncService=t,this.alertService=n,this.environment=i,this.platform=r,this.configureForGeneralUsage(),i!==be.Mobile&&this.configureForNonMobileUsage()}get isDesktop(){return this.environment===be.Desktop}get isMobile(){return this.environment===be.Mobile}get components(){return this.itemManager.getItems([Y.a.Component,Y.a.Theme])}componentsForArea(e){return this.components.filter((t=>t.area===e))}deinit(){super.deinit(),this.streamObservers.length=0,this.contextStreamObservers.length=0,this.permissionDialogs.length=0,this.templateComponents.length=0,this.handlers.length=0,this.itemManager=void 0,this.syncService=void 0,this.alertService=void 0,this.removeItemObserver(),this.removeItemObserver=null,window&&!this.isMobile&&(window.removeEventListener("focus",this.detectFocusChange,!0),window.removeEventListener("blur",this.detectFocusChange,!0),window.removeEventListener("message",this.onWindowMessage))}setDesktopManager(e){this.desktopManager=e,this.configureForDesktop()}configureForGeneralUsage(){this.removeItemObserver=this.itemManager.addObserver(Y.a.Any,((e,t,n,i,r,s)=>{const a=Object(c.f)(e,t,n),o=a.filter((e=>e.content_type===Y.a.Component||e.content_type===Y.a.Theme));o.length>0&&r!==Ye.a.RemoteSaved&&this.isDesktop&&this.desktopManager.syncComponentsInstallation(o),o.filter((e=>e.isTheme())).length>0&&this.postActiveThemesToAllComponents();for(const e of o){if(e.isEditor())continue;const t=!!this.iframeForComponent(e.uuid);!e.active&&t&&this.deactivateComponent(e.uuid)}r!==Ye.a.LocalChanged&&this.notifyStreamObservers(a,r,s)}))}notifyStreamObservers(e,t,n){for(const t of this.streamObservers){if(n&&n===t.componentUuid)continue;const i=e.filter((e=>-1!==t.contentTypes.indexOf(e.content_type)));if(0===i.length)continue;const r=[{name:Q.StreamItems,content_types:t.contentTypes.sort()}];this.runWithPermissions(t.componentUuid,r,(()=>{this.sendItemsInReply(t.componentUuid,i,t.originalMessage)}))}const i=[{name:Q.StreamContextItem}];for(const r of this.contextStreamObservers)if(!n||n!==r.componentUuid)for(const n of this.handlers)if((n.areas.includes(r.area)||n.areas.includes(J.Any))&&n.contextRequestHandler){const s=n.contextRequestHandler(r.componentUuid);if(s){const n=Ft()(e,{uuid:s.uuid});if(n){if(n.deleted)continue;this.runWithPermissions(r.componentUuid,i,(()=>{this.sendContextItemInReply(r.componentUuid,n,r.originalMessage,t)}))}}}}isNativeExtension(e){const t=[window._extensions_manager_location,window._batch_manager_location],n=e.hosted_url,i=e.local_url&&e.local_url.replace(Bt,"");return t.includes(n)||t.includes(i)}configureForNonMobileUsage(){window.addEventListener?window.addEventListener("focus",this.detectFocusChange,!0):window.attachEvent("onfocusout",this.detectFocusChange),window.addEventListener?window.addEventListener("blur",this.detectFocusChange,!0):window.attachEvent("onblur",this.detectFocusChange),window.addEventListener("message",this.onWindowMessage)}configureForDesktop(){this.desktopManager.registerUpdateObserver((e=>{e.active&&e.isTheme()&&this.postActiveThemesToAllComponents()}))}postActiveThemesToAllComponents(){for(const e of this.components)this.findOrCreateDataForComponent(e.uuid).window&&this.postActiveThemesToComponent(e)}getActiveThemes(){if(this.environment===be.Mobile)throw Error("getActiveThemes must be handled separately by mobile");return this.componentsForArea(J.Themes).filter((e=>e.active))}urlsForActiveThemes(){const e=this.getActiveThemes(),t=[];for(const n of e){const e=this.urlForComponent(n);e&&t.push(e)}return t}postActiveThemesToComponent(e){const t={themes:this.urlsForActiveThemes()},n={action:Q.ActivateThemes,data:t};this.sendMessageToComponent(e,n)}findComponent(e){return this.templateComponents.find((t=>t.uuid===e))||this.itemManager.findItem(e)}addTemporaryTemplateComponent(e){this.templateComponents.push(e)}removeTemporaryTemplateComponent(e){this.templateComponents=this.templateComponents.filter((t=>t.uuid!==e.uuid))}contextItemDidChangeInArea(e){for(const t of this.handlers){if(!t.areas.includes(e)&&!t.areas.includes(J.Any))continue;const n=this.contextStreamObservers.filter((t=>t.area===e));for(const e of n)if(t.contextRequestHandler){const n=t.contextRequestHandler(e.componentUuid);n&&this.sendContextItemInReply(e.componentUuid,n,e.originalMessage)}}}isComponentHidden(e){return this.findOrCreateDataForComponent(e.uuid).hidden}setComponentHidden(e,t){const n=this.findOrCreateDataForComponent(e.uuid);if(t)n.hidden=!0;else if(n.hidden){n.hidden=!1;const t=Ft()(this.contextStreamObservers,{identifier:e.uuid});t&&this.handleStreamContextItemMessage(e,t.originalMessage);const i=Ft()(this.streamObservers,{identifier:e.uuid});i&&this.handleStreamItemsMessage(e,i.originalMessage)}}jsonForItem(e,t,n){const i=n===Ye.a.RemoteSaved||n===Ye.a.LocalSaved||n===Ye.a.PreSyncSave,r=(e.getDomainData(qt)||{})[t.getClientDataKey()]||{},s={uuid:e.uuid,content_type:e.content_type,created_at:e.created_at,updated_at:e.updated_at,deleted:e.deleted,isMetadataUpdate:i,content:e.content,clientData:r};return this.responseItemsByRemovingPrivateProperties([s],t)[0]}sendItemsInReply(e,t,n,i){const r=this.findComponent(e);this.log("Component manager send items in reply",r,t,n);const s={},a=t.map((e=>this.jsonForItem(e,r,i)));s.items=a,this.replyToMessage(r,n,s)}sendContextItemInReply(e,t,n,i){const r=this.findComponent(e);this.log("Component manager send context item in reply",r,t,n);const s={item:this.jsonForItem(t,r,i)};this.replyToMessage(r,n,s)}replyToMessage(e,t,n){const i={action:Q.Reply,original:t,data:n};this.sendMessageToComponent(e,i)}sendMessageToComponent(e,t){const n=[Q.ComponentRegistered,Q.ActivateThemes],i=this.findOrCreateDataForComponent(e.uuid);if(i.hidden&&!n.includes(t.action))return void this.log("Component disabled for current item, ignoring messages.",e.name);this.log("Component manager send message to component",e,t);let r=this.urlForComponent(e);r&&i.window||this.alertService.alert("Standard Notes is trying to communicate with ".concat(e.name,",\n        but an error is occurring. Please restart this extension and try again.")),r.startsWith("http")||r.startsWith("file")||(r=window.location.href+r),i.window.postMessage(this.isMobile?JSON.stringify(t):t,r)}urlForComponent(e){if(e.offlineOnly&&!this.isDesktop)return null;if(e.offlineOnly||this.isDesktop&&e.local_url)return e.local_url&&e.local_url.replace(Bt,this.desktopManager.getExtServerHost());{let t=e.hosted_url||e.legacy_url;if(this.isMobile){const e=this.platform===Pe.Ios?Ht:"10.0.2.2";t=t.replace(Ht,e).replace("sn.local",e)}return t}}componentForUrl(e){return this.components.filter((t=>t.hosted_url===e||t.legacy_url===e))[0]}sessionKeyForComponent(e){return this.findOrCreateDataForComponent(e.uuid).sessionKey}componentForSessionKey(e){let t;for(const n of Object.keys(this.componentState)){const i=this.componentState[n];if((null==i?void 0:i.sessionKey)===e){t=this.components.find((e=>e.uuid===n));break}}if(!t)for(const n of this.handlers)if(n.componentForSessionKeyHandler&&(t=n.componentForSessionKeyHandler(e),t))break;return t}handleMessage(e,t){if(!e)return this.log("Component not defined for message, returning",t),void this.alertService.alert("An extension is trying to communicate with Standard Notes,but there is an error establishing a bridge. Please restart the app and try again.");const n=[Q.SaveItems,Q.AssociateItem,Q.DeassociateItem,Q.CreateItem,Q.CreateItems,Q.DeleteItems,Q.SetComponentData];if(this.getReadonlyStateForComponent(e).readonly&&n.includes(t.action))this.alertService.alert("The extension ".concat(e.name," is trying to save, but it is in a locked state and cannot accept changes."));else{if(t.action===Q.StreamItems)this.handleStreamItemsMessage(e,t);else if(t.action===Q.StreamContextItem)this.handleStreamContextItemMessage(e,t);else if(t.action===Q.SetComponentData)this.handleSetComponentDataMessage(e,t);else if(t.action===Q.DeleteItems)this.handleDeleteItemsMessage(e,t);else if(t.action===Q.CreateItems||t.action===Q.CreateItem)this.handleCreateItemsMessage(e,t);else if(t.action===Q.SaveItems)this.handleSaveItemsMessage(e,t);else if(t.action===Q.ToggleActivateComponent){const e=this.itemManager.findItem(t.data.uuid);this.handleToggleComponentMessage(e)}else t.action===Q.RequestPermissions?this.handleRequestPermissionsMessage(e,t):t.action===Q.InstallLocalComponent?this.handleInstallLocalComponentMessage(e,t):t.action===Q.DuplicateItem&&this.handleDuplicateItemMessage(e,t);for(const n of this.handlers)n.actionHandler&&(n.areas.includes(e.area)||n.areas.includes(J.Any))&&this.timeout((()=>{n.actionHandler(e,t.action,t.data)}))}}responseItemsByRemovingPrivateProperties(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(t&&this.isNativeExtension(t))return e;let i=["autoupdateDisabled","permissions","active"];return n&&(i=i.concat(["hosted_url","local_url"])),e.map((e=>{const t=i.slice();if(n&&e.content_type!==Y.a.ServerExtension&&t.push("url"),!e.content||Object(c.t)(e.content))return e;const r={};for(const[n,i]of Object.entries(e.content))t.includes(n)||(r[n]=i);return Ut(Ut({},e),{},{content:r})}))}handleStreamItemsMessage(e,t){const n=[{name:Q.StreamItems,content_types:t.data.content_types.sort()}];this.runWithPermissions(e.uuid,n,(()=>{Ft()(this.streamObservers,{identifier:e.uuid})||this.streamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t,contentTypes:t.data.content_types});const n=[];for(const e of t.data.content_types)Object(c.k)(n,this.itemManager.nonErroredItemsForContentType(e));this.sendItemsInReply(e.uuid,n,t)}))}handleStreamContextItemMessage(e,t){const n=[{name:Q.StreamContextItem}];this.runWithPermissions(e.uuid,n,(()=>{Ft()(this.contextStreamObservers,{identifier:e.uuid})||this.contextStreamObservers.push({identifier:e.uuid,componentUuid:e.uuid,area:e.area,originalMessage:t});for(const n of this.handlersForArea(e.area))if(n.contextRequestHandler){const i=n.contextRequestHandler(e.uuid);i&&this.sendContextItemInReply(e.uuid,i,t)}}))}isItemIdWithinComponentContextJurisdiction(e,t){return this.itemIdsInContextJurisdictionForComponent(t).includes(e)}itemIdsInContextJurisdictionForComponent(e){const t=[];for(const n of this.handlersForArea(e.area))if(n.contextRequestHandler){const i=n.contextRequestHandler(e.uuid);i&&t.push(i.uuid)}return t}handlersForArea(e){return this.handlers.filter((t=>t.areas.includes(e)))}async handleSaveItemsMessage(e,t){let n=t.data.items;const i=[],r=this.itemIdsInContextJurisdictionForComponent(e),s=n.slice();for(const e of n.slice())if(r.includes(e.uuid)){i.push({name:Q.StreamContextItem}),Object(c.C)(s,e);break}if(s.length>0){const e=Vt()(s.map((e=>e.content_type))).sort();i.push({name:Q.StreamItems,content_types:e})}this.runWithPermissions(e.uuid,i,(async()=>{n=this.responseItemsByRemovingPrivateProperties(n,e,!0);const i=Object(ft.b)(n),r=this.itemManager.findItems(i,!0);let s=0,a=0;for(let[t,i]of r.entries()){if(!i){const i=n[t];return void this.alertService.alert("The extension ".concat(e.name," is trying to save an item with type ")+"".concat(i.content_type,", but that item does not exist.")+"Please restart this extension and try again.")}i.locked&&(Ue()(n,{uuid:i.uuid}),s++,i.content_type===Y.a.Note&&a++)}if(1===a)return void this.alertService.alert("The note you are attempting to save is locked and cannot be edited.","Note Locked");if(s>0){const e=1===s?"item":a===s?"notes":"items",t=1===s?"is":"are";return void this.alertService.alert("".concat(s," ").concat(e," you are attempting to save ").concat(t," locked and cannot be edited."),"Items Locked")}const o=n.map((e=>Object(Oe.f)(e,Ye.a.ComponentRetrieved)));await this.itemManager.changeItems(i,(t=>{const i=Object(c.E)(o,{uuid:t.getUuid()});t.mergePayload(i);const r=Object(c.E)(n,{uuid:t.getUuid()});if(r.clientData){const n=Object(c.a)(t.getItem().getDomainData(qt)||{});n[e.getClientDataKey()]=r.clientData,t.setDomainData(n,qt)}}),U.c.UserInteraction,Ye.a.ComponentRetrieved,e.uuid),this.syncService.sync().then((()=>{const n=Object.assign({},t);n.action=Q.SaveSuccess,this.replyToMessage(e,t,{}),this.handleMessage(e,n)})).catch((()=>{const n=Object.assign({},t);n.action=Q.SaveError,this.replyToMessage(e,t,{error:Q.SaveError}),this.handleMessage(e,n)}))}))}handleDuplicateItemMessage(e,t){const n=t.data.item,i=this.itemManager.findItem(n.uuid),r=[{name:Q.StreamItems,content_types:[i.content_type]}];this.runWithPermissions(e.uuid,r,(async()=>{const n=await this.itemManager.duplicateItem(i.uuid);this.syncService.sync(),this.replyToMessage(e,t,{item:this.jsonForItem(n,e)})}))}handleCreateItemsMessage(e,t){let n=t.data.item?[t.data.item]:t.data.items;const i=Vt()(n.map((e=>e.content_type))),r=[{name:Q.StreamItems,content_types:i}];this.runWithPermissions(e.uuid,r,(async()=>{n=this.responseItemsByRemovingPrivateProperties(n,e);const i=[];for(const t of n){t.uuid||(t.uuid=await u.GenerateUuid());const n=we(Object(Oe.f)(t,Ye.a.ComponentCreated)),r=await this.itemManager.insertItem(n);await this.itemManager.changeItem(r.uuid,(n=>{if(t.clientData){const i=Object(c.a)(r.getDomainData(qt)||{});i[e.getClientDataKey()]=t.clientData,n.setDomainData(i,qt)}}),U.c.UserInteraction,Ye.a.ComponentCreated,e.uuid),i.push(r)}this.syncService.sync();const r=t.action===Q.CreateItem?{item:this.jsonForItem(i[0],e)}:{items:i.map((t=>this.jsonForItem(t,e)))};this.replyToMessage(e,t,r)}))}handleDeleteItemsMessage(e,t){const n=Vt()(t.data.items.map((e=>e.content_type))).sort(),i=[{name:Q.StreamItems,content_types:n}];this.runWithPermissions(e.uuid,i,(async()=>{const n=t.data.items,i=1===n.length?"item":"items";let r=null;if(await this.alertService.confirm("Are you sure you want to delete ".concat(n.length," ").concat(i,"?"))){for(const e of n){const t=this.itemManager.findItem(e.uuid);t?([Y.a.Component,Y.a.Theme].includes(t.content_type)&&await this.deactivateComponent(t.uuid),await this.itemManager.setItemToBeDeleted(t.uuid,Ye.a.ComponentRetrieved)):this.alertService.alert("The item you are trying to delete cannot be found.")}this.syncService.sync(),r={deleted:!0}}else r={deleted:!1};this.replyToMessage(e,t,r)}))}handleRequestPermissionsMessage(e,t){this.runWithPermissions(e.uuid,t.data.permissions,(()=>{this.replyToMessage(e,t,{approved:!0})}))}handleSetComponentDataMessage(e,t){this.runWithPermissions(e.uuid,[],(async()=>{await this.itemManager.changeComponent(e.uuid,(e=>{e.componentData=t.data.componentData})),this.syncService.sync()}))}async handleToggleComponentMessage(e){await this.toggleComponent(e),this.syncService.sync()}async toggleComponent(e){if(e.area===J.Modal)this.openModalComponent(e);else if(e.active)await this.deactivateComponent(e.uuid);else if(e.content_type===Y.a.Theme){const t=e,n=this.getActiveThemes();if(await this.activateComponent(e.uuid),!t.isLayerable()){await Object(c.F)(10);for(const e of n)e&&!e.isLayerable()&&await this.deactivateComponent(e.uuid)}}else await this.activateComponent(e.uuid)}handleInstallLocalComponentMessage(e,t){if(!this.isNativeExtension(e))return;const n=this.itemManager.findItem(t.data.uuid);this.desktopManager.installComponent(n)}runWithPermissions(e,t,n){const i=this.findComponent(e);t=Object(c.a)(t);const r=i.permissions;for(const e of t.slice()){const n=r.find((t=>t.name===e.name));if(!n)continue;const i=e.content_types;if(i){for(const e of n.content_types)Object(c.C)(i,e);0===i.length&&Object(c.l)(t,e)}else Object(c.l)(t,e)}t.length>0?this.promptForPermissions(i,t,(async e=>{e&&n()})):n()}promptForPermissions(e,t,n){const i={component:e,permissions:t,permissionsString:this.permissionsStringForPermissions(t,e),actionBlock:n,callback:async n=>{n&&(this.log("Changing component to expand permissions",e),await this.itemManager.changeItem(e.uuid,(n=>{const i=Object(c.a)(e.permissions);for(const e of t){const t=i.find((t=>t.name===e.name));if(t){const n=t.content_types||[];t.content_types=Vt()(n.concat(e.content_types))}else i.push(e)}n.permissions=i})),this.syncService.sync()),this.permissionDialogs=this.permissionDialogs.filter((r=>{return r===i?(r.actionBlock&&r.actionBlock(n),!1):!!(r.component!==e||r.permissions!==t&&(s=t,r.permissions.some((e=>!s.find((t=>JSON.stringify(t)===JSON.stringify(e)))))))||(n&&r.actionBlock&&r.actionBlock(n),!1);var s})),this.permissionDialogs.length>0&&this.presentPermissionsDialog(this.permissionDialogs[0])}},r=Ft()(this.permissionDialogs,{component:e});this.permissionDialogs.push(i),r?this.log("Existing dialog, not presenting."):this.presentPermissionsDialog(i)}presentPermissionsDialog(e){throw"Must override SNComponentManager.presentPermissionsDialog"}openModalComponent(e){throw"Must override SNComponentManager.presentPermissionsDialog"}registerHandler(e){return this.handlers.push(e),()=>{const t=Ft()(this.handlers,{identifier:e.identifier});t?Object(c.C)(this.handlers,t):this.log("Attempting to deregister non-existing handler")}}findOrCreateDataForComponent(e){let t=this.componentState[e];return t||(t={},this.componentState[e]=t),t}setReadonlyStateForComponent(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=this.findOrCreateDataForComponent(e.uuid);i.readonly=t,i.lockReadonly=n}getReadonlyStateForComponent(e){const t=this.findOrCreateDataForComponent(e.uuid);return{readonly:t.readonly,lockReadonly:t.lockReadonly}}async registerComponentWindow(e,t){this.log("Register component window",e);const n=this.findOrCreateDataForComponent(e.uuid);var i,r;n.window===t&&this.log("Web|componentManager","attempting to re-register same component window."),this.log("Web|componentManager|registerComponentWindow",e),n.window=t,n.sessionKey=await u.GenerateUuid(),this.sendMessageToComponent(e,{action:Q.ComponentRegistered,sessionKey:n.sessionKey,componentData:e.componentData,data:{uuid:e.uuid,environment:(r=this.environment,{[be.Web]:"web",[be.Desktop]:"desktop",[be.Mobile]:"mobile"}[r]),platform:(i=this.platform,{[Pe.MacWeb]:"mac-web",[Pe.MacDesktop]:"mac-desktop",[Pe.LinuxWeb]:"linux-web",[Pe.LinuxDesktop]:"linux-desktop",[Pe.WindowsWeb]:"windows-web",[Pe.WindowsDesktop]:"windows-desktop",[Pe.Ios]:"ios",[Pe.Android]:"android"}[i]),activeThemeUrls:this.urlsForActiveThemes()}}),this.postActiveThemesToComponent(e),this.desktopManager&&this.desktopManager.notifyComponentActivation(e)}async activateComponent(e){this.log("Activating component",e);const t=this.findComponent(e);t.active||await this.itemManager.changeComponent(t.uuid,(e=>{e.active=!0}))}async onComponentIframeDestroyed(e){this.deregisterComponent(e)}deregisterComponent(e){this.log("Degregistering component",e);const t=this.findComponent(e);delete this.componentState[e];const n=t.area;this.streamObservers=this.streamObservers.filter((t=>t.componentUuid!==e)),this.contextStreamObservers=this.contextStreamObservers.filter((t=>t.componentUuid!==e)),n===J.Themes&&this.postActiveThemesToAllComponents()}async deactivateComponent(e){this.log("Deactivating component",e);const t=this.findComponent(e);(null==t?void 0:t.active)&&await this.itemManager.changeComponent(t.uuid,(e=>{e.active=!1})),this.findOrCreateDataForComponent(e).sessionKey=void 0,this.deregisterComponent(e)}async deleteComponent(e){await this.itemManager.setItemToBeDeleted(e),this.syncService.sync()}isComponentActive(e){return e.active}allComponentIframes(){return this.isMobile?[]:Array.from(document.getElementsByTagName("iframe"))}iframeForComponent(e){const t=this.allComponentIframes();for(const n of t)if(n.dataset.componentId===e)return n}handleSetSizeEvent(e,t){const n=(e,n)=>{const i=Object(c.t)(n.width)?n.width:"".concat(t.width,"px"),r=Object(c.t)(n.height)?n.height:"".concat(t.height,"px");e&&e.setAttribute("style","width:".concat(i,"; height:").concat(r,";"))};if(e.area===J.Rooms||e.area===J.Modal){const i=e.area===J.Rooms?"inner":"outer",r=document.getElementById("component-content-".concat(i,"-").concat(e.uuid));r&&n(r,t)}else{const i=this.iframeForComponent(e.uuid);if(!i)return;if(n(i,t),e.area===J.EditorStack){const e=i.parentElement;e&&n(e,t)}}}editorForNote(e){const t=this.componentsForArea(J.Editor);for(const n of t)if(n.isExplicitlyEnabledForItem(e.uuid))return n;let n;return this.isMobile?e.mobilePrefersPlainEditor||(n=this.getDefaultEditor()):e.prefersPlainEditor||(n=this.getDefaultEditor()),n&&!n.isExplicitlyDisabledForItem(e.uuid)?n:void 0}getDefaultEditor(){const e=this.componentsForArea(J.Editor);return this.isMobile?e.filter((e=>e.isMobileDefault))[0]:e.filter((e=>e.isDefaultEditor()))[0]}permissionsStringForPermissions(e,t){let n="";const i=e.length,r=(e,t)=>e>0?e===t-1?2===t?" and ":", and ":", ":"";return e.forEach(((e,s)=>{if(e.name===Q.StreamItems){const t=e.content_types.map((e=>{const t=Object(Y.c)(e);return t?t+"s":"items of type "+e}));let a="";for(let e=0;e<t.length;e++){const n=t[e];a+=r(e,t.length+i-s-1),a+=n}n+=r(s,i),n+=a,t.length>=2&&s<i-1&&(n+=", ")}else if(e.name===Q.StreamContextItem){const e={[J.EditorStack]:"working note",[J.NoteTags]:"working note",[J.Editor]:"working note"};n+=r(s,i),n+=e[t.area]}})),n+"."}}class Jt extends l.a{constructor(){super(),this.changeObservers=[],this.emitQueue=[],this.overwriteProtection=[Y.a.ItemsKey],this.collection=new et}getMasterCollection(){return tt.FromCollection(this.collection)}deinit(){super.deinit(),this.changeObservers.length=0,this.resetState()}resetState(){this.collection=new et}find(e){return this.collection.findAll(e)}async emitCollection(e,t){return this.emitPayloads(e.all(),e.source,t)}async emitPayload(e,t,n){return this.emitPayloads([e],t,n)}async emitPayloads(e,t,n){return 0===e.length&&console.warn("Attempting to emit 0 payloads."),new Promise((i=>{this.emitQueue.push({payloads:e,source:t,sourceKey:n,resolve:i}),1===this.emitQueue.length&&this.popQueue()}))}async popQueue(){const e=this.emitQueue[0],{changed:t,inserted:n,discarded:i,ignored:r}=this.mergePayloadsOntoMaster(e.payloads);this.notifyChangeObservers(t,n,i,r,e.source,e.sourceKey),Object(c.C)(this.emitQueue,e),e.resolve(t.concat(n,i)),this.emitQueue.length>0&&this.popQueue()}mergePayloadsOntoMaster(e){const t=[],n=[],i=[],r=[];for(const s of e){if(!s.uuid||!s.content_type){console.error("Payload is corrupt:",s);continue}const e=this.collection.find(s.uuid);if(s.errorDecrypting&&e&&!e.errorDecrypting&&this.overwriteProtection.includes(s.content_type)){r.push(s);continue}const a=e?Object(Oe.g)(e,s):s;a.discardable?(this.collection.discard(a),i.push(a)):(this.collection.set(a),e?t.push(a):n.push(a))}return{changed:t,inserted:n,discarded:i,ignored:r}}addObserver(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;Array.isArray(e)||(e=[e]);const i={types:e,priority:n,callback:t};return this.changeObservers.push(i),()=>{Object(c.C)(this.changeObservers,i)}}notifyChangeObservers(e,t,n,i,r,s){const a=this.changeObservers.slice().sort(((e,t)=>e.priority<t.priority?-1:1)),o=(e,t)=>t.includes(Y.a.Any)?e.slice():e.slice().filter((e=>t.includes(e.content_type)));for(const c of a)c.callback(o(e,c.types),o(t,c.types),o(n,c.types),o(i,c.types),r,s)}async importPayloads(e){const t=new at(this.getMasterCollection(),tt.WithPayloads(e,Ye.a.FileImport)),n=await t.resultingCollection();return await this.emitCollection(n),Object(ft.b)(n.payloads)}removePayloadLocally(e){this.collection.discard(e)}}var Qt,Gt=n(9);class Yt extends l.a{constructor(e,t){super(),this.resolveQueue=[],this.registeredPredicates=[],this.itemManager=e,this.syncService=t,this.addObservers()}deinit(){this.syncService=void 0,this.itemManager=void 0,this.resolveQueue.length=0,this.registeredPredicates.length=0,this.removeItemObserver(),this.removeItemObserver=void 0,this.removeSyncObserver(),this.removeSyncObserver=void 0,super.deinit()}popResolveQueue(){const e=this.resolveQueue.slice();return this.resolveQueue=[],e}addObservers(){this.removeItemObserver=this.itemManager.addObserver(Y.a.Any,((e,t)=>{if(e.length>0){const t=e.filter((e=>e.errorDecryptingValueChanged));t.length>0&&(this.resolveQueue=this.resolveQueue.concat(t))}t.length>0&&(this.resolveQueue=this.resolveQueue.concat(t))})),this.removeSyncObserver=this.syncService.addEventObserver((async e=>{e!==Gt.a.DownloadFirstSyncCompleted&&e!==Gt.a.FullSyncCompleted||await this.resolveSingletonsForItems(this.popResolveQueue(),e)}))}registerPredicate(e){this.registeredPredicates.push(e)}validItemsMatchingPredicate(e){return this.itemManager.itemsMatchingPredicate(e).filter((e=>!e.errorDecrypting))}async resolveSingletonsForItems(e,t){const n=e=>{for(const t of this.registeredPredicates)if(e.satisfiesPredicate(t))return this.validItemsMatchingPredicate(t)},i=e=>e.isSingleton?this.validItemsMatchingPredicate(e.singletonPredicate):null,r=e=>{const t=i(e);return t&&t.length>0?t:n(e)},s=[];for(const t of e){if(s.includes(t))continue;const e=r(t);Object(c.k)(s,e||[]),!e||e.length<=1||await this.handleStrategy(e,t.singletonStrategy)}s.length>0&&t===Gt.a.FullSyncCompleted&&setTimeout((()=>{this.syncService.sync()}))}async handleStrategy(e,t){if(t!==U.e.KeepEarliest)throw"Unhandled singleton strategy";const n=e.sort(((e,t)=>e.errorDecrypting?1:t.errorDecrypting||e.created_at<t.created_at?-1:1)),i=Object(c.d)(n,0);await this.itemManager.setItemsToBeDeleted(Object(ft.b)(i))}async findOrCreateSingleton(e,t,n){return new Promise((async i=>{const r=this.validItemsMatchingPredicate(e);if(r.length>0)return i(r[0]);if(!this.syncService.getLastSyncDate()){let n=!1;const r=this.itemManager.addObserver(t,((t,r)=>{if(r.length>0){const t=this.itemManager.subItemsMatchingPredicates(r,[e]);t.length>0&&(n=!0,i(t[0]))}}));if(await this.syncService.sync(),r(),n)return;const s=this.validItemsMatchingPredicate(e);if(s.length>0)return i(s[0])}const s=this.itemManager.itemsMatchingPredicate(e).filter((e=>e.errorDecrypting));await this.itemManager.setItemsToBeDeleted(Object(ft.b)(s));const a=Object(Oe.e)({uuid:await u.GenerateUuid(),content_type:t,content:n,dirty:!0,dirtiedDate:new Date}),o=await this.itemManager.emitItemFromPayload(a);if(!o)throw Error("Created singleton item should not be null ".concat(t));return await this.syncService.sync(),i(o)}))}}function $t(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Xt(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?$t(Object(n),!0).forEach((function(t){Zt(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):$t(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Zt(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class en extends l.a{constructor(e,t,n,i,r,s,a){super(),this.previousPasswords=[],this.itemManager=e,this.alertService=t,this.deviceInterface=n,this.httpService=i,this.modelManager=r,this.protocolService=s,this.syncService=a,this.previousPasswords=[]}deinit(){this.itemManager=void 0,this.alertService=void 0,this.deviceInterface=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.syncService=void 0,this.previousPasswords.length=0,super.deinit()}getExtensions(){return this.itemManager.nonErroredItemsForContentType(Y.a.ActionsExtension)}extensionsInContextOfItem(e){return this.getExtensions().filter((t=>t.supported_types.includes(e.content_type)||t.actionsWithContextForItem(e).length>0))}async loadExtensionInContextOfItem(e,t){const n={content_type:t.content_type,item_uuid:t.uuid},i=await this.httpService.getAbsolute(e.url,n).catch((e=>(console.error("Error loading extension",e),null)));if(!i)return;const r=i.description||e.description,s=i.supported_types||e.supported_types,a=i.actions?i.actions.map((e=>new oe(e))):[];return await this.itemManager.changeActionsExtension(e.uuid,(e=>{e.deprecation=i.deprecation,e.description=r,e.supported_types=s,e.actions=a})),this.itemManager.findItem(e.uuid)}async runAction(e,t,n){let i;switch(e.verb){case"get":i=await this.handleGetAction(e,n);break;case"render":i=await this.handleRenderAction(e,n);break;case"show":i=await this.handleShowAction(e);break;case"post":i=await this.handlePostAction(e,t)}return i}async handleGetAction(e,t){return await this.alertService.confirm("Are you sure you want to replace the current note contents with this action's results?")?this.runConfirmedGetAction(e,t):{error:{status:1,message:"Action canceled by user."}}}async runConfirmedGetAction(e,t){const n=await this.httpService.getAbsolute(e.url).catch((e=>{const t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return this.alertService.alert(t.message),{error:t}}));if(n.error)return n;const i=await this.payloadByDecryptingResponse(n,t);return await this.modelManager.emitPayload(Object(Oe.b)(i,{dirty:!0,dirtiedDate:new Date}),Ye.a.RemoteActionRetrieved),this.syncService.sync(),Xt(Xt({},n),{},{item:n.item})}async handleRenderAction(e,t){return await this.httpService.getAbsolute(e.url).then((async e=>{const n=await this.payloadByDecryptingResponse(e,t);if(n){const t=we(n);return Xt(Xt({},e),{},{item:t})}})).catch((e=>{const t=e&&e.error||{message:"An issue occurred while processing this action. Please try again."};return this.alertService.alert(t.message),{error:t}}))}async payloadByDecryptingResponse(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:[];const r=Object(Oe.e)(e.item),s=await this.protocolService.payloadByDecryptingPayload(r,n);if(!s.errorDecrypting)return s;const a=e.keyParams||e.auth_params;if(!a)return void this.alertService.alert("We were unable to decrypt this revision using your current keys, and this revision is missing metadata that would allow us to try different keys to decrypt it. This can likely be fixed with some manual intervention. Please email hello@standardnotes.org for assistance.");const o=this.protocolService.createKeyParams(a);for(const n of this.previousPasswords){if(i.includes(n))continue;i.push(n);const r=await this.protocolService.computeRootKey(n,o);if(!r)continue;const s=await this.payloadByDecryptingResponse(e,t,r,i);if(s)return s}const c=await t();return this.previousPasswords.includes(c)?void 0:(this.previousPasswords.push(c),this.payloadByDecryptingResponse(e,t,n))}async handlePostAction(e,t){const n=e.access_type===ne.Decrypted,i={items:[await this.outgoingPayloadForItem(t,n)]};return this.httpService.postAbsolute(e.url,i).then((e=>e)).catch((e=>(console.error("Action error response:",e),this.alertService.alert("An issue occurred while processing this action. Please try again."),e)))}async handleShowAction(e){return this.deviceInterface.openUrl(e.url),{}}async outgoingPayloadForItem(e){const t=arguments.length>1&&void 0!==arguments[1]&&arguments[1]?_e.b.FileDecrypted:_e.b.FileEncrypted;return(await this.protocolService.payloadByEncryptingPayload(e.payloadRepresentation(),t)).ejected()}}class tn{constructor(e){this.services=e,this.stageHandlers={},this.registerStageHandlers()}static timestamp(){throw"Must override"}registerStageHandler(e,t){this.stageHandlers[e]=t}markDone(){var e;null===(e=this.onDoneHandler)||void 0===e||e.call(this),this.onDoneHandler=void 0}async promptForPasscodeUntilCorrect(e){const t=new xe([new Fe(Re.None)],ke.Migration,!1);return new Promise((n=>{this.services.challengeService.addChallengeObserver(t,{onNonvalidatedSubmit:async i=>{const r=i.values[0],s=r.value;await e(s)?(this.services.challengeService.completeChallenge(t),n(s)):this.services.challengeService.setValidationStatusForChallenge(t,r,!1)}}),this.services.challengeService.promptForChallengeResponse(t)}))}onDone(e){this.onDoneHandler=e}async handleStage(e){const t=this.stageHandlers[e];t&&await t()}}!function(e){e.CreatedAt="created_at",e.UpdatedAt="userModifiedDate",e.Title="title"}(Qt||(Qt={}));class nn extends et{constructor(){super(...arguments),this.displaySortBy={},this.displayFilter={},this.filteredMap={},this.sortedMap={}}set(e){e=Array.isArray(e)?e:[e],super.set(e),this.filterSortElements(e)}discard(e){e=Array.isArray(e)?e:[e],super.discard(e),this.filterSortElements(e)}setDisplayOptions(e,t,n,i){const r=this.displaySortBy[e],s=this.displayFilter[e];if(r&&r.key===t&&r.dir===n&&!s&&!i)return;this.displaySortBy[e]=t?{key:t,dir:n}:void 0,this.displayFilter[e]=i,this.filteredMap[e]={},this.sortedMap[e]=[];const a=this.all(e);a.length>0&&this.filterSortElements(a)}displayElements(e){const t=this.sortedMap[e];if(!t)throw Error("Attempting to access display elements for\n        non-configured content type ".concat(e));return t.slice()}filterSortElements(e){if(0===Object.keys(this.displaySortBy).length)return;const t=new Set;for(const n of e){const e=n.content_type,i=this.displaySortBy[e];if(!i)continue;const r=this.displayFilter[e],s=this.filteredMap[e],a=this.sortedMap[e],o=s[n.uuid],l=Object(c.q)(o)?void 0:a[o];if(n.deleted||!this.map[n.uuid]||r&&!r(n))Object(c.q)(o)||(delete s[n.uuid],a[o]=void 0,t.add(e));else if(Object(c.q)(l))a.push(n),t.add(e);else{const r=l.errorDecrypting?void 0:l[i.key],s=n[i.key];a[o]=n;const u=l.pinned!==n.pinned;Object(c.e)(r,s)&&!u||t.add(e)}}for(const e of t.values())this.resortContentType(e)}resortContentType(e){const t=this.sortedMap[e],n=this.displaySortBy[e],i=this.filteredMap[e],r=function e(t,i){let r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!t)return-1;if(!i)return 1;if(!r){if(t.pinned&&i.pinned)return e(t,i,!0);if(t.pinned)return-1;if(i.pinned)return 1}let s=t[n.key]||"",a=i[n.key]||"",o=1;if("asc"===n.dir&&(o*=-1),n.key===Qt.Title){if(s=s.toLowerCase(),a=a.toLowerCase(),0===s.length&&0===a.length)return 0;if(0===s.length&&0!==a.length)return 1*o;if(0!==s.length&&0===a.length)return-1*o;o*=-1}return s>a?-1*o:s<a?1*o:0},s=t.sort(((e,t)=>r(e,t))),a=[];let o=0;for(const e of s)e&&(a.push(e),i[e.uuid]=o,o++);this.sortedMap[e]=a}}function rn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function sn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?rn(Object(n),!0).forEach((function(t){an(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):rn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function an(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}const on={WebPasscodeParamsKey:"offlineParams",MobilePasscodeParamsKey:"pc_params",AllAccountKeyParamsKey:"auth_params",WebEncryptedStorageKey:"encryptedStorage",MobileWrappedRootKeyKey:"encrypted_account_keys",MobileBiometricsPrefs:"biometrics_prefs",AllMigrations:"migrations",MobileThemesCache:"ThemePreferencesKey",MobileLightTheme:"lightTheme",MobileDarkTheme:"darkTheme",MobileLastExportDate:"LastExportDateKey",MobileDoNotWarnUnsupportedEditors:"DoNotShowAgainUnsupportedEditorsKey",MobileOptionsState:"options",MobilePasscodeKeyboardType:"passcodeKeyboardType"},cn="jwt";class ln extends tn{static timestamp(){return new Date("2020-01-15").getTime()}registerStageHandlers(){this.registerStageHandler(Se.PreparingForLaunch_0,(async()=>{Ce(this.services.environment)?await this.migrateStorageStructureForWebDesktop():Ie(this.services.environment)&&await this.migrateStorageStructureForMobile()})),this.registerStageHandler(Se.StorageDecrypted_09,(async()=>{await this.migrateArbitraryRawStorageToManagedStorageAllPlatforms(),Ie(this.services.environment)&&await this.migrateMobilePreferences(),await this.migrateSessionStorage(),await this.deleteLegacyStorageValues()})),this.registerStageHandler(Se.LoadingDatabase_11,(async()=>{await this.createDefaultItemsKeyForAllPlatforms(),this.markDone()}))}async migrateStorageStructureForWebDesktop(){const e=this.services.deviceInterface,t={[Ee.Wrapped]:{},[Ee.Unwrapped]:{},[Ee.Nonwrapped]:{}},n=await e.getJsonParsedRawStorageValue(on.AllAccountKeyParamsKey);n&&(t.nonwrapped[r.RootKeyParams]=n);const i=await e.getJsonParsedRawStorageValue(on.WebEncryptedStorageKey);if(i){const e=Object(Oe.e)(i),n=await this.webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(e),s=n.key,a=n.decryptedStoragePayload,o=n.keyParams;t.nonwrapped[r.RootKeyWrapperKeyParams]=o.getPortableValue();const l=Object(c.a)(a.contentObject.storage),u=Object(c.w)(l),d=u[on.AllAccountKeyParamsKey];t.nonwrapped[r.RootKeyParams]=d;let h=s;if(!Object(c.q)(u.mk)){const{accountKey:e,wrappedKey:n}=await this.webDesktopHelperExtractAndWrapAccountKeysFromValueStore(s,d,u);h=e,t.nonwrapped[r.WrappedRootKey]=n}t.wrapped=await this.webDesktopHelperEncryptStorage(h,a,u)}else{const e=await this.services.deviceInterface.getRawStorageValue("ak"),t=await this.services.deviceInterface.getRawStorageValue("mk");if(e||t){const i=(null==n?void 0:n.version)||await this.getFallbackRootKeyVersion(),r=await this.services.deviceInterface.getRawStorageValue("pw"),s=await It.Create({masterKey:t,serverPassword:r,dataAuthenticationKey:e,version:i,keyParams:n});await this.services.deviceInterface.setNamespacedKeychainValue(s.getKeychainValue(),this.services.identifier)}}await this.allPlatformHelperSetStorageStructure(t)}async allPlatformHelperSetStorageStructure(e){const t=Te.defaultValuesObject(e.wrapped,e.unwrapped,e.nonwrapped);t[Ee.Unwrapped]=void 0,await this.services.deviceInterface.setRawStorageValue(a(this.services.identifier,i.StorageObject),JSON.stringify(t))}async webDesktopHelperGetPasscodeKeyAndDecryptEncryptedStorage(e){const t=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.WebPasscodeParamsKey),n=this.services.protocolService.createKeyParams(t);let i,r;return await this.promptForPasscodeUntilCorrect((async t=>(r=await this.services.protocolService.computeRootKey(t,n),i=await this.services.protocolService.payloadByDecryptingPayload(e,r),!i.errorDecrypting))),{decryptedStoragePayload:i,key:r,keyParams:n}}async webDesktopHelperExtractAndWrapAccountKeysFromValueStore(e,t,n){var i;const r=(null==t?void 0:t.version)||await this.getFallbackRootKeyVersion(),s=await It.Create({masterKey:n.mk,serverPassword:n.pw,dataAuthenticationKey:n.ak,version:r,keyParams:t});delete n.mk,delete n.pw,delete n.ak;const a=Object(Oe.e)(s);let o;return e&&(o=await this.services.protocolService.payloadByEncryptingPayload(a,_e.b.LocalStorageEncrypted,e)),{accountKey:s,wrappedKey:null===(i=o)||void 0===i?void 0:i.ejected()}}async webDesktopHelperEncryptStorage(e,t,n){return(await this.services.protocolService.payloadByEncryptingPayload(Object(Oe.b)(t,{content_type:Y.a.EncryptedStorage,content:n}),_e.b.LocalStoragePreferEncrypted,e)).ejected()}async migrateStorageStructureForMobile(){const e=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.MobileWrappedRootKeyKey),t=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.AllAccountKeyParamsKey),n=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.MobilePasscodeParamsKey),i={[Ee.Nonwrapped]:{[r.WrappedRootKey]:e,[r.RootKeyWrapperKeyParams]:n,[r.RootKeyParams]:t},[Ee.Unwrapped]:{},[Ee.Wrapped]:{}},s=await this.services.deviceInterface.getRawKeychainValue(),a=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.MobileBiometricsPrefs);a&&(i.nonwrapped[r.BiometricsState]=a.enabled,i.nonwrapped[r.MobileBiometricsTiming]=a.timing);const o=await this.services.deviceInterface.getRawStorageValue(on.MobilePasscodeKeyboardType);if(o&&(i.nonwrapped[r.MobilePasscodeKeyboardType]=o),n){var l;const a=this.services.protocolService.createKeyParams(n),o=async()=>{let t;return await this.promptForPasscodeUntilCorrect((async n=>{var i;t=await this.services.protocolService.computeRootKey(n,a);const r=null==s||null===(i=s.offline)||void 0===i?void 0:i.pw;if(r)return t.serverPassword===r;if(e)return!(await this.services.protocolService.payloadByDecryptingPayload(Object(Oe.e)(e),t)).errorDecrypting;{const e=(await this.services.deviceInterface.getAllRawDatabasePayloads(this.services.identifier))[0];if(!e)throw Error("Passcode only migration aborting due to missing keychain.offline.pw");return!(await this.services.protocolService.payloadByDecryptingPayload(Object(Oe.e)(e),t)).errorDecrypting}})),t};if(i.nonwrapped[r.MobilePasscodeTiming]=null==s||null===(l=s.offline)||void 0===l?void 0:l.timing,e){const n=await o(),s=await this.services.protocolService.payloadByDecryptingPayload(Object(Oe.e)(e),n),a=s.contentObject.accountKeys,c=a.version||(null==t?void 0:t.version)||await this.getFallbackRootKeyVersion(),l=Object(Oe.b)(s,{content:{masterKey:a.mk,serverPassword:a.pw,dataAuthenticationKey:a.ak,version:c,keyParams:t,accountKeys:void 0}}),u=await this.services.protocolService.payloadByEncryptingPayload(l,_e.b.LocalStoragePreferEncrypted,n);i.nonwrapped[r.WrappedRootKey]=u.ejected(),a.jwt&&this.services.deviceInterface.setRawStorageValue(cn,a.jwt),await this.services.deviceInterface.clearRawKeychainValue()}else if(!e){const e=await o(),t=Object(Oe.e)({uuid:await u.GenerateUuid(),content:Object(ft.a)(i.unwrapped),content_type:Y.a.EncryptedStorage}),n=await this.services.protocolService.payloadByEncryptingPayload(t,_e.b.LocalStoragePreferEncrypted,e);i.wrapped=n.ejected(),await this.services.deviceInterface.clearRawKeychainValue()}}else if(!Object(c.q)(null==s?void 0:s.mk)){const e=s.version||(null==t?void 0:t.version)||await this.getFallbackRootKeyVersion(),n=await It.Create({masterKey:s.mk,serverPassword:s.pw,dataAuthenticationKey:s.ak,version:e,keyParams:t});await this.services.deviceInterface.setNamespacedKeychainValue(n.getKeychainValue(),this.services.identifier),s.jwt&&this.services.deviceInterface.setRawStorageValue(cn,s.jwt)}await this.allPlatformHelperSetStorageStructure(i)}async getFallbackRootKeyVersion(){const e=(await this.services.deviceInterface.getAllRawDatabasePayloads(this.services.identifier))[0];return e&&Object(Oe.e)(e).version||p.a.V002}async migrateArbitraryRawStorageToManagedStorageAllPlatforms(){const e=await this.services.deviceInterface.getAllRawStorageKeyValues(),t=Object(c.y)(on),n=e=>{try{return JSON.parse(e)}catch(t){return e}},i=this.services.identifier;for(const r of e){const e=r.key,s=r.value,a=i&&i.length>0&&e.startsWith(i);if(!t.includes(e)&&!a&&!Object(c.q)(s)){const t=n(s);await this.services.storageService.setValue(e,t)}}}async deleteLegacyStorageValues(){const e=[...Object(c.y)(r),...Object(c.y)(on),"mk","ak","pw","encryptionKey","authKey","jwt","ephemeral","cachedThemes"];for(const t of e)await this.services.deviceInterface.removeRawStorageValue(t)}async migrateMobilePreferences(){const e=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.MobileLastExportDate),t=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.MobileDoNotWarnUnsupportedEditors),n=await this.services.deviceInterface.getJsonParsedRawStorageValue(on.MobileOptionsState);let i={};if(n){var s,a,o,c;const e=n.sortBy;i={sortBy:"updated_at"===e||"client_updated_at"===e?Qt.UpdatedAt:e,sortReverse:null!==(s=n.sortReverse)&&void 0!==s&&s,hideNotePreview:null!==(a=n.hidePreviews)&&void 0!==a&&a,hideDate:null!==(o=n.hideDates)&&void 0!==o&&o,hideTags:null!==(c=n.hideTags)&&void 0!==c&&c}}const l=sn(sn({},i),{},{lastExportDate:null!=e?e:void 0,doNotShowAgainUnsupportedEditors:null!=t&&t});await this.services.storageService.setValue(r.MobilePreferences,l)}async migrateSessionStorage(){const e="user";let t=await this.services.storageService.getValue(cn);if(!t){const n=await this.services.storageService.getValue(e);if(n&&(t=n.jwt),!t)return}const n=new wt(t);if(await this.services.storageService.setValue(r.Session,n),Ie(this.services.environment)){const t=await this.services.storageService.getValue(e);t&&t.server&&await this.services.storageService.setValue(r.ServerHost,t.server)}}async createDefaultItemsKeyForAllPlatforms(){const e=await this.services.protocolService.getRootKey();if(e){const t=await this.services.protocolService.getRootKeyParams(),n=p.a.V001,i=we(Object(Oe.e)({uuid:await u.GenerateUuid(),content_type:Y.a.ItemsKey,content:Object(ft.a)({itemsKey:e.masterKey,dataAuthenticationKey:e.dataAuthenticationKey,version:t.version||n}),dirty:!0,dirtiedDate:new Date}));await this.services.itemManager.emitItemFromPayload(i.payloadRepresentation(),Ye.a.LocalChanged)}}}class un extends tn{static timestamp(){return new Date("2020-01-01").getTime()}registerStageHandlers(){this.registerStageHandler(Se.PreparingForLaunch_0,(async()=>{await this.migrateMigrationTimestampAllPlatforms(),this.markDone()}))}async migrateMigrationTimestampAllPlatforms(){const e=["migrations","ephemeral","user","cachedThemes","syncToken","encryptedStorage"];let t=!1;for(const n of e)if(await this.services.deviceInterface.getRawStorageValue(n)){t=!0;break}const n=a(this.services.identifier,i.LastMigrationTimestamp),r=await this.services.deviceInterface.getRawStorageValue(n),s=!Object(c.q)(r);if(!s&&t){const e=new Date(0).getTime();await this.services.deviceInterface.setRawStorageValue(n,e)}else if(!s&&!t){const e=(new Date).getTime();await this.services.deviceInterface.setRawStorageValue(n,e)}}}class dn extends l.a{constructor(e){super(),this.services=e,this.handledFullSyncStage=!1}deinit(){this.services=void 0,this.activeMigrations&&(this.activeMigrations.length=0),super.deinit()}async initialize(){if(await this.runBaseMigration(),this.activeMigrations=await this.getRequiredMigrations(),this.activeMigrations.length>0){const e=Object(c.x)(this.activeMigrations);e.onDone((async()=>{await this.saveLastMigrationTimestamp(e.constructor.timestamp())}))}}async handleApplicationStage(e){await super.handleApplicationStage(e),await this.handleStage(e)}async handleApplicationEvent(e){e===mt.a.SignedIn?await this.handleStage(Se.SignedIn_30):e===mt.a.CompletedFullSync&&(this.handledFullSyncStage||(this.handledFullSyncStage=!0,await this.handleStage(Se.FullSyncCompleted_13)))}async runBaseMigration(){const e=new un(this.services);await e.handleStage(Se.PreparingForLaunch_0)}async hasPendingMigrations(){return(await this.getRequiredMigrations()).length>0}async getRequiredMigrations(){const e=await this.getLastMigrationTimestamp(),t=[],n=Object.keys(s).map((e=>s[e])).sort(((e,t)=>{const n=e.timestamp(),i=t.timestamp();return n<i?-1:n>i?1:0}));for(const i of n)i.timestamp()>e&&t.push(new i(this.services));return t}getNamespacedTimeStampKey(){return a(this.services.identifier,i.LastMigrationTimestamp)}async getLastMigrationTimestamp(){const e=await this.services.deviceInterface.getRawStorageValue(this.getNamespacedTimeStampKey());if(Object(c.q)(e))throw"Timestamp should not be null. Be sure to run base migration first.";return JSON.parse(e)}async saveLastMigrationTimestamp(e){await this.services.deviceInterface.setRawStorageValue(this.getNamespacedTimeStampKey(),JSON.stringify(e))}async handleStage(e){for(const t of this.activeMigrations)await t.handleStage(e)}}var hn,pn,yn,gn;!function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=512]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength"}(hn||(hn={})),function(e){e[e.SaltSeedLength=128]="SaltSeedLength",e[e.PbkdfMinCost=3e3]="PbkdfMinCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(pn||(pn={})),function(e){e[e.SaltSeedLength=256]="SaltSeedLength",e[e.PbkdfCost=11e4]="PbkdfCost",e[e.PbkdfOutputLength=768]="PbkdfOutputLength",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionIvLength=128]="EncryptionIvLength"}(yn||(yn={})),function(e){e[e.ArgonSaltSeedLength=256]="ArgonSaltSeedLength",e[e.ArgonSaltLength=128]="ArgonSaltLength",e[e.ArgonIterations=5]="ArgonIterations",e[e.ArgonMemLimit=67108864]="ArgonMemLimit",e[e.ArgonOutputKeyBytes=64]="ArgonOutputKeyBytes",e[e.EncryptionKeyLength=256]="EncryptionKeyLength",e[e.EncryptionNonceLength=192]="EncryptionNonceLength"}(gn||(gn={}));const fn="00000000000000000000000000000000";class mn extends class{constructor(e){this.crypto=e}async firstHalfOfKey(e){return e.substring(0,e.length/2)}async secondHalfOfKey(e){return e.substring(e.length/2,e.length)}splitKey(e,t){const n=e.length/t,i=[];for(let r=0;r<t;r++){const t=e.slice(n*r,n*(r+1));i.push(t)}return i}async createItemsKey(){const e=await this.generateNewItemsKeyContent();return we(Object(Oe.e)({uuid:await u.GenerateUuid(),content_type:Y.a.ItemsKey,content:Object(ft.a)(e)}))}async generateEncryptedParameters(e,t,n){if(t===pe.a.DecryptedBareObject)return Object(Oe.c)({content:e.content});if(t===pe.a.DecryptedBase64String){const t=JSON.stringify(e.content),n=await this.crypto.base64Encode(t),i=p.a.V000Base64Decrypted+n;return Object(Oe.c)({content:i})}throw"Must override generateEncryptedParameters to handle format ".concat(t,".")}async generateDecryptedParameters(e,t){const n=e.format;if(n===pe.a.DecryptedBareObject)return e;if(n===pe.a.DecryptedBase64String){const t=e.contentString.substring(p.a.VersionLength,e.contentString.length);let n;try{const e=await this.crypto.base64Decode(t);n=JSON.parse(e)}catch(t){n=e.content}return Object(Oe.a)(e,{content:n})}throw Error("Must override generateDecryptedParameters to handle format ".concat(n,"."))}}{getEncryptionDisplayName(){return"AES-256"}get version(){return p.a.V001}async generateNewItemsKeyContent(){const e=hn.EncryptionKeyLength;return{itemsKey:await this.crypto.generateRandomKey(e),version:p.a.V001}}async createRootKey(e,t,n){const i=hn.PbkdfMinCost,r=await this.crypto.generateRandomKey(hn.SaltSeedLength),s=function(e){return m(e)}({email:e,pw_cost:i,pw_salt:await this.crypto.unsafeSha1(e+"SN"+r),version:p.a.V001,origination:n,created:"".concat(Date.now())});return this.deriveKey(t,s)}async getPayloadAuthenticatedData(e){}async computeRootKey(e,t){return this.deriveKey(e,t)}async decryptString(e,t){return this.crypto.aes256CbcDecrypt(e,fn,t)}async encryptString(e,t){return this.crypto.aes256CbcEncrypt(e,fn,t)}async generateEncryptedParameters(e,t,n){if(t===pe.a.DecryptedBareObject||t===pe.a.DecryptedBase64String)return super.generateEncryptedParameters(e,t,n);if(t!==pe.a.EncryptedString)throw"Unsupport format for generateEncryptedParameters ".concat(t);if(!n)throw"Attempting to generateEncryptedParameters with no itemsKey.";const i=await this.crypto.generateRandomKey(2*hn.EncryptionKeyLength),r=await this.encryptString(i,n.itemsKey),s=await this.firstHalfOfKey(i),a=await this.secondHalfOfKey(i),o=await this.encryptString(JSON.stringify(e.content),s),c=n.keyVersion+o,l=await this.crypto.hmac256(c,a);return Object(Oe.c)({uuid:e.uuid,items_key_id:n instanceof fe?n.uuid:void 0,content:c,enc_item_key:r,auth_hash:l})}async generateDecryptedParameters(e,t){const n=e.format;if(n===pe.a.DecryptedBareObject||n===pe.a.DecryptedBase64String)return super.generateDecryptedParameters(e,t);if(!e.enc_item_key)return console.error("Missing item encryption key, skipping decryption."),e;let i=e.enc_item_key;i=this.version+i;const r=this.encryptionComponentsFromString(i,t.itemsKey),s=await this.decryptString(r.ciphertext,r.key);if(!s)return console.error("Error decrypting parameters",e),Object(Oe.a)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting});const a=await this.firstHalfOfKey(s),o=this.encryptionComponentsFromString(e.contentString,a),c=await this.decryptString(o.ciphertext,o.key);return c?Object(Oe.a)(e,{content:JSON.parse(c),items_key_id:void 0,enc_item_key:void 0,auth_hash:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===e.errorDecrypting,waitingForKey:!1}):Object(Oe.a)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting})}encryptionComponentsFromString(e,t){const n=e.substring(0,p.a.VersionLength);return{ciphertext:e.substring(p.a.VersionLength,e.length),version:n,key:t}}async deriveKey(e,t){const n=await this.crypto.pbkdf2(e,t.content001.pw_salt,t.content001.pw_cost,hn.PbkdfOutputLength),i=this.splitKey(n,2);return await It.Create({serverPassword:i[0],masterKey:i[1],version:p.a.V001,keyParams:t.getPortableValue()})}}class vn{static log(){this.onLog(...arguments)}static error(e){this.onError(e)}}function wn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Sn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class bn extends mn{get version(){return p.a.V002}async generateNewItemsKeyContent(){const e=pn.EncryptionKeyLength;return{itemsKey:await this.crypto.generateRandomKey(e),dataAuthenticationKey:await this.crypto.generateRandomKey(e),version:p.a.V002}}async createRootKey(e,t,n){const i=pn.PbkdfMinCost,r=await this.crypto.generateRandomKey(pn.SaltSeedLength),s=function(e){return m(e)}({email:e,pw_cost:i,pw_salt:await this.crypto.unsafeSha1(e+":"+r),version:p.a.V002,origination:n,created:"".concat(Date.now())});return this.deriveKey(t,s)}async computeRootKey(e,t){return this.deriveKey(e,t)}async decryptString002(e,t,n){return this.crypto.aes256CbcDecrypt(e,n,t)}async encryptString002(e,t,n){return this.crypto.aes256CbcEncrypt(e,n,t)}async encryptTextParams(e,t,n,i,r,s){const a=await this.crypto.generateRandomKey(pn.EncryptionIvLength),o=await this.encryptString002(e,t,a),c=[r,i,a,o].join(":"),l=[r,await this.crypto.hmac256(c,n),i,a,o];if(s){const e=await this.crypto.base64Encode(JSON.stringify(s.content));l.push(e)}return l.join(":")}async decryptTextParams(e,t,n,i,r,s){if(!n)throw"Attempting to decryptTextParams with null encryptionKey";const a=await this.crypto.hmac256(e,s);return!1===this.crypto.timingSafeEqual(r,a)?(vn.error(Error("Auth hash does not match.")),null):this.decryptString002(t,n,i)}async getPayloadAuthenticatedData(e){const t=this.encryptionComponentsFromString002(e.enc_item_key).keyParams;if(t)return function(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?wn(Object(n),!0).forEach((function(t){Sn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):wn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}({},JSON.parse(await this.crypto.base64Decode(t)))}async generateEncryptedParameters(e,t,n){if(t===pe.a.DecryptedBareObject||t===pe.a.DecryptedBase64String)return super.generateEncryptedParameters(e,t,n);if(t!==pe.a.EncryptedString)throw"Unsupport format for generateEncryptedParameters ".concat(t);if(!n||!n.itemsKey)throw"Attempting to generateEncryptedParameters with no itemsKey.";const i=await this.crypto.generateRandomKey(2*pn.EncryptionKeyLength),r=await this.encryptTextParams(i,n.itemsKey,n.dataAuthenticationKey,e.uuid,n.keyVersion,n instanceof It?n.keyParams:void 0),s=await this.firstHalfOfKey(i),a=await this.secondHalfOfKey(i),o=await this.encryptTextParams(JSON.stringify(e.content),s,a,e.uuid,n.keyVersion,n instanceof It?n.keyParams:void 0);return Object(Oe.c)({uuid:e.uuid,items_key_id:n instanceof fe?n.uuid:void 0,content:o,enc_item_key:r})}async generateDecryptedParameters(e,t){const n=e.format;if(n===pe.a.DecryptedBareObject||n===pe.a.DecryptedBase64String)return super.generateDecryptedParameters(e,t);if(!e.enc_item_key)return console.error("Missing item encryption key, skipping decryption."),e;if(!t||!t.itemsKey)throw"Attempting to generateDecryptedParameters with no itemsKey.";const i=e.enc_item_key,r=this.encryptionComponentsFromString002(i,t.itemsKey,t.dataAuthenticationKey),s=await this.decryptTextParams(r.ciphertextToAuth,r.contentCiphertext,r.encryptionKey,r.iv,r.authHash,r.authKey);if(!s)return console.error("Error decrypting item_key parameters",e),Object(Oe.a)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting});const a=await this.firstHalfOfKey(s),o=await this.secondHalfOfKey(s),c=this.encryptionComponentsFromString002(e.contentString,a,o),l=await this.decryptTextParams(c.ciphertextToAuth,c.contentCiphertext,c.encryptionKey,c.iv,c.authHash,c.authKey);if(l){let t;try{t=JSON.parse(await this.crypto.base64Decode(c.keyParams))}catch(e){}return Object(Oe.a)(e,{content:JSON.parse(l),items_key_id:void 0,enc_item_key:void 0,auth_hash:void 0,auth_params:t,errorDecrypting:!1,errorDecryptingValueChanged:!0===e.errorDecrypting,waitingForKey:!1})}return Object(Oe.a)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting})}async deriveKey(e,t){const n=await this.crypto.pbkdf2(e,t.content002.pw_salt,t.content002.pw_cost,pn.PbkdfOutputLength),i=this.splitKey(n,3);return await It.Create({serverPassword:i[0],masterKey:i[1],dataAuthenticationKey:i[2],version:p.a.V002,keyParams:t.getPortableValue()})}encryptionComponentsFromString002(e,t,n){const i=e.split(":");return{encryptionVersion:i[0],authHash:i[1],uuid:i[2],iv:i[3],contentCiphertext:i[4],keyParams:i[5],ciphertextToAuth:[i[0],i[2],i[3],i[4]].join(":"),encryptionKey:t,authKey:n}}}class Pn extends bn{get version(){return p.a.V003}async generateNewItemsKeyContent(){const e=yn.EncryptionKeyLength;return{itemsKey:await this.crypto.generateRandomKey(e),dataAuthenticationKey:await this.crypto.generateRandomKey(e),version:p.a.V003}}async computeRootKey(e,t){return this.deriveKey(e,t)}async deriveKey(e,t){const n=await this.generateSalt(t.content003.identifier,p.a.V003,yn.PbkdfCost,t.content003.pw_nonce),i=await this.crypto.pbkdf2(e,n,yn.PbkdfCost,yn.PbkdfOutputLength),r=this.splitKey(i,3);return await It.Create({serverPassword:r[0],masterKey:r[1],dataAuthenticationKey:r[2],version:p.a.V003,keyParams:t.getPortableValue()})}async createRootKey(e,t,n){const i=p.a.V003,r=function(e){return m(e)}({identifier:e,pw_nonce:await this.crypto.generateRandomKey(yn.SaltSeedLength),version:i,origination:n,created:"".concat(Date.now())});return this.deriveKey(t,r)}async generateSalt(e,t,n,i){return await this.crypto.sha256([e,"SF",t,n,i].join(":"))}}function On(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Dn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?On(Object(n),!0).forEach((function(t){Cn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):On(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function Cn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class In extends Pn{getEncryptionDisplayName(){return"XChaCha20-Poly1305"}get version(){return p.a.V004}async generateNewItemsKeyContent(){return{itemsKey:await this.crypto.generateRandomKey(gn.EncryptionKeyLength),version:p.a.V004}}async generateSalt004(e,t){const n=await this.crypto.sha256([e,t].join(":"));return Object(c.J)(n,gn.ArgonSaltLength)}async computeRootKey(e,t){return this.deriveKey(e,t)}async createRootKey(e,t,n){const i=p.a.V004,r=function(e){return m(e)}({identifier:e,pw_nonce:await this.crypto.generateRandomKey(gn.ArgonSaltSeedLength),version:i,origination:n,created:"".concat(Date.now())});return this.deriveKey(t,r)}async encryptString004(e,t,n,i){if(!n)throw"encryptString null nonce";if(!t)throw"encryptString null rawKey";return this.crypto.xchacha20Encrypt(e,n,t,await this.authenticatedDataToString(i))}async decryptString004(e,t,n,i){return this.crypto.xchacha20Decrypt(e,n,t,i)}async generateEncryptedProtocolString(e,t,n){const i=await this.crypto.generateRandomKey(gn.EncryptionNonceLength);return[p.a.V004,i,await this.encryptString004(e,t,i,n),await this.authenticatedDataToString(n)].join(":")}async getPayloadAuthenticatedData(e){if(e.format!==pe.a.EncryptedString)throw Error("Attempting to get embedded key params of already decrypted item");const t=this.deconstructEncryptedPayloadString(e.enc_item_key).rawAuthenticatedData;return await this.stringToAuthenticatedData(t)}generateAuthenticatedDataForPayload(e,t){const n={u:e.uuid,v:p.a.V004};if(Object(_e.a)(e.content_type))return Dn(Dn({},n),{},{kp:t.keyParams.content});if(!(t instanceof fe))throw Error("Attempting to use non-items key for regular item.");return n}async authenticatedDataToString(e){return this.crypto.base64Encode(JSON.stringify(Object(c.G)(Object(c.A)(e))))}async stringToAuthenticatedData(e,t){const n=JSON.parse(await this.crypto.base64Decode(e));return Object(c.G)(Dn(Dn({},n),t))}async generateEncryptedParameters(e,t,n){if(t===pe.a.DecryptedBareObject||t===pe.a.DecryptedBase64String)return super.generateEncryptedParameters(e,t,n);if(t!==pe.a.EncryptedString)throw"Unsupport format for generateEncryptedParameters ".concat(t);if(!e.uuid)throw"payload.uuid cannot be null";if(!n||!n.itemsKey)throw"Attempting to generateEncryptedParameters with no itemsKey.";const i=await this.crypto.generateRandomKey(gn.EncryptionKeyLength),r=JSON.stringify(e.content),s=this.generateAuthenticatedDataForPayload(e,n),a=await this.generateEncryptedProtocolString(r,i,s),o=await this.generateEncryptedProtocolString(i,n.itemsKey,s);return Object(Oe.c)({uuid:e.uuid,items_key_id:n instanceof fe?n.uuid:void 0,content:a,enc_item_key:o})}async generateDecryptedParameters(e,t){const n=e.format;if(n===pe.a.DecryptedBareObject||n===pe.a.DecryptedBase64String)return super.generateDecryptedParameters(e,t);if(!e.uuid)throw"encryptedParameters.uuid cannot be null";if(!t||!t.itemsKey)throw"Attempting to generateDecryptedParameters with no itemsKey.";const i=this.deconstructEncryptedPayloadString(e.enc_item_key),r=await this.stringToAuthenticatedData(i.rawAuthenticatedData,{u:e.uuid,v:e.version}),s=await this.authenticatedDataToString(r),a=await this.decryptString004(i.ciphertext,t.itemsKey,i.nonce,s);if(!a)return console.error("Error decrypting itemKey parameters",e),Object(Oe.a)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting});const o=this.deconstructEncryptedPayloadString(e.contentString),c=await this.decryptString004(o.ciphertext,a,o.nonce,s);return c?Object(Oe.a)(e,{content:JSON.parse(c),items_key_id:void 0,enc_item_key:void 0,auth_hash:void 0,errorDecrypting:!1,errorDecryptingValueChanged:!0===e.errorDecrypting,waitingForKey:!1}):Object(Oe.a)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting})}deconstructEncryptedPayloadString(e){const t=e.split(":");return{version:t[0],nonce:t[1],ciphertext:t[2],rawAuthenticatedData:t[3]}}async deriveKey(e,t){const n=await this.generateSalt004(t.content004.identifier,t.content004.pw_nonce),i=await this.crypto.argon2(e,n,gn.ArgonIterations,gn.ArgonMemLimit,gn.ArgonOutputKeyBytes),r=this.splitKey(i,2),s=r[0],a=r[1];return It.Create({masterKey:s,serverPassword:a,version:p.a.V004,keyParams:t.getPortableValue()})}}function Mn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function jn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Mn(Object(n),!0).forEach((function(t){An(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Mn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function An(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}var En;!function(e){e[e.RootKeyNone=0]="RootKeyNone",e[e.RootKeyOnly=1]="RootKeyOnly",e[e.RootKeyPlusWrapper=2]="RootKeyPlusWrapper",e[e.WrapperOnly=3]="WrapperOnly"}(En||(En={}));const Rn=p.a.V003;class kn extends l.a{constructor(e,t,n,i,r,s){super(),this.identifier=r,this.operators={},this.keyMode=En.RootKeyNone,this.keyObservers=[],this.itemManager=e,this.modelManager=t,this.deviceInterface=n,this.storageService=i,this.crypto=s,Object(c.s)()?u.SetGenerators(this.crypto.generateUUID,void 0):u.SetGenerators(this.crypto.generateUUID,this.crypto.generateUUIDSync),Object.defineProperty(this,"rootKey",{enumerable:!1,writable:!0}),this.removeItemsObserver=this.itemManager.addObserver([Y.a.ItemsKey],((e,t)=>{e.concat(t).length>0&&this.decryptErroredItems()}))}deinit(){this.itemManager=void 0,this.modelManager=void 0,this.deviceInterface=void 0,this.storageService=void 0,this.crypto.deinit(),this.crypto=void 0,this.operators={},this.keyObservers.length=0,this.removeItemsObserver(),this.removeItemsObserver=null,this.rootKey=void 0,super.deinit()}async initialize(){const e=await this.getWrappedRootKey(),t=await this.getAccountKeyParams(),n=await this.hasRootKeyWrapper(),i=!Object(c.q)(e)||!Object(c.q)(t);if(n&&i)this.keyMode=En.RootKeyPlusWrapper;else if(n&&!i)this.keyMode=En.WrapperOnly;else if(!n&&i)this.keyMode=En.RootKeyOnly;else{if(n||i)throw"Invalid key mode condition";this.keyMode=En.RootKeyNone}this.keyMode===En.RootKeyOnly&&(this.rootKey=await this.getRootKeyFromKeychain(),await this.notifyObserversOfKeyChange())}async getEncryptionSourceVersion(){return this.hasAccount()?this.getUserVersion():this.hasPasscode()?(await this.getRootKeyWrapperKeyParams()).version:void 0}async getEncryptionDisplayName(){const e=await this.getEncryptionSourceVersion();if(e)return this.operatorForVersion(e).getEncryptionDisplayName()}getLatestVersion(){return p.a.V004}hasAccount(){switch(this.keyMode){case En.RootKeyNone:case En.WrapperOnly:return!1;case En.RootKeyOnly:case En.RootKeyPlusWrapper:return!0;default:throw Error("Unhandled keyMode value '".concat(this.keyMode,"'."))}}async getUserVersion(){const e=await this.getAccountKeyParams();return null==e?void 0:e.version}async upgradeAvailable(){const e=await this.accountUpgradeAvailable(),t=await this.passcodeUpgradeAvailable();return e||t}async accountUpgradeAvailable(){const e=await this.getUserVersion();return!!e&&e!==this.getLatestVersion()}async passcodeUpgradeAvailable(){const e=await this.getRootKeyWrapperKeyParams();return!!e&&e.version!==this.getLatestVersion()}platformSupportsKeyDerivation(e){return Object(p.b)(e.version,p.a.V004)>=0||!!Object(c.u)()||Object(c.s)()}supportedVersions(){return[p.a.V001,p.a.V002,p.a.V003,p.a.V004]}isVersionNewerThanLibraryVersion(e){const t=this.getLatestVersion();return 1===Object(p.b)(e,t)}isProtocolVersionOutdated(e){const t={[p.a.V001]:Date.parse("2018-01-01"),[p.a.V002]:Date.parse("2020-01-01")}[e];return!!t&&(new Date).getTime()>t}costMinimumForVersion(e){if(Object(p.b)(e,p.a.V003)>=0)throw"Cost minimums only apply to versions <= 002";if(e===p.a.V001)return hn.PbkdfMinCost;if(e===p.a.V002)return pn.PbkdfMinCost;throw"Invalid version for cost minimum: ".concat(e)}createOperatorForLatestVersion(){return this.createOperatorForVersion(this.getLatestVersion())}createOperatorForVersion(e){if(e===p.a.V001)return new mn(this.crypto);if(e===p.a.V002)return new bn(this.crypto);if(e===p.a.V003)return new Pn(this.crypto);if(e===p.a.V004)return new In(this.crypto);if(e===p.a.V000Base64Decrypted)return this.createOperatorForLatestVersion();throw"Unable to find operator for version ".concat(e)}operatorForVersion(e){const t=e;let n=this.operators[t];return n||(n=this.createOperatorForVersion(e),this.operators[t]=n),n}defaultOperator(){return this.operatorForVersion(this.getLatestVersion())}async computeRootKey(e,t){const n=t.version;return this.operatorForVersion(n).computeRootKey(e,t)}async createRootKey(e,t,n,i){return(i?this.operatorForVersion(i):this.defaultOperator()).createRootKey(e,t,n)}payloadContentFormatForIntent(e,t){if(t){if(e===_e.b.Sync||e===_e.b.FileEncrypted||e===_e.b.FilePreferEncrypted||e===_e.b.LocalStorageEncrypted||e===_e.b.LocalStoragePreferEncrypted)return pe.a.EncryptedString;throw"Unhandled encrypted case in protocolService.payloadContentFormatForIntent."}if(e===_e.b.LocalStorageDecrypted||e===_e.b.LocalStoragePreferEncrypted||e===_e.b.FileDecrypted||e===_e.b.FilePreferEncrypted)return pe.a.DecryptedBareObject;if(e===_e.b.SyncDecrypted)return pe.a.DecryptedBase64String;throw"Unhandled decrypted case in protocolService.payloadContentFormatForIntent."}async payloadByEncryptingPayload(e,t,n){if(e.errorDecrypting)return e;if(e.deleted)return e;if(Object(c.q)(t))throw"Attempting to encrypt payload with null intent";if(n||Object(_e.d)(t)||(n=await this.keyToUseForEncryptionOfPayload(e,t)),!n&&Object(_e.c)(t))throw Error("Attempting to generate encrypted payload with no key.");if(e.format!==pe.a.DecryptedBareObject)throw"Attempting to encrypt already encrypted payload.";if(!e.content)throw"Attempting to encrypt payload with no content.";if(!e.uuid)throw"Attempting to encrypt payload with no uuid.";const i=n?n.keyVersion:this.getLatestVersion(),r=this.payloadContentFormatForIntent(t,n),s=this.operatorForVersion(i),a=await s.generateEncryptedParameters(e,r,n);if(!a)throw"Unable to generate encryption parameters";return Object(Oe.d)(e,t,a)}async payloadsByEncryptingPayloads(e,t,n){const i=[];for(const r of e){const e=Object(c.p)(t)?t(r):t,s=await this.payloadByEncryptingPayload(r,e,n);i.push(s)}return i}async payloadByDecryptingPayload(e,t){var n;if(!e.content)throw Error("Attempting to decrypt payload that has no content.");const i=e.format;if(i===pe.a.DecryptedBareObject)return e;if(!t&&i===pe.a.EncryptedString&&!(t=await this.keyToUseForDecryptionOfPayload(e)))return Object(Oe.e)(e,{waitingForKey:!0,errorDecrypting:!0});if(null===(n=t)||void 0===n?void 0:n.errorDecrypting)return Object(Oe.e)(e,{waitingForKey:!0,errorDecrypting:!0});const r=e.version,s=e.source,a=this.operatorForVersion(r);try{const n=await a.generateDecryptedParameters(e,t);return Object(Oe.e)(e,n,s)}catch(t){return console.error("Error decrypting payload",e,t),Object(Oe.e)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting})}}async payloadsByDecryptingPayloads(e,t){const n=async e=>e?!0===e.deleted&&Object(c.q)(e.content)?e:Object(c.t)(e.content)?this.payloadByDecryptingPayload(e,t):e:e;return Promise.all(e.map((e=>n(e))))}async decryptErroredItems(){const e=this.itemManager.invalidItems.filter((e=>e.content_type!==Y.a.ItemsKey));if(0===e.length)return;const t=e.map((e=>e.payloadRepresentation())),n=await this.payloadsByDecryptingPayloads(t);await this.modelManager.emitPayloads(n,Ye.a.LocalChanged)}async payloadsByDecryptingBackupFile(e,t){const n=e.keyParams||e.auth_params,i=e.items.map((e=>Object(Oe.f)(e,Ye.a.FileImport)));let r=[];if(n){const e=this.createKeyParams(n),s=await this.computeRootKey(t,e),a=i.filter((e=>e.content_type===Y.a.ItemsKey)),o=await this.payloadsByDecryptingPayloads(a,s);Object(c.k)(r,o);for(const e of i)if(e.content_type!==Y.a.ItemsKey)try{let t=await this.keyToUseForDecryptionOfPayload(e);if(!t){const n=o.find((t=>e.items_key_id===t.uuid)),i=e.version;n?t=we(n):Object(p.b)(i,p.a.V003)<=0&&(t=s)}const n=await this.payloadByDecryptingPayload(e,t);r.push(n)}catch(t){r.push(Object(Oe.e)(e,{errorDecrypting:!0,errorDecryptingValueChanged:!e.errorDecrypting})),console.error("Error decrypting payload",e,t)}}else r=i;return r}createKeyParams(e){return m(e)}async createBackupFile(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:_e.b.FilePreferEncrypted,n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];const i=e||this.itemManager.items;if(n&&0===i.length)return;const r=[];for(const e of i)if(e.errorDecrypting)r.push(e.payload);else{const n=Object(Oe.f)(e.payload,Ye.a.FileImport),i=await this.payloadByEncryptingPayload(n,t);r.push(i)}const s={version:this.getLatestVersion(),items:r.map((e=>e.ejected()))},a=await this.getRootKeyParams();return a&&t!==_e.b.FileDecrypted&&(s.keyParams=a.getPortableValue()),JSON.stringify(s,null,2)}onKeyStatusChange(e){return this.keyObservers.push(e),()=>{Object(c.C)(this.keyObservers,e)}}async notifyObserversOfKeyChange(){for(const e of this.keyObservers)await e()}async getRootKeyFromKeychain(){const e=await this.deviceInterface.getNamespacedKeychainValue(this.identifier);if(!Object(c.q)(e))return await It.Create(jn(jn({},e),{},{keyParams:await this.getRootKeyParams()}))}async saveRootKeyToKeychain(){if(Object(c.q)(this.rootKey))throw"Attempting to non-existent root key to the keychain.";if(this.keyMode!==En.RootKeyOnly)throw"Should not be persisting wrapped key to keychain.";const e=this.rootKey.getKeychainValue();return this.executeCriticalFunction((()=>this.deviceInterface.setNamespacedKeychainValue(e,this.identifier)))}async hasRootKeyWrapper(){const e=await this.getRootKeyWrapperKeyParams();return!Object(c.q)(e)}hasPasscode(){return this.keyMode===En.WrapperOnly||this.keyMode===En.RootKeyPlusWrapper}async rootKeyNeedsUnwrapping(){return await this.hasRootKeyWrapper()&&Object(c.q)(this.rootKey)}async getRootKeyWrapperKeyParams(){const e=await this.storageService.getValue(r.RootKeyWrapperKeyParams,Ae.Nonwrapped);if(e)return this.createKeyParams(e)}async getWrappedRootKey(){return this.storageService.getValue(r.WrappedRootKey,Ae.Nonwrapped)}async getRootKeyParams(){if(this.keyMode===En.WrapperOnly)return this.getRootKeyWrapperKeyParams();if(this.keyMode===En.RootKeyOnly||this.keyMode===En.RootKeyPlusWrapper)return this.getAccountKeyParams();if(this.keyMode!==En.RootKeyNone)throw"Unhandled key mode for getRootKeyParams ".concat(this.keyMode)}async getAccountKeyParams(){const e=await this.storageService.getValue(r.RootKeyParams,Ae.Nonwrapped);if(e)return this.createKeyParams(e)}async validateWrappingKey(e){const t=await this.getWrappedRootKey();if(this.keyMode===En.WrapperOnly)return this.storageService.canDecryptWithKey(e);if(this.keyMode===En.RootKeyOnly||this.keyMode===En.RootKeyPlusWrapper){const n=Object(Oe.e)(t);return!(await this.payloadByDecryptingPayload(n,e)).errorDecrypting}throw"Unhandled case in validateWrappingKey"}async computeWrappingKey(e){const t=await this.getRootKeyWrapperKeyParams();return await this.computeRootKey(e,t)}async unwrapRootKey(e){if(this.keyMode===En.WrapperOnly)return void(this.rootKey=e);if(this.keyMode!==En.RootKeyPlusWrapper)throw"Invalid key mode condition for unwrapping.";const t=await this.getWrappedRootKey(),n=Object(Oe.e)(t),i=await this.payloadByDecryptingPayload(n,e);if(i.errorDecrypting)throw Error("Unable to decrypt root key with provided wrapping key.");this.rootKey=await It.Create(i.contentObject,i.uuid),await this.notifyObserversOfKeyChange()}async setNewRootKeyWrapper(e){if(this.keyMode===En.RootKeyNone)this.keyMode=En.WrapperOnly;else{if(this.keyMode!==En.RootKeyOnly)throw Error("Attempting to set wrapper on already wrapped key.");this.keyMode=En.RootKeyPlusWrapper}if(await this.deviceInterface.clearNamespacedKeychainValue(this.identifier),this.keyMode!==En.WrapperOnly&&this.keyMode!==En.RootKeyPlusWrapper)throw Error("Invalid keyMode on setNewRootKeyWrapper");this.keyMode===En.WrapperOnly?(this.rootKey=e,await this.reencryptItemsKeys()):await this.wrapAndPersistRootKey(e),await this.storageService.setValue(r.RootKeyWrapperKeyParams,e.keyParams.getPortableValue(),Ae.Nonwrapped),await this.notifyObserversOfKeyChange()}async wrapAndPersistRootKey(e){const t=Object(Oe.e)(this.rootKey,{content:this.rootKey.persistableValueWhenWrapping()}),n=await this.payloadByEncryptingPayload(t,_e.b.LocalStorageEncrypted,e);await this.storageService.setValue(r.WrappedRootKey,n.ejected(),Ae.Nonwrapped)}async removeRootKeyWrapper(){if(this.keyMode!==En.WrapperOnly&&this.keyMode!==En.RootKeyPlusWrapper)throw Error("Attempting to remove root key wrapper on unwrapped key.");this.keyMode===En.WrapperOnly?(this.keyMode=En.RootKeyNone,this.rootKey=void 0):this.keyMode===En.RootKeyPlusWrapper&&(this.keyMode=En.RootKeyOnly),await this.storageService.removeValue(r.WrappedRootKey,Ae.Nonwrapped),await this.storageService.removeValue(r.RootKeyWrapperKeyParams,Ae.Nonwrapped),this.keyMode===En.RootKeyOnly&&await this.saveRootKeyToKeychain(),await this.notifyObserversOfKeyChange()}async setRootKey(e,t){if(!e.keyParams)throw Error("keyParams must be supplied if setting root key.");if(this.rootKey===e)throw Error("Attempting to set root key as same current value.");if(this.keyMode===En.WrapperOnly)this.keyMode=En.RootKeyPlusWrapper;else if(this.keyMode===En.RootKeyNone)this.keyMode=En.RootKeyOnly;else if(this.keyMode!==En.RootKeyOnly&&this.keyMode!==En.RootKeyPlusWrapper)throw Error("Unhandled key mode for setNewRootKey ".concat(this.keyMode));if(this.rootKey=e,await this.storageService.setValue(r.RootKeyParams,e.keyParams.getPortableValue(),Ae.Nonwrapped),this.keyMode===En.RootKeyOnly)await this.saveRootKeyToKeychain();else if(this.keyMode===En.RootKeyPlusWrapper){if(!t)throw Error("wrappingKey must be supplied");await this.wrapAndPersistRootKey(t)}await this.notifyObserversOfKeyChange()}async getRootKey(){return this.rootKey}async clearLocalKeyState(){await this.deviceInterface.clearNamespacedKeychainValue(this.identifier),await this.storageService.removeValue(r.WrappedRootKey,Ae.Nonwrapped),await this.storageService.removeValue(r.RootKeyWrapperKeyParams,Ae.Nonwrapped),await this.storageService.removeValue(r.RootKeyParams,Ae.Nonwrapped),this.keyMode=En.RootKeyNone,this.rootKey=void 0,await this.notifyObserversOfKeyChange()}async validateAccountPassword(e){const t=await this.getRootKeyParams(),n=await this.computeRootKey(e,t),i=n.compare(this.rootKey);return i?{valid:i,artifacts:{rootKey:n}}:{valid:!1}}async validatePasscode(e){const t=await this.getRootKeyWrapperKeyParams(),n=await this.computeRootKey(e,t),i=await this.validateWrappingKey(n);return i?{valid:i,artifacts:{wrappingKey:n}}:{valid:!1}}async keyToUseForEncryptionOfPayload(e,t){if(Object(c.q)(t))throw"Intent must be supplied when looking up key for encryption of item.";if(Object(_e.a)(e.content_type)){const e=await this.getRootKey();if(!e){if(Object(_e.c)(t))throw"Root key encryption is required but no root key is available.";return}return e}{const e=this.getDefaultItemsKey(),t=await this.getUserVersion();return t&&t!==(null==e?void 0:e.keyVersion)?(console.warn("The user's default items key version is not equal to the account version."),this.latestItemsKeys().find((e=>e.keyVersion===t))):e}}async keyToUseForDecryptionOfPayload(e){if(Object(_e.a)(e.content_type))return this.getRootKey();if(e.items_key_id)return this.itemsKeyForPayload(e);const t=e.version;if(t===this.getLatestVersion())throw Error("No associated key found for item encrypted with latest protocol version.");return this.defaultItemsKeyForItemVersion(t)}async onSyncEvent(e){e===mt.b.FullSyncCompleted&&await this.handleFullSyncCompletion(),e===mt.b.DownloadFirstSyncCompleted&&await this.handleDownloadFirstSyncCompletion()}async handleDownloadFirstSyncCompletion(){if(!this.hasAccount())return;const e=this.latestItemsKeys(),t=e.filter((e=>e.neverSynced)),n=e.find((e=>!e.neverSynced&&e.isDefault));if(Object(c.q)(n)){const e=await this.getRootKey();if(e){const n=t.filter((t=>t.keyVersion!==e.keyVersion));n.length>0&&await this.itemManager.setItemsToBeDeleted(Object(ft.b)(n)),0===this.latestItemsKeys().length&&await this.createNewDefaultItemsKey()}}else await this.itemManager.setItemsToBeDeleted(Object(ft.b)(t))}async handleFullSyncCompletion(){if(!this.getDefaultItemsKey()&&(await this.createNewDefaultItemsKey(),this.keyMode===En.WrapperOnly))return this.repersistAllItems()}async repersistAllItems(){const e=this.itemManager.items.map((e=>Object(Oe.e)(e)));return this.storageService.savePayloads(e)}latestItemsKeys(){return this.itemManager.itemsKeys()}itemsKeyForPayload(e){return this.latestItemsKeys().find((t=>t.uuid===e.items_key_id))}getDefaultItemsKey(){const e=this.latestItemsKeys();return 1===e.length?e[0]:e.find((e=>e.isDefault))}async getKeyEmbeddedKeyParams(e){if(e.payload.format===pe.a.DecryptedBareObject)return;const t=e.version,n=this.operatorForVersion(t),i=await n.getPayloadAuthenticatedData(e.payload);if(i){if(Object(p.c)(t,p.a.V003)){const e=i;return this.createKeyParams(e)}{const e=i.kp;return this.createKeyParams(e)}}}async reencryptItemsKeys(){const e=this.latestItemsKeys();e.length>0&&await this.itemManager.setItemsDirty(Object(ft.b)(e))}async defaultItemsKeyForItemVersion(e){return this.latestItemsKeys().find((t=>t.keyVersion===e))}async createNewDefaultItemsKey(){const e=await this.getRootKey(),t=e?e.keyVersion:this.getLatestVersion();let n;n=Object(p.b)(t,Rn)<=0?we(Object(Oe.e)({uuid:await u.GenerateUuid(),content_type:Y.a.ItemsKey,content:Object(ft.a)({itemsKey:e.masterKey,dataAuthenticationKey:e.dataAuthenticationKey,version:t})})):await this.operatorForVersion(t).createItemsKey();const i=this.getDefaultItemsKey();i&&await this.itemManager.changeItemsKey(i.uuid,(e=>{e.isDefault=!1}));const r=await this.itemManager.insertItem(n);return await this.itemManager.changeItemsKey(r.uuid,(e=>{e.isDefault=!0})),r}async createNewItemsKeyWithRollback(){const e=this.getDefaultItemsKey(),t=await this.createNewDefaultItemsKey();return async()=>{await Promise.all([this.itemManager.setItemToBeDeleted(t.uuid),this.itemManager.changeItem(e.uuid,(e=>{e.isDefault=!0}))])}}}class Kn{constructor(e){this.defaultContentKeyToDiffOn="text",this.textCharDiffLength=0,this.hasPreviousEntry=!1;let t=e.updated_at;Object(c.t)(t)&&(t=new Date(t)),0===t.getTime()&&(t=new Date),this.payload=Object(Oe.b)(e,{updated_at:t})}setPreviousEntry(e){this.hasPreviousEntry=null!=e,this.payload.safeContent[this.defaultContentKeyToDiffOn]&&(this.textCharDiffLength=e?this.payload.contentObject[this.defaultContentKeyToDiffOn].length-e.payload.contentObject[this.defaultContentKeyToDiffOn].length:this.payload.contentObject[this.defaultContentKeyToDiffOn].length)}operationVector(){return void 0!==this.textCharDiffLength?this.hasPreviousEntry&&0!==this.textCharDiffLength?this.textCharDiffLength<0?-1:1:0:1}deltaSize(){return void 0!==this.textCharDiffLength?Math.abs(this.textCharDiffLength):1}isSameAsEntry(e){if(!e)return!1;const t=we(this.payload),n=we(e.payload);return t.isItemContentEqualWith(n)}}class _n extends Kn{previewTitle(){return this.payload.updated_at.toLocaleString()}previewSubTitle(){return this.hasPreviousEntry?this.textCharDiffLength<0?"".concat(-1*this.textCharDiffLength," characters removed"):this.textCharDiffLength>0?"".concat(this.textCharDiffLength," characters added"):"Title or metadata changed":"".concat(this.textCharDiffLength," characters loaded")}}function Tn(e){const t={[Y.a.Note]:_n}[e[N.a.ContentType]];if(!t)throw"Invalid item history class";return new t(e)}class xn{constructor(e){if(this.entries=[],e)for(const t of e)t.setPreviousEntry(this.getMostRecentEntry()),this.entries.unshift(t)}static FromJson(e){const t=e.entries.map((e=>Tn(e.payload)));return new xn(t)}getMostRecentEntry(){return this.entries[0]}addHistoryEntryForItem(e){const t=Tn(e),n=this.getMostRecentEntry();if(t.setPreviousEntry(n),!t.isSameAsEntry(n))return this.entries.unshift(t),t}clear(){this.entries.length=0}optimize(){const e=[],t=e=>e.deltaSize()>15,n=(n,i,r)=>{if(r)e.unshift(n);else{const t=e.indexOf(n);-1!==t&&e.splice(t,1)}if(r&&t(n)&&-1===n.operationVector()){const t=this.entries[i+1];t&&e.unshift(t)}};for(let e=this.entries.length;e--;){const i=this.entries[e];0===e||e===this.entries.length-1?n(i,e,!0):n(i,e,t(i))}this.entries=this.entries.filter(((t,n)=>-1!==e.indexOf(t)))}}class Fn{constructor(e){this.itemRevisionThreshold=60,this.content=e,this.content||(this.content={itemUUIDToItemHistoryMapping:{}})}static FromJson(e){if(e){const t=e.content;return Object.keys(t.itemUUIDToItemHistoryMapping).forEach((e=>{const n=t.itemUUIDToItemHistoryMapping[e];t.itemUUIDToItemHistoryMapping[e]=xn.FromJson(n)})),new Fn(t)}return new Fn}addEntryForPayload(e){return this.historyForItem(e.uuid).addHistoryEntryForItem(e)}historyForItem(e){let t=this.content.itemUUIDToItemHistoryMapping[e];return t||(t=new xn,this.content.itemUUIDToItemHistoryMapping[e]=t),t}clearItemHistory(e){this.historyForItem(e.uuid).clear()}clearAllHistory(){this.content.itemUUIDToItemHistoryMapping={}}setItemRevisionThreshold(e){this.itemRevisionThreshold=e}optimizeHistoryForItem(e){const t=this.historyForItem(e);t.entries.length>this.itemRevisionThreshold&&t.optimize()}}class Ln extends l.a{constructor(e,t,n,i,r,s){super(),this.contentTypes=[],this.persistable=!1,this.autoOptimize=!1,this.itemManager=e,this.storageService=t,this.contentTypes=r,this.timeout=s,this.apiService=n,this.protocolService=i}deinit(){this.itemManager=void 0,this.storageService=void 0,this.contentTypes.length=0,this.sessionHistory=void 0,this.timeout=null,this.removeChangeObserver&&(this.removeChangeObserver(),this.removeChangeObserver=null),super.deinit()}async initializeFromDisk(){this.persistable=await this.storageService.getValue(r.SessionHistoryPersistable),this.sessionHistory=await this.storageService.getValue(r.SessionHistoryRevisions).then((e=>Fn.FromJson(e)));const e=await this.storageService.getValue(r.SessionHistoryOptimize);Object(c.q)(e)?this.autoOptimize=!0:this.autoOptimize=e,this.addChangeObserver()}addChangeObserver(){this.removeChangeObserver=this.itemManager.addObserver(this.contentTypes,((e,t,n,i,r)=>{const s=Object(c.f)(e,t,n);if(r!==Ye.a.LocalChanged)for(const e of s)try{e.deleted||e.errorDecrypting||this.addHistoryEntryForItem(e)}catch(e){console.error("Unable to add item history entry:",e)}}))}isDiskEnabled(){return this.persistable}isAutoOptimizeEnabled(){return this.autoOptimize}async saveToDisk(){this.persistable&&this.storageService.setValue(r.SessionHistoryRevisions,this.sessionHistory)}setSessionItemRevisionThreshold(e){this.sessionHistory.setItemRevisionThreshold(e)}async addHistoryEntryForItem(e){const t=Object(Oe.f)(e,Ye.a.SessionHistory),n=this.sessionHistory.addEntryForPayload(t);this.autoOptimize&&this.sessionHistory.optimizeHistoryForItem(e.uuid),n&&this.persistable&&(this.saveTimeout&&(this.timeout.hasOwnProperty("cancel")?this.timeout.cancel(this.saveTimeout):clearTimeout(this.saveTimeout)),this.saveTimeout=this.timeout((()=>{this.saveToDisk()}),2e3))}sessionHistoryForItem(e){return this.sessionHistory.historyForItem(e.uuid)}async clearHistoryForItem(e){return this.sessionHistory.clearItemHistory(e),this.saveToDisk()}async clearAllHistory(){return this.sessionHistory.clearAllHistory(),this.storageService.removeValue(r.SessionHistoryRevisions)}async toggleDiskSaving(){if(this.persistable=!this.persistable,!this.persistable)return this.storageService.setValue(r.SessionHistoryPersistable,!1),this.storageService.removeValue(r.SessionHistoryRevisions);this.storageService.setValue(r.SessionHistoryPersistable,!0),this.saveToDisk()}async toggleAutoOptimize(){this.autoOptimize=!this.autoOptimize,this.autoOptimize?this.storageService.setValue(r.SessionHistoryOptimize,!0):this.storageService.setValue(r.SessionHistoryOptimize,!1)}async remoteHistoryForItem(e){const t=await this.apiService.getItemRevisions(e.uuid);if(!t.error)return t.object}async fetchRemoteRevision(e,t){const n=await this.apiService.getRevision(t,e);if(n.error)return;const i=Object(Oe.e)(n,{uuid:n.item_uuid}),r=Object(Oe.f)(i,Ye.a.RemoteHistory),s=await this.protocolService.payloadByDecryptingPayload(r);return new Kn(s)}}var Vn;!function(e){e[e.None=0]="None",e[e.FiveMinutes=300]="FiveMinutes",e[e.OneHour=3600]="OneHour",e[e.OneWeek=604800]="OneWeek"}(Vn||(Vn={}));const Nn={[V.AccountPassword]:{label:"Account Password",prompt:"Please enter your account password."},[V.LocalPasscode]:{label:"Application Passcode",prompt:"Please enter your application passcode."}},Un={[L.ManageExtensions]:{label:"Manage Extensions"},[L.ManageBackups]:{label:"Download/Import Backups"},[L.ViewProtectedNotes]:{label:"View Protected Notes"},[L.ManagePrivileges]:{label:"Manage Privileges"},[L.ManagePasscode]:{label:"Manage Passcode"},[L.DeleteNote]:{label:"Delete Notes"}};class Wn extends l.a{constructor(e,t,n,i,r,s){super(),this.availableActions=[],this.availableCredentials=[],this.itemManager=e,this.syncService=t,this.singletonManager=n,this.protocolService=i,this.storageService=r,this.sessionManager=s,this.loadDefaults()}deinit(){this.itemManager=void 0,this.syncService=void 0,this.singletonManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.sessionManager=void 0,super.deinit()}loadDefaults(){this.availableActions=Object.keys(L).map((e=>L[e])),this.availableCredentials=[V.AccountPassword,V.LocalPasscode]}getAvailableActions(){return this.availableActions}getAvailableCredentials(){return this.availableCredentials}async netCredentialsForAction(e){const t=(await this.getPrivileges()).getCredentialsForAction(e),n=[];for(const e of t)e===V.AccountPassword?await this.sessionManager.online()&&n.push(e):e===V.LocalPasscode&&await this.protocolService.hasRootKeyWrapper()&&n.push(e);return n}async getPrivileges(){const e=Y.a.Privileges,t=new W.a("content_type","=",e);return this.singletonManager.findOrCreateSingleton(t,e,Object(ft.a)({}))}async setSessionLength(e){const t=(e=>{const t=new Date;return t.setSeconds(t.getSeconds()+e),t})(e);await this.storageService.setValue(r.PrivilegesExpirey,t),await this.storageService.setValue(r.PrivilegesSessionLength,e)}async clearSession(){return this.setSessionLength(Vn.None)}async getSelectedSessionLength(){return await this.storageService.getValue(r.PrivilegesSessionLength)||Vn.None}async getSessionExpirey(){const e=await this.storageService.getValue(r.PrivilegesExpirey);return e?new Date(e):new Date}async actionHasPrivilegesConfigured(e){return(await this.netCredentialsForAction(e)).length>0}async actionRequiresPrivilege(e){return!(await this.getSessionExpirey()>new Date)&&(await this.netCredentialsForAction(e)).length>0}async authenticateAction(e,t){const n=await this.netCredentialsForAction(e),i=[],r=[];for(const e of n)await this.verifyAuthenticationParameters(e,t[e])?i.push(e):r.push(e);return{success:0===r.length,successfulCredentials:i,failedCredentials:r}}async verifyAuthenticationParameters(e,t){if(e===V.AccountPassword){const{valid:e}=await this.protocolService.validateAccountPassword(t);return e}if(e===V.LocalPasscode){const{valid:e}=await this.protocolService.validatePasscode(t);return e}}displayInfoForCredential(e){return Nn[e]}displayInfoForAction(e){return Un[e]}getSessionLengthOptions(){return[{value:Vn.None,label:"Don't Remember"},{value:Vn.FiveMinutes,label:"5 Minutes"},{value:Vn.OneHour,label:"1 Hour"},{value:Vn.OneWeek,label:"1 Week"}]}}function Bn(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function Hn(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?Bn(Object(n),!0).forEach((function(t){qn(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):Bn(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function qn(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class zn{constructor(e){this.collection=e,this.displayedList=[],this.needsRebuilding=!0}notesMatchingSmartTag(e,t){const n=e.predicate;if(e.isArchiveTag)return t.filter((e=>e.archived&&!e.trashed&&!e.deleted));if(e.isTrashTag)return t.filter((e=>e.trashed&&!e.deleted));const i=t.filter((e=>!e.trashed&&!e.deleted));return e.isAllTag?i:n.keypathIncludesVerb("tags")?i.map((e=>Hn(Hn(Hn({},e),e.payload),{},{tags:this.collection.elementsReferencingElement(e)}))).filter((e=>W.a.ObjectSatisfiesPredicate(e,n))).map((e=>this.collection.map[e.uuid])):i.filter((e=>W.a.ObjectSatisfiesPredicate(e,n)))}setDisplayOptions(e,t,n,i){this.collection.setDisplayOptions(Y.a.Note,t,n,i),this.tag=e,this.needsRebuilding=!0}rebuildList(){const e=this.collection.displayElements(Y.a.Note);if(!this.tag)return void(this.displayedList=e);let t=this.tag;t.isSmartTag()?this.displayedList=this.notesMatchingSmartTag(t,e):(t=this.collection.find(t.uuid),this.displayedList=e.filter((e=>!e.trashed&&!e.deleted&&t.hasRelationshipWithItem(e))))}setNeedsRebuilding(){this.needsRebuilding=!0}displayElements(){return this.needsRebuilding&&(this.rebuildList(),this.needsRebuilding=!1),this.displayedList.slice()}all(){return this.collection.all(Y.a.Note)}}class Jn extends l.a{constructor(e){super(),this.observers=[],this.modelManager=e,this.systemSmartTags=function(){const e=Object(Oe.e)({uuid:Qn,content_type:Y.a.SmartTag,content:Object(ft.a)({title:"All notes",isSystemTag:!0,isAllTag:!0,predicate:W.a.FromArray(["content_type","=",Y.a.Note])})}),t=Object(Oe.e)({uuid:Gn,content_type:Y.a.SmartTag,content:Object(ft.a)({title:"Archived",isSystemTag:!0,isArchiveTag:!0,predicate:W.a.FromArray(["archived","=",JSON.stringify(!0)])})}),n=Object(Oe.e)({uuid:Yn,content_type:Y.a.SmartTag,content:Object(ft.a)({title:"Trash",isSystemTag:!0,isTrashTag:!0,predicate:W.a.FromArray(["trashed","=",JSON.stringify(!0)])})});return[we(e),we(t),we(n)]}(),this.createCollection(),this.unsubChangeObserver=this.modelManager.addObserver(Y.a.Any,this.setPayloads.bind(this))}createCollection(){this.collection=new nn,this.collection.setDisplayOptions(Y.a.Note,Qt.CreatedAt,"dsc"),this.collection.setDisplayOptions(Y.a.Tag,Qt.Title,"asc"),this.collection.setDisplayOptions(Y.a.ItemsKey,Qt.CreatedAt,"asc"),this.collection.setDisplayOptions(Y.a.Component,Qt.CreatedAt,"asc"),this.collection.setDisplayOptions(Y.a.Theme,Qt.Title,"asc"),this.collection.setDisplayOptions(Y.a.SmartTag,Qt.Title,"asc"),this.notesView=new zn(this.collection)}setDisplayOptions(e,t,n,i){e===Y.a.Note&&console.warn("Called setDisplayOptions with ContentType.Note. setNotesDisplayOptions should be used instead."),this.collection.setDisplayOptions(e,t,n,i)}setNotesDisplayOptions(e,t,n,i){this.notesView.setDisplayOptions(e,t,n,i)}getDisplayableItems(e){return e===Y.a.Note?this.notesView.displayElements():this.collection.displayElements(e)}deinit(){this.unsubChangeObserver(),this.unsubChangeObserver=void 0,this.modelManager=void 0,this.collection=void 0,this.notesView=void 0}resetState(){this.createCollection()}findItem(e){return this.collection.find(e)}findItems(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.collection.findAll(e,t)}get items(){return this.collection.all()}get nonDeletedItems(){return this.collection.nondeletedElements()}get invalidItems(){return this.collection.invalidElements()}itemsKeys(){return this.collection.displayElements(Y.a.ItemsKey)}get notes(){return this.notesView.displayElements()}get tags(){return this.collection.displayElements(Y.a.Tag)}get components(){return this.collection.displayElements(Y.a.Component)}addObserver(e,t){Array.isArray(e)||(e=[e]);const n={contentType:e,callback:t};return this.observers.push(n),()=>{Object(c.C)(this.observers,n)}}itemsReferencingItem(e){if(!Object(c.t)(e))throw Error("Must use uuid string");const t=this.collection.uuidsThatReferenceUuid(e);return this.findItems(t)}referencesForItem(e){if(!Object(c.t)(e))throw Error("Must use uuid string");const t=this.findItem(e).references.map((e=>e.uuid));return this.findItems(t)}async setPayloads(e,t,n,i,r,s){const a=e.map((e=>we(e))),o=t.map((e=>we(e))),c=i.map((e=>we(e))),l=a.concat(o);l.length>0&&this.collection.set(l);const u=n.map((e=>we(e)));for(const e of u)this.collection.discard(e);this.notesView.setNeedsRebuilding(),await this.notifyObservers(a,o,u,c,r,s)}async notifyObservers(e,t,n,i,r,s){const a=(e,t)=>e.filter((e=>t.includes(Y.a.Any)||t.includes(e.content_type))),o=this.observers.slice();for(const c of o){const o=a(e,c.contentType),l=a(t,c.contentType),u=a(n,c.contentType),d=a(i,c.contentType);0===o.length&&0===l.length&&0===u.length&&0===d.length||c.callback(o,l,u,d,r,s)}}async changeItem(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U.c.UserInteraction,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ye.a.LocalChanged,r=arguments.length>4?arguments[4]:void 0;if(!Object(c.t)(e))throw Error("Invalid uuid for changeItem");return(await this.changeItems([e],t,n,i,r))[0]}createMutatorForItem(e,t){return e.content_type===Y.a.Note?new ge(e,t):e.content_type===Y.a.Tag?new de(e,t):e.content_type===Y.a.Component?new X(e,t):e.content_type===Y.a.ActionsExtension?new le(e,t):e.content_type===Y.a.ItemsKey?new me(e,t):e.content_type===Y.a.Privileges?new z(e,t):e.content_type===Y.a.UserPrefs?new H(e,t):e.content_type===Y.a.Theme?new ee(e,t):new U.b(e,t)}async changeItems(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U.c.UserInteraction,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ye.a.LocalChanged,r=arguments.length>4?arguments[4]:void 0;const s=this.findItems(e,!0),a=[];for(const e of s){if(!e)throw Error("Attempting to change non-existant item");const i=this.createMutatorForItem(e,n);t&&t(i);const r=i.getResult();a.push(r)}return await this.modelManager.emitPayloads(a,i,r),this.findItems(a.map((e=>e.uuid)))}async changeNote(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U.c.UserInteraction,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ye.a.LocalChanged,r=arguments.length>4?arguments[4]:void 0;const s=this.findItem(e);if(!s)throw Error("Attempting to change non-existant note");const a=new ge(s,n);return this.applyTransform(a,t,i,r)}async changeComponent(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U.c.UserInteraction,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ye.a.LocalChanged,r=arguments.length>4?arguments[4]:void 0;const s=this.findItem(e);if(!s)throw Error("Attempting to change non-existant component");const a=new X(s,n);return this.applyTransform(a,t,i,r)}async changeActionsExtension(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U.c.UserInteraction,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ye.a.LocalChanged,r=arguments.length>4?arguments[4]:void 0;const s=this.findItem(e);if(!s)throw Error("Attempting to change non-existant extension");const a=new le(s,n);return this.applyTransform(a,t,i,r)}async changeItemsKey(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:U.c.UserInteraction,i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:Ye.a.LocalChanged,r=arguments.length>4?arguments[4]:void 0;const s=this.findItem(e);if(!s)throw Error("Attempting to change non-existant itemsKey");const a=new me(s,n);return this.applyTransform(a,t,i,r)}async applyTransform(e,t){let n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:Ye.a.LocalChanged,i=arguments.length>3?arguments[3]:void 0;t(e);const r=e.getResult();return this.modelManager.emitPayload(r,n,i)}async setItemDirty(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Object(c.t)(e))throw Error("Must use uuid when setting item dirty");return(await this.setItemsDirty([e],t))[0]}async setItemsDirty(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!Object(c.t)(e[0]))throw Error("Must use uuid when setting item dirty");return this.changeItems(e,void 0,t?U.c.UserInteraction:U.c.Internal)}getDirtyItems(){return this.collection.dirtyElements().filter((e=>!e.errorDecrypting||e.deleted))}async insertItem(e){const t=e.payload;return await this.emitItemFromPayload(t)}async duplicateItem(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1],n=arguments.length>2?arguments[2]:void 0;const i=this.findItem(e),r=Object(Oe.e)(i),s=await ze(r,this.modelManager.getMasterCollection(),t,n);return await this.modelManager.emitPayloads(s,Ye.a.LocalChanged),this.findItem(s[0].uuid)}async createItem(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;if(!e)throw"Attempting to create item with no contentType";const r=Object(Oe.e)({uuid:await u.GenerateUuid(),content_type:e,content:t?Object(ft.a)(t):void 0,dirty:n},i);return await this.modelManager.emitPayload(r,Ye.a.Constructor),this.findItem(r.uuid)}async createTemplateItem(e,t){return we(Object(Oe.e)({uuid:await u.GenerateUuid(),content_type:e,content:Object(ft.a)(t||{})}))}async emitItemFromPayload(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ye.a.Constructor;return await this.modelManager.emitPayload(e,t),this.findItem(e.uuid)}async emitItemsFromPayloads(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:Ye.a.Constructor;await this.modelManager.emitPayloads(e,t);const n=Object(ft.b)(e);return this.findItems(n)}async setItemToBeDeleted(e,t){const n=this.collection.uuidsThatReferenceUuid(e),i=this.findItem(e),r=await this.changeItem(e,(e=>{e.setDeleted()}),void 0,t);for(const e of n){const t=this.findItem(e);t&&await this.changeItem(t.uuid,(e=>{e.removeItemAsRelationship(i)}))}return r}async setItemsToBeDeleted(e){const t=[];for(const n of e){const e=await this.setItemToBeDeleted(n);t.push(e)}return t}getItems(e){return this.collection.all(e)}nonErroredItemsForContentType(e){return this.collection.all(e).filter((e=>!e.errorDecrypting&&!e.waitingForKey))}itemsMatchingPredicate(e){return this.itemsMatchingPredicates([e])}itemsMatchingPredicates(e){return this.subItemsMatchingPredicates(this.items,e)}subItemsMatchingPredicates(e,t){return e.filter((e=>{if(e.deleted)return!1;for(const n of t)if(!e.satisfiesPredicate(n))return!1;return!0}))}findTagByTitle(e){return Object(c.E)(this.tags,{title:e})}async findOrCreateTagByTitle(e){return this.findTagByTitle(e)||await this.createItem(Y.a.Tag,Object(ft.a)({title:e}),!0)}notesMatchingSmartTag(e){return this.notesView.notesMatchingSmartTag(e,this.notesView.all())}get trashSmartTag(){return this.systemSmartTags.find((e=>e.isTrashTag))}get trashedItems(){return this.notesMatchingSmartTag(this.trashSmartTag)}async emptyTrash(){const e=this.trashedItems;return this.setItemsToBeDeleted(Object(ft.b)(e))}getSmartTags(){const e=this.collection.displayElements(Y.a.SmartTag);return this.systemSmartTags.concat(e)}get noteCount(){return this.collection.all(Y.a.Note).length}async removeAllItemsFromMemory(){const e=Object(ft.b)(this.items);await this.changeItems(e,(e=>{e.setDeleted()}),U.c.NonDirtying),this.resetState(),this.modelManager.resetState()}removeItemLocally(e){this.collection.discard(e),this.modelManager.removePayloadLocally(e.payload)}}const Qn="all-notes",Gn="archived-notes",Yn="trashed-notes";function $n(e,t){return e.sort(((e,n)=>{const i=new Date(n.updated_at).getTime()-new Date(e.updated_at).getTime();let r=0,s=0;return t&&(r=t.indexOf(e.content_type),s=t.indexOf(n.content_type),-1===r&&(r=t.length),-1===s&&(s=t.length)),r===s?i:r<s?-1:1}))}class Xn{constructor(e,t){this.inProgress=!1,this.completedUpload=0,this.totalUpload=0,this.downloaded=0,this.databaseLoadCurrent=0,this.databaseLoadTotal=0,this.databaseLoadDone=!1,this.syncing=!1,this.interval=e,this.receiver=t}deinit(){this.stopTimingMonitor()}setSyncInProgress(){this.inProgress=!0}setUploadStatus(e,t){this.completedUpload=e,this.totalUpload=t,this.receiver(Gt.a.StatusChanged)}setDownloadStatus(e){this.downloaded+=e,this.receiver(Gt.a.StatusChanged)}setDatabaseLoadStatus(e,t,n){this.databaseLoadCurrent=e,this.databaseLoadTotal=t,this.databaseLoadDone=n,n?this.receiver(Gt.a.LocalDataLoaded):this.receiver(Gt.a.LocalDataIncrementalLoad)}getStats(){return{uploadCompletionCount:this.completedUpload,uploadTotalCount:this.totalUpload,downloadCount:this.downloaded,localDataDone:this.databaseLoadDone,localDataCurrent:this.databaseLoadCurrent,localDataTotal:this.databaseLoadTotal}}setDidBegin(){this.syncing=!0,this.syncStart=new Date}setDidEnd(){this.syncing=!1,this.syncEnd=new Date}get syncInProgress(){return!0===this.syncing}get secondsSinceSyncStart(){return((new Date).getTime()-this.syncStart.getTime())/1e3}startTimingMonitor(){this.timingMonitor&&this.stopTimingMonitor(),this.timingMonitor=this.interval((()=>{this.secondsSinceSyncStart>5&&(this.receiver(Gt.a.SyncTakingTooLong),this.stopTimingMonitor())}),500)}stopTimingMonitor(){Object.prototype.hasOwnProperty.call(this.interval,"cancel")?this.interval.cancel(this.timingMonitor):clearInterval(this.timingMonitor),this.timingMonitor=null}hasError(){return!!this.error}setError(e){this.error=e}clearError(){this.error=null}reset(){this.downloaded=0,this.completedUpload=0,this.totalUpload=0,this.inProgress=!1,this.syncing=!1,this.error=null,this.stopTimingMonitor(),this.receiver(Gt.a.StatusChanged)}}class Zn{constructor(e,t){this.discordance=0,this.outOfSync=!1,this.receiver=e,this.maxDiscordance=t,this.reset()}isOutOfSync(){return this.outOfSync}reset(){this.lastPreSyncSave=void 0,this.lastSyncDate=void 0,this.discordance=0,this.outOfSync=!1}get needsSync(){return this.discordance>0&&this.discordance<this.maxDiscordance}getLastClientIntegrityHash(){return this.lastClientHash}clearIntegrityHashes(){this.lastClientHash=void 0,this.lastServerHash=void 0}async setIntegrityHashes(e,t){this.lastClientHash=e,this.lastServerHash=t,t&&0!==t.length&&e&&e!==t?(this.discordance++,this.discordance>=this.maxDiscordance&&!this.outOfSync&&(this.outOfSync=!0,this.receiver(Gt.a.EnterOutOfSync))):(this.outOfSync&&(this.outOfSync=!1,this.receiver(Gt.a.ExitOutOfSync)),this.discordance=0)}}class ei{constructor(e,t,n,i,r){this.apiService=e,this.protocolService=t,this.contentType=n,this.customEvent=i,this.limit=r,this.progress={retrievedPayloads:[]}}async run(){const e=await this.apiService.sync([],this.progress.lastSyncToken,this.progress.paginationToken,this.limit||500,!1,this.contentType,this.customEvent),t=e.retrieved_items.map((e=>Object(Oe.f)(e,Ye.a.RemoteRetrieved))),n=await this.protocolService.payloadsByDecryptingPayloads(t);return this.progress.retrievedPayloads=this.progress.retrievedPayloads.concat(n),this.progress.lastSyncToken=e.sync_token,this.progress.paginationToken=e.cursor_token,e.cursor_token?this.run():this.progress.retrievedPayloads}}class ti{constructor(e){this.collections=e,Object.freeze(this)}collectionForSource(e){return this.collections.find((t=>t.source===e))}}class ni{constructor(e,t,n,i){this.response=e,this.baseCollection=n,this.relatedCollectionSet=new ti([tt.WithPayloads(t,Ye.a.DecryptedTransient),tt.WithPayloads(i,Ye.a.SavedOrSaving)])}async collectionsByProcessingResponse(){const e=[],t=await this.collectionByProcessingPayloads(this.response.retrievedPayloads,Ye.a.RemoteRetrieved);t.all().length>0&&e.push(t);const n=await this.collectionByProcessingPayloads(this.response.savedPayloads,Ye.a.RemoteSaved);if(n.all().length>0&&e.push(n),this.response.uuidConflictPayloads.length>0){const t=await this.collectionByProcessingPayloads(this.response.uuidConflictPayloads,Ye.a.ConflictUuid);t.all().length>0&&e.push(t)}if(this.response.dataConflictPayloads.length>0){const t=await this.collectionByProcessingPayloads(this.response.dataConflictPayloads,Ye.a.ConflictData);t.all().length>0&&e.push(t)}return e}async collectionByProcessingPayloads(e,t){const n=tt.WithPayloads(e,t),i=new(function(e){return e===Ye.a.RemoteRetrieved?lt:e===Ye.a.RemoteSaved?ut:e===Ye.a.ConflictData||e===Ye.a.ConflictUuid?ct:void 0}(t))(this.baseCollection,n,this.relatedCollectionSet),r=(await i.resultingCollection()).all().map((e=>{const t=this.finalDirtyStateForPayload(e);return Object(Oe.b)(e,{dirty:t,dirtiedDate:t?new Date:void 0})}));return tt.WithPayloads(r,t)}finalDirtyStateForPayload(e){const t=this.baseCollection.find(e.uuid);let n;return n=t?!t.dirtiedDate||e.dirtiedDate&&e.dirtiedDate>t.dirtiedDate?e.dirty:t.dirtiedDate>t.lastSyncBegan:e.dirty,n}}class ii{constructor(e){this.rawResponse=e,this.savedPayloads=this.filterRawItemArray(e.saved_items).map((e=>Object(Oe.f)(e,Ye.a.RemoteSaved))),this.retrievedPayloads=this.filterRawItemArray(e.retrieved_items).map((e=>Object(Oe.f)(e,Ye.a.RemoteRetrieved))),this.dataConflictPayloads=this.filterRawItemArray(this.rawDataConflictItems).map((e=>Object(Oe.f)(e,Ye.a.ConflictData))),this.uuidConflictPayloads=this.filterRawItemArray(this.rawUuidConflictItems).map((e=>Object(Oe.f)(e,Ye.a.ConflictUuid))),this.deletedPayloads=this.allProcessedPayloads.filter((e=>e.discardable)),Object(c.h)(this)}filterRawItemArray(){return(arguments.length>0&&void 0!==arguments[0]?arguments[0]:[]).filter((e=>!!e.uuid))}get error(){return this.rawResponse.error}get status(){return this.rawResponse.status}get lastSyncToken(){return this.rawResponse[pt.LastSyncToken]}get paginationToken(){return this.rawResponse[pt.PaginationToken]}get integrityHash(){return this.rawResponse[pt.IntegrityResult]}get checkIntegrity(){return this.integrityHash&&!this.paginationToken}get numberOfItemsInvolved(){return this.allProcessedPayloads.length}get allProcessedPayloads(){return this.savedPayloads.concat(this.retrievedPayloads).concat(this.dataConflictPayloads).concat(this.uuidConflictPayloads)}get rawUuidConflictItems(){return this.rawConflictObjects.filter((e=>e.type===gt.UuidConflict)).map((e=>e.unsaved_item||e.item))}get rawDataConflictItems(){return this.rawConflictObjects.filter((e=>e.type===gt.ConflictingData)).map((e=>e.server_item||e.item))}get rawConflictObjects(){const e=this.rawResponse.conflicts||[],t=this.rawResponse.unsaved||[];return e.concat(t)}get hasError(){return!Object(c.q)(this.rawResponse.error)}}var ri,si,ai,oi;!function(e){e[e.Response=1]="Response",e[e.StatusChanged=2]="StatusChanged"}(ri||(ri={}));class ci{constructor(e,t,n,i,r,s){this.responses=[],this.payloads=e,this.lastSyncToken=n,this.paginationToken=i,this.checkIntegrity=r,this.apiService=s,this.receiver=t,this.pendingPayloads=e.slice()}get payloadsSavedOrSaving(){return Object(c.c)(this.payloads,this.pendingPayloads)}popPayloads(e){const t=this.pendingPayloads.slice(0,e);return Object(c.H)(this.pendingPayloads,t),t}async run(){await this.receiver(ri.StatusChanged,void 0,{completedUploadCount:this.totalUploadCount-this.pendingUploadCount,totalUploadCount:this.totalUploadCount});const e=this.popPayloads(this.upLimit),t=await this.apiService.sync(e,this.lastSyncToken,this.paginationToken,this.downLimit,this.checkIntegrity,void 0,void 0),n=new ii(t);if(this.responses.push(n),this.lastSyncToken=n.lastSyncToken,this.paginationToken=n.paginationToken,await this.receiver(ri.Response,n),!this.done)return this.run()}get done(){return 0===this.pendingPayloads.length&&!this.paginationToken}get pendingUploadCount(){return this.pendingPayloads.length}get totalUploadCount(){return this.payloads.length}get upLimit(){return 150}get downLimit(){return 150}get numberOfItemsInvolved(){let e=0;for(const t of this.responses)e+=t.numberOfItemsInvolved;return e}}class li{constructor(e,t){this.payloads=e,this.receiver=t}async run(){const e=this.payloads.map((e=>Object(Oe.f)(e,Ye.a.LocalSaved,{dirty:!1,lastSyncEnd:new Date}))),t=Object(c.a)(e),n=new ii({saved_items:t});await this.receiver(ri.Response,n)}}function ui(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function di(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?ui(Object(n),!0).forEach((function(t){hi(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):ui(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function hi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}!function(e){e[e.ResolveOnNext=1]="ResolveOnNext",e[e.ForceSpawnNew=2]="ForceSpawnNew"}(si||(si={})),function(e){e[e.Default=1]="Default",e[e.DownloadFirst=2]="DownloadFirst"}(ai||(ai={})),function(e){e[e.External=1]="External",e[e.SpawnQueue=2]="SpawnQueue",e[e.ResolveQueue=3]="ResolveQueue",e[e.MoreDirtyItems=4]="MoreDirtyItems",e[e.AfterDownloadFirst=5]="AfterDownloadFirst",e[e.IntegrityCheck=6]="IntegrityCheck",e[e.ResolveOutOfSync=7]="ResolveOutOfSync"}(oi||(oi={}));const pi=Object.freeze([Y.a.Mfa,Y.a.ServerExtension]);class yi extends l.a{constructor(e,t,n,i,r,s,a){super(),this.resolveQueue=[],this.spawnQueue=[],this.completedOnlineDownloadFirstSync=!1,this.majorChangeThreshold=15,this.maxDiscordance=5,this.locked=!1,this.databaseLoaded=!1,this.localLoadPriorty=[Y.a.ItemsKey,Y.a.UserPrefs,Y.a.Privileges,Y.a.Component,Y.a.Theme],this.itemManager=e,this.sessionManager=t,this.protocolService=n,this.modelManager=r,this.storageService=i,this.apiService=s,this.interval=a,this.initializeStatus(),this.initializeState()}async onNewDatabaseCreated(){await this.getLastSyncToken()&&await this.clearSyncPositionTokens()}deinit(){this.sessionManager=void 0,this.itemManager=void 0,this.protocolService=void 0,this.modelManager=void 0,this.storageService=void 0,this.apiService=void 0,this.interval=void 0,this.state.reset(),this.opStatus.reset(),this.state=void 0,this.opStatus=void 0,this.resolveQueue.length=0,this.spawnQueue.length=0,super.deinit()}initializeStatus(){this.opStatus=new Xn(this.interval,(e=>{this.notifyEvent(e)}))}initializeState(){this.state=new Zn((e=>{e===Gt.a.EnterOutOfSync?this.notifyEvent(Gt.a.EnterOutOfSync):e===Gt.a.ExitOutOfSync&&this.notifyEvent(Gt.a.ExitOutOfSync)}),this.maxDiscordance)}lockSyncing(){this.locked=!0}unlockSyncing(){this.locked=!1}isOutOfSync(){return this.state.isOutOfSync()}getLastSyncDate(){return this.state.lastSyncDate}getStatus(){return this.opStatus}resetSyncState(){this.state.reset()}isDatabaseLoaded(){return this.databaseLoaded}async getDatabasePayloads(){return this.storageService.getAllRawPayloads().catch((e=>{throw this.notifyEvent(Gt.a.DatabaseReadError,e),e}))}async loadDatabasePayloads(e){if(this.databaseLoaded)throw"Attempting to initialize already initialized local database.";if(0===e.length)return this.databaseLoaded=!0,void this.opStatus.setDatabaseLoadStatus(0,0,!0);const t=$n(e.map((e=>{try{return Object(Oe.e)(e)}catch(e){return void console.error("Creating payload failed",e)}})).filter((e=>!Object(c.q)(e))),this.localLoadPriorty),n=t.filter((e=>e.content_type===Y.a.ItemsKey));Object(c.H)(t,n);const i=await this.protocolService.payloadsByDecryptingPayloads(n);await this.modelManager.emitPayloads(i,Ye.a.LocalRetrieved);const r=t.length,s=Math.ceil(r/100);for(let e=0;e<s;e++){const n=100*e,i=t.slice(n,n+100),s=await this.protocolService.payloadsByDecryptingPayloads(i);await this.modelManager.emitPayloads(s,Ye.a.LocalRetrieved),this.notifyEvent(Gt.a.LocalDataIncrementalLoad),this.opStatus.setDatabaseLoadStatus(n,r,!1)}this.databaseLoaded=!0,this.opStatus.setDatabaseLoadStatus(0,0,!0)}async setLastSyncToken(e){return this.syncToken=e,this.storageService.setValue(r.LastSyncToken,e)}async setPaginationToken(e){return this.cursorToken=e,e?this.storageService.setValue(r.PaginationToken,e):this.storageService.removeValue(r.PaginationToken)}async getLastSyncToken(){return this.syncToken||(this.syncToken=await this.storageService.getValue(r.LastSyncToken)),this.syncToken}async getPaginationToken(){return this.cursorToken||(this.cursorToken=await this.storageService.getValue(r.PaginationToken)),this.cursorToken}async clearSyncPositionTokens(){this.syncToken=void 0,this.cursorToken=void 0,await this.storageService.removeValue(r.LastSyncToken),await this.storageService.removeValue(r.PaginationToken)}async itemsNeedingSync(){return this.itemManager.getDirtyItems()}async alternateUuidForItem(e){const t=this.itemManager.findItem(e),n=Object(Oe.e)(t),i=await Je(n,this.modelManager.getMasterCollection());return await this.modelManager.emitPayloads(i,Ye.a.LocalChanged),await this.persistPayloads(i),this.itemManager.findItem(i[0].uuid)}async markAllItemsAsNeedingSync(e){if(this.log("Marking all items as needing sync"),e){const e=this.itemManager.items.filter((e=>!e.errorDecrypting)).slice();for(const t of e)await this.alternateUuidForItem(t.uuid)}const t=this.itemManager.items.map((e=>Object(Oe.e)(e,{dirty:!0,dirtiedDate:new Date})));await this.modelManager.emitPayloads(t,Ye.a.LocalChanged),await this.persistPayloads(t)}async popPayloadsNeedingPreSyncSave(e){const t=this.state.lastPreSyncSave;if(!t)return e;const n=e.filter((e=>!e.dirtiedDate||e.dirtiedDate>t));return this.state.lastPreSyncSave=new Date,n}queueStrategyResolveOnNext(){return new Promise(((e,t)=>{this.resolveQueue.push({resolve:e,reject:t})}))}queueStrategyForceSpawnNew(e){return new Promise(((t,n)=>{this.spawnQueue.push({resolve:t,reject:n,options:e})}))}popSpawnQueue(){if(0===this.spawnQueue.length)return null;const e=this.spawnQueue[0];return Object(c.D)(this.spawnQueue,0),this.log("Syncing again from spawn queue"),this.sync(di({queueStrategy:si.ForceSpawnNew,source:oi.SpawnQueue},e.options)).then((()=>{e.resolve()})).catch((()=>{e.reject()}))}async payloadsByPreparingForServer(e){return this.protocolService.payloadsByEncryptingPayloads(e,(e=>pi.includes(e.content_type)?_e.b.SyncDecrypted:_e.b.Sync))}async downloadFirstSync(e,t){for(let n=0;n<5;n++){if(await this.sync(di({mode:ai.DownloadFirst,queueStrategy:si.ForceSpawnNew},t)).catch(console.error),this.completedOnlineDownloadFirstSync)return;await Object(c.F)(e)}console.error("Failed downloadFirstSync after ".concat(5," tries"))}async sync(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};if(this.locked)return void this.log("Sync Locked");const t=this.opStatus.syncInProgress,n=this.databaseLoaded,i=!(()=>this.syncLock)();i&&n&&!t&&(()=>{this.syncLock=!0})(),e.source||(e.source=oi.External);const r=await this.itemsNeedingSync(),s=r.filter((e=>e.neverSynced&&e.deleted));Object(c.H)(r,s);const a=r.map((e=>e.payloadRepresentation())),o=await this.popPayloadsNeedingPreSyncSave(a);await this.persistPayloads(o);const l=this.resolveQueue.slice(),u=Object(c.q)(e.queueStrategy)?si.ResolveOnNext:e.queueStrategy;if(t||!n||!i){if(this.log(i?t?"Attempting to sync while existing sync in progress.":"Attempting to sync before local database has loaded.":"Another function call has begun preparing for sync."),u===si.ResolveOnNext)return this.queueStrategyResolveOnNext();if(u===si.ForceSpawnNew)return this.queueStrategyForceSpawnNew({mode:e.mode,checkIntegrity:e.checkIntegrity,source:e.source});throw"Unhandled timing strategy ".concat(u)}this.opStatus.setDidBegin(),this.notifyEvent(Gt.a.SyncWillBegin),Object(c.H)(this.resolveQueue,l);const d=new Date;r.length>0&&await this.itemManager.changeItems(Object(ft.b)(r),(e=>{e.lastSyncBegan=d}),U.c.NonDirtying,Ye.a.PreSyncSave);const h=this.sessionManager.online(),p=(e=>h&&!this.completedOnlineDownloadFirstSync?ai.DownloadFirst:Object(c.q)(e)?ai.Default:e)(e.mode);let y,g=[];if(p===ai.Default){if(h&&!this.completedOnlineDownloadFirstSync)throw Error("Attempting to default mode sync without having completed initial.");g=h?await this.payloadsByPreparingForServer(a):a}else p===ai.DownloadFirst&&(g=[]);if(y=h?await this.syncOnlineOperation(g,e.checkIntegrity,e.source,p):await this.syncOfflineOperation(g,e.source,p),await y.run(),this.opStatus.setDidEnd(),(()=>{this.syncLock=!1})(),!this.opStatus.hasError()){if(this.opStatus.reset(),this.state.lastSyncDate=new Date,y instanceof ci&&y.numberOfItemsInvolved>=this.majorChangeThreshold&&this.notifyEvent(Gt.a.MajorDataChange),s.length>0&&await this.handleNeverSyncedDeleted(s),p!==ai.DownloadFirst&&await this.notifyEvent(Gt.a.FullSyncCompleted,{source:e.source}),p===ai.DownloadFirst)h&&(this.completedOnlineDownloadFirstSync=!0),await this.notifyEvent(Gt.a.DownloadFirstSyncCompleted),await this.sync({source:oi.AfterDownloadFirst,checkIntegrity:!0,awaitAll:e.awaitAll});else if(!this.popSpawnQueue()&&this.resolveQueue.length>0){this.log("Syncing again from resolve queue");const t=this.sync({source:oi.ResolveQueue,checkIntegrity:e.checkIntegrity});e.awaitAll&&await t}else if((await this.itemsNeedingSync()).length>0)await this.sync({source:oi.MoreDirtyItems,checkIntegrity:e.checkIntegrity,awaitAll:e.awaitAll});else if(y instanceof ci&&y.checkIntegrity){if(this.state.needsSync&&y.done){this.log("Syncing again from integrity check");const t=this.sync({checkIntegrity:!0,queueStrategy:si.ForceSpawnNew,source:oi.IntegrityCheck,awaitAll:e.awaitAll});e.awaitAll&&await t}}else this.state.clearIntegrityHashes();for(const e of l)e.resolve()}}async syncOnlineOperation(e,t,n,i){this.log("Syncing online user","source:",n,"integrity check",t,"mode:",i,"payloads:",e);const r=new ci(e,(async(e,t,n)=>{switch(e){case ri.Response:t.hasError?await this.handleErrorServerResponse(t):await this.handleSuccessServerResponse(r,t);break;case ri.StatusChanged:this.opStatus.setUploadStatus(n.completedUploadCount,n.totalUploadCount)}}),await this.getLastSyncToken(),await this.getPaginationToken(),t,this.apiService);return r}async syncOfflineOperation(e,t,n){return this.log("Syncing offline user","source:",t,"mode:",n,"payloads:",e),new li(e,(async(e,t)=>{e===ri.Response&&await this.handleOfflineResponse(t)}))}async handleOfflineResponse(e){this.log("Offline Sync Response",e.rawResponse);const t=e.savedPayloads;if(t.length>0){await this.modelManager.emitPayloads(t,Ye.a.LocalSaved);const e=this.modelManager.find(Object(ft.b)(t));await this.persistPayloads(e)}const n=e.deletedPayloads;n.length>0&&await this.deletePayloads(n),this.opStatus.clearError(),this.opStatus.setDownloadStatus(e.retrievedPayloads.length),await this.notifyEvent(Gt.a.SingleSyncCompleted,e)}async handleErrorServerResponse(e){this.log("Sync Error",e),401===e.status&&this.notifyEvent(Gt.a.InvalidSession),this.opStatus.setError(e.error),this.notifyEvent(Gt.a.SyncError,e.error)}async handleSuccessServerResponse(e,t){this._simulate_latency&&await Object(c.F)(this._simulate_latency.latency),this.log("Online Sync Response",t.rawResponse),this.setLastSyncToken(t.lastSyncToken),this.setPaginationToken(t.paginationToken),this.opStatus.clearError(),this.opStatus.setDownloadStatus(t.retrievedPayloads.length);const n=[];for(const e of t.allProcessedPayloads){if(e.deleted||!e.fields.includes(N.a.Content))continue;const t=await this.protocolService.payloadByDecryptingPayload(e);n.push(t)}const i=this.modelManager.getMasterCollection(),r=new ni(t,n,i,e.payloadsSavedOrSaving),s=await r.collectionsByProcessingResponse();for(const e of s){const t=await this.modelManager.emitCollection(e);await this.persistPayloads(t)}const a=t.deletedPayloads;if(a.length>0&&await this.deletePayloads(a),await this.notifyEvent(Gt.a.SingleSyncCompleted,t),t.checkIntegrity){const e=await this.computeDataIntegrityHash();await this.state.setIntegrityHashes(e,t.integrityHash)}}async handleNeverSyncedDeleted(e){const t=e.map((e=>e.payloadRepresentation({dirty:!1})));await this.modelManager.emitPayloads(t,Ye.a.LocalChanged),await this.persistPayloads(t)}async persistPayloads(e){if(0!==e.length)return this.storageService.savePayloads(e).catch((e=>{throw this.notifyEvent(Gt.a.DatabaseWriteError,e),e}))}async deletePayloads(e){return this.persistPayloads(e)}async computeDataIntegrityHash(){try{const e=this.itemManager.nonDeletedItems.sort(((e,t)=>t.updated_at.getTime()-e.updated_at.getTime())).map((e=>e.updatedAtTimestamp())).join(",");return this.protocolService.crypto.sha256(e)}catch(e){return void console.error("Error computing data integrity hash",e)}}async resolveOutOfSync(){const e=new ei(this.apiService,this.protocolService,void 0,"resolve-out-of-sync"),t=await e.run(),n=new ot(this.modelManager.getMasterCollection(),tt.WithPayloads(t,Ye.a.RemoteRetrieved)),i=await n.resultingCollection();return await this.modelManager.emitCollection(i),await this.persistPayloads(i.payloads),this.sync({checkIntegrity:!0,source:oi.ResolveOutOfSync})}async statelessDownloadAllItems(e,t){const n=new ei(this.apiService,this.protocolService,e,t);return(await n.run()).map((e=>we(e)))}ut_setDatabaseLoaded(e){this.databaseLoaded=e}ut_clearLastSyncDate(){this.state.lastSyncDate=void 0}ut_beginLatencySimulator(e){this._simulate_latency={latency:e||1e3,enabled:!0}}ut_endLatencySimulator(){this._simulate_latency=null}}class gi{constructor(e,t,n,i,r,s){this.challenge=e,this.onValidValue=t,this.onInvalidValue=n,this.onNonvalidatedSubmit=i,this.onComplete=r,this.onCancel=s,this.nonvalidatedValues=[],this.validValues=[],this.invalidValues=[],this.artifacts={}}complete(e){var t;e||(e=new Ve(this.challenge,this.validValues,this.artifacts)),null===(t=this.onComplete)||void 0===t||t.call(this,e)}nonvalidatedSubmit(){var e;const t=new Ve(this.challenge,this.nonvalidatedValues.slice(),this.artifacts);null===(e=this.onNonvalidatedSubmit)||void 0===e||e.call(this,t),this.nonvalidatedValues=[]}cancel(){var e;null===(e=this.onCancel)||void 0===e||e.call(this)}isFinished(){return this.validValues.length===this.challenge.prompts.length}nonvalidatedPrompts(){return this.challenge.prompts.filter((e=>!e.validates))}addNonvalidatedValue(e){const t=this.nonvalidatedValues,n=t.find((t=>t.prompt.id===e.prompt.id));n&&Object(c.C)(t,n),t.push(e),this.nonvalidatedValues.length===this.nonvalidatedPrompts().length&&this.nonvalidatedSubmit()}setValueStatus(e,t,n){const i=t?this.validValues:this.invalidValues,r=i.find((t=>t.prompt.validation===e.prompt.validation));var s,a;r&&Object(c.C)(i,r),i.push(e),Object.assign(this.artifacts,n),this.isFinished()?this.complete():t?null===(s=this.onValidValue)||void 0===s||s.call(this,e):null===(a=this.onInvalidValue)||void 0===a||a.call(this,e)}}class fi extends l.a{constructor(e,t){super(),this.storageService=e,this.protocolService=t,this.challengeOperations={},this.challengeObservers={}}deinit(){this.storageService=void 0,this.protocolService=void 0,this.sendChallenge=void 0,this.challengeOperations=void 0,this.challengeObservers=void 0,super.deinit()}promptForChallengeResponse(e){return new Promise((t=>{this.createOrGetChallengeOperation(e,t),this.sendChallenge(e)}))}validateChallengeValue(e){switch(e.prompt.validation){case Re.LocalPasscode:return this.protocolService.validatePasscode(e.value);case Re.AccountPassword:return this.protocolService.validateAccountPassword(e.value);case Re.Biometric:return Promise.resolve({valid:!0===e.value});default:throw Error("Unhandled validation mode ".concat(e.prompt.validation))}}async getLaunchChallenge(){const e=[];return this.protocolService.hasPasscode()&&e.push(new Fe(Re.LocalPasscode,void 0,x)),await this.hasBiometricsEnabled()&&e.push(new Fe(Re.Biometric)),e.length>0?new xe(e,ke.ApplicationUnlock,!1):null}async promptForPasscode(){const e=new xe([new Fe(Re.LocalPasscode)],ke.ResaveRootKey,!0),t=await this.promptForChallengeResponse(e);return t?{passcode:t.getValueForType(Re.LocalPasscode).value,canceled:!1}:{canceled:!0,passcode:void 0}}async getWrappingKeyIfApplicable(e){if(!this.protocolService.hasPasscode())return{};if(!e){const t=await this.promptForPasscode();if(t.canceled)return{canceled:!0};e=t.passcode}return{wrappingKey:await this.protocolService.computeWrappingKey(e)}}isPasscodeLocked(){return this.protocolService.rootKeyNeedsUnwrapping()}async hasBiometricsEnabled(){const e=await this.storageService.getValue(r.BiometricsState,Ae.Nonwrapped);return Boolean(e)}async enableBiometrics(){await this.storageService.setValue(r.BiometricsState,!0,Ae.Nonwrapped)}async disableBiometrics(){await this.storageService.setValue(r.BiometricsState,!1,Ae.Nonwrapped)}addChallengeObserver(e,t){const n=this.challengeObservers[e.id]||[];return n.push(t),this.challengeObservers[e.id]=n,()=>{Object(c.C)(n,t)}}createOrGetChallengeOperation(e,t){let n=this.getChallengeOperation(e);return n||(n=new gi(e,(t=>{this.onChallengeValidValue(e,t)}),(t=>{this.onChallengeInvalidValue(e,t)}),(n=>{this.onChallengeNonvalidatedSubmit(e,n),t(n)}),(n=>{this.onChallengeComplete(e,n),t(n)}),(()=>{this.onChallengeCancel(e),t(void 0)})),this.challengeOperations[e.id]=n),n}performOnObservers(e,t){const n=this.challengeObservers[e.id]||[];for(const e of n)t(e)}onChallengeValidValue(e,t){this.performOnObservers(e,(e=>{var n;null===(n=e.onValidValue)||void 0===n||n.call(e,t)}))}onChallengeInvalidValue(e,t){this.performOnObservers(e,(e=>{var n;null===(n=e.onInvalidValue)||void 0===n||n.call(e,t)}))}onChallengeNonvalidatedSubmit(e,t){this.performOnObservers(e,(e=>{var n;null===(n=e.onNonvalidatedSubmit)||void 0===n||n.call(e,t)}))}onChallengeComplete(e,t){this.performOnObservers(e,(e=>{var n;null===(n=e.onComplete)||void 0===n||n.call(e,t)}))}onChallengeCancel(e){this.performOnObservers(e,(e=>{var t;null===(t=e.onCancel)||void 0===t||t.call(e)}))}getChallengeOperation(e){return this.challengeOperations[e.id]}deleteChallengeOperation(e){delete this.challengeOperations[e.challenge.id]}cancelChallenge(e){const t=this.challengeOperations[e.id];t.cancel(),this.deleteChallengeOperation(t)}completeChallenge(e){const t=this.challengeOperations[e.id];t.complete(),this.deleteChallengeOperation(t)}async submitValuesForChallenge(e,t){if(0===t.length)throw Error("Attempting to submit 0 values for challenge");for(const n of t)if(n.prompt.validates){const{valid:t,artifacts:i}=await this.validateChallengeValue(n);this.setValidationStatusForChallenge(e,n,t,i)}else this.getChallengeOperation(e).addNonvalidatedValue(n)}setValidationStatusForChallenge(e,t,n,i){const r=this.getChallengeOperation(e);r.setValueStatus(t,n,i),r.isFinished()&&(this.deleteChallengeOperation(r),delete this.challengeObservers[r.challenge.id])}}function mi(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function vi(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?mi(Object(n),!0).forEach((function(t){wi(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):mi(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function wi(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}class Si{constructor(e,t,n,i,r,s,a,o,c){if(this.eventHandlers=[],this.services=[],this.streamRemovers=[],this.serviceObservers=[],this.managedSubscribers=[],this.createdNewDatabase=!1,this.started=!1,this.launched=!1,this.dealloced=!1,!vn.onLog)throw Error("SNLog.onLog must be set.");if(!vn.onError)throw Error("SNLog.onError must be set.");if(!n)throw Error("Device Interface must be supplied.");if(!e)throw Error("Environment must be supplied when creating an application.");if(!t)throw Error("Platform must be supplied when creating an application.");if(!i)throw Error("Crypto has to be supplied when creating an application.");if(!r)throw Error("AlertService must be supplied when creating an application.");this.environment=e,this.platform=t,this.identifier=s,this.deviceInterface=n,this.crypto=i,this.alertService=r,this.swapClasses=a,this.skipClasses=o,this.defaultHost=c,this.constructServices()}async prepareForLaunch(e){this.setLaunchCallback(e);const t=await this.deviceInterface.openDatabase(this.identifier).catch((e=>{this.notifyEvent(mt.a.LocalDatabaseReadError,e)}));this.createdNewDatabase=(null==t?void 0:t.isNewDatabase)||!1,await this.migrationService.initialize(),await this.notifyEvent(mt.a.MigrationsLoaded),await this.handleStage(Se.PreparingForLaunch_0),await this.storageService.initializeFromDisk(),await this.notifyEvent(mt.a.StorageReady),await this.protocolService.initialize(),await this.handleStage(Se.ReadyForLaunch_05),this.started=!0,await this.notifyEvent(mt.a.Started)}setLaunchCallback(e){this.challengeService.sendChallenge=e.receiveChallenge}async launch(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.launched=!1;const t=await this.challengeService.getLaunchChallenge();if(t){const e=await this.challengeService.promptForChallengeResponse(t);if(!e)throw Error("Launch challenge was cancelled.");await this.handleLaunchChallengeResponse(e)}this.storageService.isStorageWrapped()&&await this.storageService.decryptStorage(),await this.handleStage(Se.StorageDecrypted_09),await this.apiService.loadHost(),await this.sessionManager.initializeFromDisk(),this.historyManager.initializeFromDisk(),this.launched=!0,await this.notifyEvent(mt.a.Launched),await this.handleStage(Se.Launched_10);const n=await this.syncService.getDatabasePayloads();await this.handleStage(Se.LoadingDatabase_11),this.createdNewDatabase&&await this.syncService.onNewDatabaseCreated();const i=this.syncService.loadDatabasePayloads(n).then((async()=>{if(this.dealloced)throw"Application has been destroyed.";return await this.handleStage(Se.LoadedDatabase_12),this.beginAutoSyncTimer(),this.syncService.sync({mode:ai.DownloadFirst})}));e&&await i}onStart(){}onLaunch(){}async handleLaunchChallengeResponse(e){if(e.challenge.hasPromptForValidationType(Re.LocalPasscode)){let t=e.artifacts.wrappingKey;if(!t){const n=e.getValueForType(Re.LocalPasscode);t=await this.protocolService.computeWrappingKey(n.value)}await this.protocolService.unwrapRootKey(t)}}beginAutoSyncTimer(){this.autoSyncInterval=this.deviceInterface.interval((()=>{this.syncService.log("Syncing from autosync"),this.sync()}),3e4)}async handleStage(e){for(const t of this.services)await t.handleApplicationStage(e)}addEventObserver(e,t){const n={callback:e,singleEvent:t};return this.eventHandlers.push(n),()=>{Object(c.C)(this.eventHandlers,n)}}addSingleEventObserver(e,t){return this.addEventObserver((async n=>{n===e&&t(e)}),e)}async notifyEvent(e,t){e===mt.a.Started?this.onStart():e===mt.a.Launched&&this.onLaunch();for(const n of this.eventHandlers.slice())n.singleEvent&&n.singleEvent===e?await n.callback(e,t||{}):n.singleEvent||await n.callback(e,t||{});this.migrationService.handleApplicationEvent(e)}isDatabaseLoaded(){return this.syncService.isDatabaseLoaded()}async savePayload(e){const t=Object(Oe.b)(e,{dirty:!0,dirtiedDate:new Date});await this.modelManager.emitPayload(t,Ye.a.LocalChanged),await this.syncService.sync()}findItem(e){return this.itemManager.findItem(e)}allItems(){return this.itemManager.items}findItems(e){return this.itemManager.itemsMatchingPredicate(e)}getAll(e){return this.itemManager.findItems(e)}async mergeItem(e,t){return this.itemManager.emitItemFromPayload(e.payloadRepresentation(),t)}async createManagedItem(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0;return await this.itemManager.createItem(e,t,n,i)}async createTemplateItem(e,t){return await this.itemManager.createTemplateItem(e,t)}createItemFromPayload(e){return we(e)}createPayloadFromObject(e){return Object(Oe.e)(e)}getLastSyncDate(){return this.syncService.getLastSyncDate()}getSyncStatus(){return this.syncService.getStatus()}async setItemNeedsSync(e){let t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];return this.itemManager.setItemDirty(e.uuid,t)}async setItemsNeedsSync(e){return this.itemManager.setItemsDirty(Object(ft.b)(e))}async deleteItem(e){return await this.itemManager.setItemToBeDeleted(e.uuid),this.sync()}async deleteItemLocally(e){this.itemManager.removeItemLocally(e)}async emptyTrash(){return await this.itemManager.emptyTrash(),this.sync()}getTrashedItems(){return this.itemManager.trashedItems}setDisplayOptions(e,t,n,i){this.itemManager.setDisplayOptions(e,t,n,i)}setNotesDisplayOptions(e,t,n,i){this.itemManager.setNotesDisplayOptions(e,t,n,i)}getDisplayableItems(e){return this.itemManager.getDisplayableItems(e)}async insertItem(e){const t=await this.itemManager.insertItem(e);return await this.itemManager.changeItems([t.uuid]),this.findItem(e.uuid)}async saveItem(e){const t=this.itemManager.findItem(e);if(!t)throw Error("Attempting to save non-inserted item");t.dirty||await this.itemManager.changeItem(e),await this.syncService.sync()}async changeAndSaveItem(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;if(!Object(c.t)(e))throw Error("Must use uuid to change item");return await this.itemManager.changeItems([e],t,n?U.c.UserInteraction:void 0,i),await this.syncService.sync(r),this.findItem(e)}async changeAndSaveItems(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3?arguments[3]:void 0,r=arguments.length>4?arguments[4]:void 0;await this.itemManager.changeItems(e,t,n?U.c.UserInteraction:void 0,i),await this.syncService.sync(r)}async changeItem(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(!Object(c.t)(e))throw Error("Must use uuid to change item");return await this.itemManager.changeItems([e],t,n?U.c.UserInteraction:void 0),this.findItem(e)}async changeItems(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.itemManager.changeItems(e,t,n?U.c.UserInteraction:void 0)}getItems(e){return this.itemManager.getItems(e)}notesMatchingSmartTag(e){return this.itemManager.notesMatchingSmartTag(e)}referencesForItem(e,t){let n=this.itemManager.referencesForItem(e.uuid);return t&&(n=n.filter((e=>(null==e?void 0:e.content_type)===t))),n}referencingForItem(e,t){let n=this.itemManager.itemsReferencingItem(e.uuid);return t&&(n=n.filter((e=>(null==e?void 0:e.content_type)===t))),n}duplicateItem(e,t){const n=this.itemManager.duplicateItem(e.uuid,!1,t);return this.sync(),n}findTagByTitle(e){return this.itemManager.findTagByTitle(e)}async findOrCreateTag(e){return this.itemManager.findOrCreateTagByTitle(e)}getSmartTags(){return this.itemManager.getSmartTags()}getNoteCount(){return this.itemManager.noteCount}streamItems(e,t){const n=this.itemManager.addObserver(e,((e,n,i,r,s)=>{const a=e.concat(n).concat(i);t(a,s)})),i=this.itemManager.getItems(e);return i.length>0&&t(i),this.streamRemovers.push(n),()=>{n(),Object(c.C)(this.streamRemovers,n)}}async toggleComponent(e){return await this.componentManager.toggleComponent(e),this.syncService.sync()}async setHost(e){return this.apiService.setHost(e)}async getHost(){return this.apiService.getHost()}getUser(){if(!this.launched)throw"Attempting to access user before application unlocked";return this.sessionManager.getUser()}async getProtocolEncryptionDisplayName(){return this.protocolService.getEncryptionDisplayName()}getUserVersion(){return this.protocolService.getUserVersion()}async protocolUpgradeAvailable(){return this.protocolService.upgradeAvailable()}isEncryptionAvailable(){return this.hasAccount()||this.hasPasscode()}async performProtocolUpgrade(){const e=this.hasPasscode(),t=this.hasAccount(),n=[];e&&n.push(new Fe(Re.LocalPasscode,void 0,x)),t&&n.push(new Fe(Re.AccountPassword,void 0,"Account Password"));const i=new xe(n,ke.ProtocolUpgrade,!0),r=await this.challengeService.promptForChallengeResponse(i);if(!r)return{canceled:!0};const s=await this.alertService.blockingDialog(D,"Upgrading your account's encryption version");try{let n;if(e&&(n=r.getValueForType(Re.LocalPasscode).value),t){const e=r.getValueForType(Re.AccountPassword).value,t=await this.changePassword(e,e,n,h.ProtocolUpgrade,{validatePasswordStrength:!1});if(null==t?void 0:t.error)return{error:t.error}}return e&&await this.changePasscode(n,h.ProtocolUpgrade),{success:!0}}catch(e){return{error:e}}finally{s()}}async upgradeProtocolVersion(){const e=await this.performProtocolUpgrade();return e.success?this.hasAccount()?this.alertService.alert("Your encryption version has been successfully upgraded. You may be asked to enter your credentials again on other devices you're signed into."):this.alertService.alert("Your encryption version has been successfully upgraded."):e.error&&this.alertService.alert("Unable to upgrade encryption version. Please try again."),e}noAccount(){return!this.hasAccount()}hasAccount(){return this.protocolService.hasAccount()}async importData(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];if(e.version){const t=e.version;if(!this.protocolService.supportedVersions().includes(t))return{error:"This backup file was created using a newer version of the application and cannot be imported here. Please update your application and try again."};const n=await this.getUserVersion();if(n&&1===Object(p.b)(t,n))return{error:"This backup file was created using a newer encryption version than your account's. Please run the available encryption upgrade and try again."}}const i=await this.protocolService.payloadsByDecryptingBackupFile(e,t),r=i.filter((e=>!e.errorDecrypting)).map((e=>e.content_type===Y.a.Component&&e.safeContent.active?Object(Oe.b)(e,{content:vi(vi({},e.safeContent),{},{active:!1})}):e)),s=await this.modelManager.importPayloads(r),a=this.sync();return n&&await a,{affectedItems:this.getAll(s),errorCount:i.length-r.length}}async createBackupFile(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2];return this.protocolService.createBackupFile(e,t,n)}isEphemeralSession(){return this.storageService.isEphemeralSession()}lockSyncing(){this.syncService.lockSyncing()}unlockSyncing(){this.syncService.unlockSyncing()}async sync(e){return this.syncService.sync(e)}async isOutOfSync(){return this.syncService.isOutOfSync()}async resolveOutOfSync(){return this.syncService.resolveOutOfSync()}async setValue(e,t,n){return this.storageService.setValue(e,t,n)}async getValue(e,t){return this.storageService.getValue(e,t)}async removeValue(e,t){return this.storageService.removeValue(e,t)}async clearDatabase(){return this.storageService.clearAllPayloads()}async rewriteItemsKeys(){const e=this.itemManager.itemsKeys().map((e=>e.payloadRepresentation()));await this.storageService.deletePayloads(e),await this.syncService.persistPayloads(e)}async prepareForDeinit(){let e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;const t=Promise.all(this.services.map((e=>e.blockDeinit())));0===e?await t:await Promise.race([t,Object(c.F)(e)])}promptForCustomChallenge(e){var t;return null===(t=this.challengeService)||void 0===t?void 0:t.promptForChallengeResponse(e)}addChallengeObserver(e,t){return this.challengeService.addChallengeObserver(e,t)}submitValuesForChallenge(e,t){return this.challengeService.submitValuesForChallenge(e,t)}cancelChallenge(e){this.challengeService.cancelChallenge(e)}setOnDeinit(e){this.onDeinit=e}deinit(e){clearInterval(this.autoSyncInterval);for(const e of this.serviceObservers)e();for(const e of this.managedSubscribers)e();for(const e of this.services)e.deinit();this.onDeinit&&this.onDeinit(this,e),this.onDeinit=void 0,this.crypto=void 0,this.createdNewDatabase=!1,this.services.length=0,this.serviceObservers.length=0,this.managedSubscribers.length=0,this.streamRemovers.length=0,this.clearServices(),this.dealloced=!0,this.started=!1}async register(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=!(arguments.length>3&&void 0!==arguments[3])||arguments[3];this.lockSyncing();const r=await this.sessionManager.register(e,t);return r.response.error?this.unlockSyncing():(this.syncService.resetSyncState(),await this.storageService.setPersistencePolicy(n?Me.Ephemeral:Me.Default),i?await this.syncService.markAllItemsAsNeedingSync(!0):(this.itemManager.removeAllItemsFromMemory(),await this.clearDatabase()),await this.notifyEvent(mt.a.SignedIn),this.unlockSyncing(),await this.syncService.downloadFirstSync(300),this.protocolService.decryptErroredItems()),r.response}async signIn(e,t){let n=arguments.length>2&&void 0!==arguments[2]&&arguments[2],i=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],s=arguments.length>5&&void 0!==arguments[5]&&arguments[5];this.lockSyncing();const a=await this.sessionManager.signIn(e,t,n);if(a.response.error)this.unlockSyncing();else{this.syncService.resetSyncState(),await this.storageService.setPersistencePolicy(i?Me.Ephemeral:Me.Default),r?await this.syncService.markAllItemsAsNeedingSync(!0):(this.itemManager.removeAllItemsFromMemory(),await this.clearDatabase()),await this.notifyEvent(mt.a.SignedIn),this.unlockSyncing();const e=this.syncService.downloadFirstSync(1e3,{checkIntegrity:!0,awaitAll:s});s?(await e,await this.protocolService.decryptErroredItems()):this.protocolService.decryptErroredItems()}return a.response}async changePassword(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:h.PasswordChange,{validatePasswordStrength:r=!0}=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const s=await this.performPasswordChange(e,t,n,i,{validatePasswordStrength:r});return s.error&&this.alertService.alert(s.error.message),s}async performPasswordChange(e,t,n){let i=arguments.length>3&&void 0!==arguments[3]?arguments[3]:h.PasswordChange,{validatePasswordStrength:r=!0}=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{};const{wrappingKey:s,canceled:a}=await this.challengeService.getWrappingKeyIfApplicable(n);if(a)return{error:Error("Your passcode is required to process your password change.")};if(r&&t.length<8)return{error:Error(C(8))};if(!(await this.protocolService.validateAccountPassword(e)).valid)return{error:Error("Invalid password.")};const o=await this.protocolService.computeRootKey(e,await this.protocolService.getRootKeyParams()),c=await this.protocolService.createRootKey(this.getUser().email,t,i);this.lockSyncing();const l=await this.sessionManager.changePassword(o.serverPassword,c,s);if(this.unlockSyncing(),!l.response.error){const e=await this.protocolService.createNewItemsKeyWithRollback();if(await this.protocolService.reencryptItemsKeys(),await this.syncService.sync({awaitAll:!0}),!(this.protocolService.getDefaultItemsKey().updated_at.getTime()>0))return await this.sessionManager.changePassword(c.serverPassword,o,s),await this.protocolService.reencryptItemsKeys(),await e(),await this.syncService.sync({awaitAll:!0}),{error:Error("Unable to change your password due to a sync error. Please try again.")}}return l.response}async signOut(){await this.sessionManager.signOut(),await this.protocolService.clearLocalKeyState(),await this.storageService.clearAllData(),await this.notifyEvent(mt.a.SignedOut),await this.prepareForDeinit(),this.deinit(o.SignOut)}async validateAccountPassword(e){const{valid:t}=await this.protocolService.validateAccountPassword(e);return t}isStarted(){return this.started}isLaunched(){return this.launched}async hasBiometrics(){return this.challengeService.hasBiometricsEnabled()}async enableBiometrics(){return this.challengeService.enableBiometrics()}async disableBiometrics(){return this.challengeService.disableBiometrics()}hasPasscode(){return this.protocolService.hasPasscode()}async isLocked(){return!this.started||this.challengeService.isPasscodeLocked()}async lock(){return await this.prepareForDeinit(500),this.deinit(o.Lock)}async setPasscode(e){const t=await this.alertService.blockingDialog(D,"Setting passcode");try{await this.setPasscodeWithoutWarning(e,h.PasscodeCreate)}finally{t()}}async removePasscode(){const e=await this.alertService.blockingDialog(D,"Removing passcode");try{await this.removePasscodeWithoutWarning()}finally{e()}}async changePasscode(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:h.PasscodeChange;const n=await this.alertService.blockingDialog(D,t===h.ProtocolUpgrade?"Upgrading local encryption...":"Changing passcode");try{await this.removePasscodeWithoutWarning(),await this.setPasscodeWithoutWarning(e,h.PasscodeChange)}finally{n()}}async setPasscodeWithoutWarning(e,t){const n=await this.generateUuid(),i=await this.protocolService.createRootKey(n,e,t);await this.protocolService.setNewRootKeyWrapper(i),await this.rewriteItemsKeys(),await this.syncService.sync()}async removePasscodeWithoutWarning(){await this.protocolService.removeRootKeyWrapper(),await this.rewriteItemsKeys()}getStorageEncryptionPolicy(){return this.storageService.getStorageEncryptionPolicy()}async setStorageEncryptionPolicy(e){return await this.storageService.setEncryptionPolicy(e),this.protocolService.repersistAllItems()}enableEphemeralPersistencePolicy(){return this.storageService.setPersistencePolicy(Me.Ephemeral)}hasPendingMigrations(){return this.migrationService.hasPendingMigrations()}generateUuid(){return u.GenerateUuid()}presentKeyRecoveryWizard(){return this.keyRecoveryService.processPersistedUndecryptables()}async changeDeviceInterface(e){this.deviceInterface=e;for(const t of this.services)t.deviceInterface&&(t.deviceInterface=e)}constructServices(){this.createModelManager(),this.createItemManager(),this.createStorageManager(),this.createProtocolService();const e={payloadByEncryptingPayload:this.protocolService.payloadByEncryptingPayload.bind(this.protocolService),payloadByDecryptingPayload:this.protocolService.payloadByDecryptingPayload.bind(this.protocolService)};this.storageService.encryptionDelegate=e,this.createChallengeService(),this.createMigrationService(),this.createHttpManager(),this.createApiService(),this.createSessionManager(),this.createSyncManager(),this.createKeyRecoveryService(),this.createSingletonManager(),this.createComponentManager(),this.createPrivilegesService(),this.createHistoryManager(),this.createActionsManager()}clearServices(){this.migrationService=void 0,this.alertService=void 0,this.httpService=void 0,this.modelManager=void 0,this.protocolService=void 0,this.storageService=void 0,this.apiService=void 0,this.sessionManager=void 0,this.syncService=void 0,this.challengeService=void 0,this.singletonManager=void 0,this.componentManager=void 0,this.privilegesService=void 0,this.actionsManager=void 0,this.historyManager=void 0,this.itemManager=void 0,this.keyRecoveryService=void 0,this.services=[]}createMigrationService(){this.migrationService=new dn({protocolService:this.protocolService,deviceInterface:this.deviceInterface,storageService:this.storageService,challengeService:this.challengeService,itemManager:this.itemManager,environment:this.environment,identifier:this.identifier}),this.services.push(this.migrationService)}createApiService(){this.apiService=new Tt(this.httpService,this.storageService,this.defaultHost),this.services.push(this.apiService)}createItemManager(){this.itemManager=new Jn(this.modelManager),this.services.push(this.itemManager)}createComponentManager(){if(this.shouldSkipClass(zt))return;const e=this.getClass(zt);this.componentManager=new e(this.itemManager,this.syncService,this.alertService,this.environment,this.platform,this.deviceInterface.timeout),this.services.push(this.componentManager)}createHttpManager(){this.httpService=new Rt,this.services.push(this.httpService)}createModelManager(){this.modelManager=new Jt,this.services.push(this.modelManager)}createSingletonManager(){this.singletonManager=new Yt(this.itemManager,this.syncService),this.services.push(this.singletonManager)}createStorageManager(){this.storageService=new Te(this.deviceInterface,this.identifier,this.environment),this.services.push(this.storageService)}createProtocolService(){this.protocolService=new kn(this.itemManager,this.modelManager,this.deviceInterface,this.storageService,this.identifier,this.crypto),this.protocolService.onKeyStatusChange((async()=>{await this.notifyEvent(mt.a.KeyStatusChanged)})),this.services.push(this.protocolService)}createKeyRecoveryService(){this.keyRecoveryService=new dt(this.itemManager,this.modelManager,this.apiService,this.sessionManager,this.protocolService,this.challengeService,this.alertService,this.storageService,this.syncService),this.services.push(this.keyRecoveryService)}createSessionManager(){this.sessionManager=new Et(this.storageService,this.apiService,this.alertService,this.protocolService,this.challengeService),this.serviceObservers.push(this.sessionManager.addEventObserver((async e=>{e===jt.SessionRestored&&this.sync()}))),this.services.push(this.sessionManager)}createSyncManager(){this.syncService=new yi(this.itemManager,this.sessionManager,this.protocolService,this.storageService,this.modelManager,this.apiService,this.deviceInterface.interval);const e=this.syncService.addEventObserver((async e=>{const t=Object(mt.c)(e);t&&await this.notifyEvent(t),await this.protocolService.onSyncEvent(e)}));this.serviceObservers.push(e),this.services.push(this.syncService)}createChallengeService(){this.challengeService=new fi(this.storageService,this.protocolService),this.services.push(this.challengeService)}createPrivilegesService(){this.privilegesService=new Wn(this.itemManager,this.syncService,this.singletonManager,this.protocolService,this.storageService,this.sessionManager),this.services.push(this.privilegesService)}createHistoryManager(){this.historyManager=new Ln(this.itemManager,this.storageService,this.apiService,this.protocolService,[Y.a.Note],this.deviceInterface.timeout),this.services.push(this.historyManager)}createActionsManager(){this.actionsManager=new en(this.itemManager,this.alertService,this.deviceInterface,this.httpService,this.modelManager,this.protocolService,this.syncService),this.services.push(this.actionsManager)}shouldSkipClass(e){return this.skipClasses&&this.skipClasses.includes(e)}getClass(e){const t=this.swapClasses&&this.swapClasses.find((t=>t.swap===e));return t?t.with:e}}class bi{constructor(e,t){this.timeout=e||setTimeout.bind(Object(c.n)()),this.interval=t||setInterval.bind(Object(c.n)())}deinit(){this.timeout=null,this.interval=null}async getJsonParsedRawStorageValue(e){const t=await this.getRawStorageValue(e);if(t)try{return JSON.parse(t)}catch(e){return t}}}class Pi{constructor(e,t,n){this.item=t.findItem(e),n&&n(this.item),this.removeObserver=t.streamItems(this.item.content_type,(async t=>{const i=t.find((t=>t.uuid===e));i&&(this.item=i,n&&n(this.item))}))}deinit(){this.removeObserver(),this.removeObserver=void 0}}var Oi=n(77)}])},e.exports=t()}},t={};function n(i){if(t[i])return t[i].exports;var r=t[i]={id:i,loaded:!1,exports:{}};return e[i](r,r.exports,n),r.loaded=!0,r.exports}n.hmd=e=>((e=Object.create(e)).children||(e.children=[]),Object.defineProperty(e,"exports",{enumerable:!0,set:()=>{throw new Error("ES Modules may not assign module.exports or exports.*, Use ESM export syntax, instead: "+e.id)}}),e),n(297)})();
//# sourceMappingURL=dist.js.map